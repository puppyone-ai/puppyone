[build]
builder = "NIXPACKS"

[deploy]
# One repo, multiple Railway services:
# - API service: SERVICE_ROLE=api (default)
# - ETL Worker (file processing): SERVICE_ROLE=etl_worker (or SERVICE_ROLE=worker for backward compatibility)
# - Import Worker (SaaS sync): SERVICE_ROLE=import_worker
# - MCP Server (AI Agent protocol): SERVICE_ROLE=mcp_server
#
# Environment variables:
# - SERVICE_ROLE: api | etl_worker | import_worker | mcp_server | worker (legacy)
startCommand = "sh -c 'case \"${SERVICE_ROLE:-api}\" in etl_worker|worker) arq src.etl.jobs.worker.WorkerSettings ;; import_worker) arq src.import_.jobs.worker.WorkerSettings ;; mcp_server) uvicorn mcp_service.server:app --host 0.0.0.0 --port ${PORT} --no-access-log ;; *) uvicorn src.main:app --host 0.0.0.0 --port ${PORT} --no-access-log ;; esac'"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[phases.setup]
nixPkgs = ["python312"]

[phases.build]
cmds = ["pip install --upgrade pip && pip install -e ."]
