[build]
builder = "NIXPACKS"

[deploy]
# One repo, multiple Railway services:
# - API service: SERVICE_ROLE=api (default)
# - File Worker (file processing): SERVICE_ROLE=file_worker
# - SaaS Worker (SaaS sync): SERVICE_ROLE=saas_worker
# - MCP Server (AI Agent protocol): SERVICE_ROLE=mcp_server
#
# Environment variables:
# - SERVICE_ROLE: api | file_worker | saas_worker | mcp_server
startCommand = "sh -c 'case \"${SERVICE_ROLE:-api}\" in file_worker) arq src.ingest.file.jobs.worker.WorkerSettings ;; saas_worker) arq src.ingest.saas.jobs.worker.WorkerSettings ;; mcp_server) uvicorn mcp_service.server:app --host 0.0.0.0 --port ${PORT} --no-access-log ;; *) uvicorn src.main:app --host 0.0.0.0 --port ${PORT} --no-access-log ;; esac'"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[phases.setup]
nixPkgs = ["python312"]

[phases.build]
cmds = ["pip install --upgrade pip && pip install -e ."]
