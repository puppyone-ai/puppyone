<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Proxy Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <h1>ğŸ”’ Server API Proxy Test Suite</h1>
    <p>è¿™ä¸ªé¡µé¢å¸®åŠ©æµ‹è¯•æˆ‘ä»¬æ–°å®ç°çš„Server APIä»£ç†çš„å®‰å…¨æ€§å’ŒåŠŸèƒ½æ€§ã€‚</p>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•å‰æ£€æŸ¥</h2>
        <button onclick="checkCookies()">æ£€æŸ¥è®¤è¯ Cookie</button>
        <button onclick="checkProxyEndpoint()">æ£€æŸ¥ä»£ç†ç«¯ç‚¹</button>
        <div id="precheck-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ” è®¤è¯å®‰å…¨æµ‹è¯•</h2>
        <button onclick="testWithoutAuth()">æµ‹è¯•æ— è®¤è¯è¯·æ±‚</button>
        <button onclick="testWithAuth()">æµ‹è¯•æœ‰è®¤è¯è¯·æ±‚</button>
        <div id="auth-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“¡ API åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testDeployments()">è·å–éƒ¨ç½²åˆ—è¡¨</button>
        <button onclick="testCreateAPI()">åˆ›å»º API æœåŠ¡</button>
        <button onclick="testCreateChatbot()">åˆ›å»º Chatbot</button>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ›¡ï¸ å®‰å…¨éªŒè¯</h2>
        <button onclick="checkNetworkSecurity()">æ£€æŸ¥ç½‘ç»œå®‰å…¨</button>
        <button onclick="checkHeaderSafety()">æ£€æŸ¥è¯·æ±‚å¤´å®‰å…¨</button>
        <div id="security-results"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
        }

        function logJSON(elementId, data, title = 'Response') {
            const element = document.getElementById(elementId);
            element.innerHTML += `<pre><strong>${title}:</strong>\n${JSON.stringify(data, null, 2)}</pre>`;
        }

        async function checkCookies() {
            log('precheck-results', 'æ£€æŸ¥è®¤è¯ cookies...', 'info');
            const cookies = document.cookie;
            
            if (cookies.includes('access_token')) {
                log('precheck-results', 'âœ… æ‰¾åˆ° access_token cookie', 'success');
            } else {
                log('precheck-results', 'âš ï¸ æœªæ‰¾åˆ° access_token cookie - æŸäº›æµ‹è¯•å¯èƒ½å¤±è´¥', 'error');
            }
            
            log('precheck-results', `Cookies: ${cookies || '(æ— cookie)'}`, 'info');
        }

        async function checkProxyEndpoint() {
            log('precheck-results', 'æ£€æŸ¥ä»£ç†ç«¯ç‚¹...', 'info');
            
            try {
                const response = await fetch('/api/server/health', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.status === 404) {
                    log('precheck-results', 'âœ… ä»£ç†ç«¯ç‚¹å­˜åœ¨ (404æ˜¯é¢„æœŸçš„ï¼Œå› ä¸ºåç«¯å¯èƒ½æ²¡æœ‰healthç«¯ç‚¹)', 'success');
                } else {
                    log('precheck-results', `âœ… ä»£ç†ç«¯ç‚¹å“åº”: ${response.status}`, 'success');
                }
            } catch (error) {
                log('precheck-results', `âŒ ä»£ç†ç«¯ç‚¹é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testWithoutAuth() {
            log('auth-results', 'æµ‹è¯•æ— è®¤è¯è¯·æ±‚...', 'info');
            
            try {
                const response = await fetch('/api/server/deployments', {
                    method: 'GET',
                    // ä¸åŒ…å« credentials: 'include'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    log('auth-results', `âœ… æ— è®¤è¯è¯·æ±‚è¢«æ­£ç¡®æ‹’ç»: ${response.status}`, 'success');
                    logJSON('auth-results', data, 'Error Response');
                } else {
                    log('auth-results', 'âš ï¸ æ— è®¤è¯è¯·æ±‚æ„å¤–æˆåŠŸ - å¯èƒ½æœ‰å®‰å…¨é£é™©', 'error');
                }
            } catch (error) {
                log('auth-results', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testWithAuth() {
            log('auth-results', 'æµ‹è¯•æœ‰è®¤è¯è¯·æ±‚...', 'info');
            
            try {
                const response = await fetch('/api/server/deployments', {
                    method: 'GET',
                    credentials: 'include' // åŒ…å«è®¤è¯ cookie
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('auth-results', 'âœ… æœ‰è®¤è¯è¯·æ±‚æˆåŠŸ', 'success');
                    logJSON('auth-results', data, 'Success Response');
                } else {
                    log('auth-results', `è®¤è¯è¯·æ±‚å¤±è´¥: ${response.status}`, 'error');
                    logJSON('auth-results', data, 'Error Response');
                }
            } catch (error) {
                log('auth-results', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testDeployments() {
            log('api-results', 'æµ‹è¯•è·å–éƒ¨ç½²åˆ—è¡¨...', 'info');
            
            try {
                const response = await fetch('/api/server/deployments?include_details=true&include_keys=true', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('api-results', 'âœ… éƒ¨ç½²åˆ—è¡¨è·å–æˆåŠŸ', 'success');
                    logJSON('api-results', data, 'Deployments');
                } else {
                    log('api-results', `éƒ¨ç½²åˆ—è¡¨è·å–å¤±è´¥: ${response.status}`, 'error');
                    logJSON('api-results', data);
                }
            } catch (error) {
                log('api-results', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testCreateAPI() {
            log('api-results', 'æµ‹è¯•åˆ›å»º API æœåŠ¡...', 'info');
            
            const testData = {
                workspace_id: 'test-workspace-id',
                inputs: ['input1', 'input2'],
                outputs: ['output1']
            };
            
            try {
                const response = await fetch('/api/server/create_api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('api-results', 'âœ… API åˆ›å»ºæˆåŠŸ', 'success');
                    logJSON('api-results', data, 'Created API');
                } else {
                    log('api-results', `API åˆ›å»ºå¤±è´¥: ${response.status}`, 'error');
                    logJSON('api-results', data);
                }
            } catch (error) {
                log('api-results', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testCreateChatbot() {
            log('api-results', 'æµ‹è¯•åˆ›å»º Chatbot...', 'info');
            
            const testData = {
                workspace_id: 'test-workspace-id',
                input: 'user_input',
                output: 'assistant_output',
                multi_turn_enabled: true
            };
            
            try {
                const response = await fetch('/api/server/create_chatbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('api-results', 'âœ… Chatbot åˆ›å»ºæˆåŠŸ', 'success');
                    logJSON('api-results', data, 'Created Chatbot');
                } else {
                    log('api-results', `Chatbot åˆ›å»ºå¤±è´¥: ${response.status}`, 'error');
                    logJSON('api-results', data);
                }
            } catch (error) {
                log('api-results', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function checkNetworkSecurity() {
            log('security-results', 'æ£€æŸ¥ç½‘ç»œè¯·æ±‚å®‰å…¨æ€§...', 'info');
            log('security-results', 'è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘å·¥å…·çš„ Network é¢æ¿ï¼Œç„¶åé‡æ–°è¿è¡Œ API æµ‹è¯•', 'info');
            log('security-results', 'âš ï¸ ç¡®è®¤ä»¥ä¸‹å®‰å…¨è¦ç‚¹:', 'info');
            log('security-results', '1. è¯·æ±‚ä¸åº”åŒ…å« Authorization header (ç”±å®¢æˆ·ç«¯å‘é€)', 'info');
            log('security-results', '2. è¯·æ±‚ä¸åº”åŒ…å« API keys æˆ– tokens', 'info');
            log('security-results', '3. åªåº”è¯¥åŒ…å« Cookie header ç”¨äºè®¤è¯', 'info');
        }

        async function checkHeaderSafety() {
            log('security-results', 'æ£€æŸ¥è¯·æ±‚å¤´å®‰å…¨æ€§...', 'info');
            
            // å°è¯•å‘é€æ¶æ„çš„ Authorization header
            try {
                const response = await fetch('/api/server/deployments', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer malicious-token-attempt'
                    },
                    credentials: 'include'
                });
                
                log('security-results', 'âœ… æµ‹è¯•å®Œæˆ - æ£€æŸ¥ä»£ç†æ˜¯å¦æ­£ç¡®è¿‡æ»¤äº†æ¶æ„ Authorization header', 'success');
                
                if (response.ok) {
                    log('security-results', 'âœ… ä»£ç†æ­£ç¡®ä½¿ç”¨äº†æœåŠ¡ç«¯è®¤è¯ï¼Œå¿½ç•¥äº†å®¢æˆ·ç«¯ header', 'success');
                } else {
                    log('security-results', `ä»£ç†å“åº”: ${response.status}`, 'info');
                }
            } catch (error) {
                log('security-results', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>