# TableEditor 布局计算文档

## 概述

本文档描述了 JSON 表格编辑器的布局计算方式。与树形编辑器不同，表格编辑器采用**嵌套单元格**的设计：
- 固定两列布局：KEY 列 + VALUE 列
- 当 VALUE 是对象/数组时，VALUE 单元格内部递归嵌套子表格
- 支持展开/折叠控制
- 表格边框清晰分隔层级

---

## 常量定义

```typescript
// 元素尺寸
const ROW_HEIGHT = 28           // 每行最小高度 (px)
const KEY_COL_WIDTH = 120       // KEY 列固定宽度
const MIN_VALUE_WIDTH = 200     // VALUE 列最小宽度
const CELL_PADDING_X = 12       // 单元格水平内边距
const CELL_PADDING_Y = 6        // 单元格垂直内边距
const EXPAND_ICON_SIZE = 16     // 展开/折叠图标尺寸
const EXPAND_ICON_GAP = 8       // 图标与文字间距

// 边框样式
const BORDER_COLOR = '#3a3f47'  // 边框颜色
const BORDER_WIDTH = 1          // 边框宽度
const HEADER_BG = '#1e2128'     // 表头背景色
const ROW_BG_ODD = '#16181d'    // 奇数行背景色
const ROW_BG_EVEN = '#1a1d23'   // 偶数行背景色

// 嵌套层级
const NESTED_INDENT = 0         // 嵌套表格无额外缩进（通过单元格边框区分）
const MAX_DEPTH = 10            // 最大嵌套深度

// 容器间距
const CONTAINER_GAP = 4         // 容器边界间距（顶部 & 底部统一）
```

---

## 核心设计原则

### 1. 两列固定结构

表格永远是 **KEY + VALUE** 两列结构，不论嵌套多深。

```
┌────────────┬────────────────────────────────────────────────────┐
│    KEY     │                      VALUE                         │
└────────────┴────────────────────────────────────────────────────┘
```

### 2. 嵌套通过单元格内部实现

当 VALUE 是对象或数组时，展开后在 VALUE 单元格内部渲染子表格：

```
┌────────────┬────────────────────────────────────────────────────┐
│    KEY     │                      VALUE                         │
├────────────┼────────────────────────────────────────────────────┤
│  ▼ users   │  [3]                                               │
│            ├────────┬───────────────────────────────────────────┤
│            │   0    │  "张三"                                   │
│            ├────────┼───────────────────────────────────────────┤
│            │   1    │  "李四"                                   │
│            ├────────┼───────────────────────────────────────────┤
│            │   2    │  "王五"                                   │
└────────────┴────────┴───────────────────────────────────────────┘
```

### 3. 递归嵌套规则

- 叶子节点（string/number/boolean/null）：VALUE 直接显示值
- 容器节点（object/array）：VALUE 显示 `{n}` 或 `[n]`，展开后显示子表格

---

## 布局示意图

### 案例数据

```json
{
  "users": ["张三", "李四", "王五"],
  "tags": "hello",
  "name": {
    "number": "张三",
    "call": "number",
    "status": "done"
  }
}
```

### 完整渲染效果

```
┌────────────┬────────────────────────────────────────────────────────────────────┐
│    KEY     │                              VALUE                                 │
╞════════════╪════════════════════════════════════════════════════════════════════╡
│            │                                                                    │
│  ▼ users   │  [3]                                                               │
│            ├────────┬───────────────────────────────────────────────────────────┤
│            │   0    │  "张三"                                                   │
│            ├────────┼───────────────────────────────────────────────────────────┤
│            │   1    │  "李四"                                                   │
│            ├────────┼───────────────────────────────────────────────────────────┤
│            │   2    │  "王五"                                                   │
├────────────┼────────┴───────────────────────────────────────────────────────────┤
│            │                                                                    │
│    tags    │  "hello"                                                           │
│            │                                                                    │
├────────────┼────────────────────────────────────────────────────────────────────┤
│            │                                                                    │
│  ▼ name    │  {3}                                                               │
│            ├──────────┬─────────────────────────────────────────────────────────┤
│            │  number  │  "张三"                                                 │
│            ├──────────┼─────────────────────────────────────────────────────────┤
│            │  call    │  "number"                                               │
│            ├──────────┼─────────────────────────────────────────────────────────┤
│            │  status  │  "done"                                                 │
└────────────┴──────────┴─────────────────────────────────────────────────────────┘
```

### 折叠状态

```
┌────────────┬────────────────────────────────────────────────────────────────────┐
│    KEY     │                              VALUE                                 │
╞════════════╪════════════════════════════════════════════════════════════════════╡
│  ▶ users   │  [3]                                               (collapsed)    │
├────────────┼────────────────────────────────────────────────────────────────────┤
│    tags    │  "hello"                                                           │
├────────────┼────────────────────────────────────────────────────────────────────┤
│  ▶ name    │  {3}                                               (collapsed)    │
└────────────┴────────────────────────────────────────────────────────────────────┘
```

---

## 深层嵌套示例

### 案例数据

```json
{
  "users": [
    { "id": 1, "name": "张三", "roles": ["admin", "editor"] },
    { "id": 2, "name": "李四", "roles": ["viewer"] }
  ],
  "meta": {
    "total": 2,
    "pagination": {
      "page": 1,
      "limit": 10
    }
  }
}
```

### 渲染效果（部分展开）

```
┌────────────┬────────────────────────────────────────────────────────────────────────┐
│    KEY     │                              VALUE                                     │
╞════════════╪════════════════════════════════════════════════════════════════════════╡
│            │                                                                        │
│  ▼ users   │  [2]                                                                   │
│            ├────────┬───────────────────────────────────────────────────────────────┤
│            │        │                                                               │
│            │  ▼ 0   │  {3}                                                          │
│            │        ├──────────┬────────────────────────────────────────────────────┤
│            │        │    id    │  1                                                 │
│            │        ├──────────┼────────────────────────────────────────────────────┤
│            │        │   name   │  "张三"                                            │
│            │        ├──────────┼────────────────────────────────────────────────────┤
│            │        │          │                                                    │
│            │        │ ▼ roles  │  [2]                                               │
│            │        │          ├────────┬───────────────────────────────────────────┤
│            │        │          │   0    │  "admin"                                  │
│            │        │          ├────────┼───────────────────────────────────────────┤
│            │        │          │   1    │  "editor"                                 │
│            ├────────┼──────────┴────────┴───────────────────────────────────────────┤
│            │        │                                                               │
│            │  ▶ 1   │  {3}                                       (collapsed)       │
│            │        │                                                               │
├────────────┼────────┴───────────────────────────────────────────────────────────────┤
│            │                                                                        │
│  ▼ meta    │  {2}                                                                   │
│            ├──────────────┬─────────────────────────────────────────────────────────┤
│            │    total     │  2                                                      │
│            ├──────────────┼─────────────────────────────────────────────────────────┤
│            │              │                                                         │
│            │ ▼ pagination │  {2}                                                    │
│            │              ├──────────┬──────────────────────────────────────────────┤
│            │              │   page   │  1                                           │
│            │              ├──────────┼──────────────────────────────────────────────┤
│            │              │  limit   │  10                                          │
└────────────┴──────────────┴──────────┴──────────────────────────────────────────────┘
```

---

## 单元格布局详解

### 普通单元格（叶子节点）

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ← CELL_PADDING_X →  VALUE TEXT  ← CELL_PADDING_X →            │
│                                                                 │
│  ↑ CELL_PADDING_Y                                               │
│  ↓ CELL_PADDING_Y                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

尺寸计算：
  cellHeight = ROW_HEIGHT = 28px
  cellWidth  = 容器宽度 - KEY_COL_WIDTH
```

### 可展开单元格（容器节点）

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ▼  ← 8px →  KEY TEXT  ← padding →  │  {n} / [n]               │
│  ↑                                   │                          │
│  16px (EXPAND_ICON_SIZE)             │                          │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              NESTED TABLE (子表格)                        │  │
│  │                                                           │  │
│  │  ┌────────┬─────────────────────────────────────────────┐ │  │
│  │  │  KEY   │                 VALUE                       │ │  │
│  │  ├────────┼─────────────────────────────────────────────┤ │  │
│  │  │  ...   │                 ...                         │ │  │
│  │  └────────┴─────────────────────────────────────────────┘ │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## KEY 列布局

### 结构

```
┌────────────────────────────────────┐
│                                    │
│  [▼/▶]  ← 8px →  KEY_NAME          │
│                                    │
│  ↑ 可选展开图标                     │
│    仅容器节点显示                   │
│                                    │
└────────────────────────────────────┘

宽度计算：
  KEY_COL_WIDTH = 120px (固定)
  
  对于可展开节点:
    contentWidth = EXPAND_ICON_SIZE + EXPAND_ICON_GAP + textWidth
                 = 16 + 8 + textWidth
                 
  对于叶子节点:
    contentWidth = textWidth
```

### 展开图标

```
▼ 展开状态 (expanded)    ▶ 折叠状态 (collapsed)

   ╲   ╱                      │
    ╲ ╱                       ├──
     ▼                        │
     
尺寸: 16px × 16px
颜色: 与文字颜色一致
交互: 点击切换展开/折叠
```

---

## VALUE 列布局

### 叶子节点

直接显示值，根据类型着色：

```
┌──────────────────────────────────────────────────┐
│                                                  │
│  "string value"     ← 字符串：绿色 #98c379       │
│                                                  │
│  123.456            ← 数字：橙色 #d19a66         │
│                                                  │
│  true / false       ← 布尔：紫色 #c678dd         │
│                                                  │
│  null               ← 空值：灰色 #5c6370         │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 容器节点

显示类型标识 + 元素数量：

```
┌──────────────────────────────────────────────────┐
│                                                  │
│  {3}                ← Object：显示属性数量       │
│                                                  │
│  [5]                ← Array：显示元素数量        │
│                                                  │
└──────────────────────────────────────────────────┘

颜色：灰色 #abb2bf
字体：等宽字体
```

---

## 边框绘制规则

### 外层边框

```
┌────────────┬──────────────────────────────┐
│            │                              │  ← 顶部边框
├────────────┼──────────────────────────────┤  ← 表头分隔线（加粗）
│            │                              │
├────────────┼──────────────────────────────┤  ← 行间分隔线
│            │                              │
└────────────┴──────────────────────────────┘  ← 底部边框

│            │                              │
↑ 左边框     ↑ 列分隔线                    ↑ 右边框
```

### 嵌套表格边框

嵌套表格的边框与父级 VALUE 单元格共享：

```
父级 VALUE 单元格
├──────────────────────────────────────────────────┤
│  {3}                                             │  ← 容器标识行
├────────┬─────────────────────────────────────────┤  ← 子表格开始
│  KEY   │  VALUE                                  │
├────────┼─────────────────────────────────────────┤
│  ...   │  ...                                    │
         ↑
         子表格左边框 = 父级单元格内部边框
```

---

## 宽度计算

### 固定宽度 vs 自适应宽度

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CONTAINER WIDTH                                   │
├────────────┬────────────────────────────────────────────────────────────────┤
│  KEY COL   │                       VALUE COL                                │
│  (fixed)   │                       (flex: 1)                                │
│  120px     │                    剩余空间                                    │
└────────────┴────────────────────────────────────────────────────────────────┘

计算公式：
  VALUE_COL_WIDTH = CONTAINER_WIDTH - KEY_COL_WIDTH - BORDER_WIDTH * 2
                  = CONTAINER_WIDTH - 120 - 2
```

### 嵌套宽度递减

每层嵌套，VALUE 列宽度会递减（因为 KEY 列是固定的）：

```
Depth 0:  KEY(120) + VALUE(剩余)
          ├── Depth 1:  KEY(120) + VALUE(剩余-120)
              ├── Depth 2:  KEY(120) + VALUE(剩余-240)
                  └── Depth 3:  KEY(120) + VALUE(剩余-360)
```

为了防止深层嵌套导致 VALUE 列过窄，可以：
1. 设置 `MIN_VALUE_WIDTH = 200px`
2. 超过最大深度时显示为折叠的 JSON 文本

---

## 高度计算

### 单行高度

```
ROW_HEIGHT = 28px

单元格高度 = ROW_HEIGHT
           = CELL_PADDING_Y * 2 + LINE_HEIGHT
           = 6 * 2 + 16
           = 28px
```

### 展开容器高度

展开容器的高度 = 容器标识行 + 所有子行高度之和

```
┌─────────────────────────────────────────────────┐
│  ▼ users  │  [3]                      │ 28px   │ ← 容器标识行
├───────────┼───────────────────────────┤        │
│  0        │  "张三"                   │ 28px   │
├───────────┼───────────────────────────┤        │
│  1        │  "李四"                   │ 28px   │
├───────────┼───────────────────────────┤        │
│  2        │  "王五"                   │ 28px   │
└───────────┴───────────────────────────┘        │
                                          ────────
                                          112px 总高度

公式：
  expandedHeight = ROW_HEIGHT + childrenCount * ROW_HEIGHT
                 = 28 + 3 * 28
                 = 112px
```

### 嵌套容器高度

嵌套容器需要递归计算：

```
users (展开) 高度计算：
  - 容器标识行: 28px
  - 子项 0 (展开的对象): 
    - 容器标识行: 28px
    - id: 28px
    - name: 28px
    - roles (展开):
      - 容器标识行: 28px
      - 0: 28px
      - 1: 28px
      小计: 84px
    小计: 28 + 28 + 28 + 84 = 168px
  - 子项 1 (折叠): 28px
  总计: 28 + 168 + 28 = 224px
```

---

## 交互状态

### 行悬停

```
┌────────────┬──────────────────────────────────────┐
│            │                                      │
│    KEY     │               VALUE                  │  ← 默认状态
│            │                                      │
├────────────┼──────────────────────────────────────┤
│░░░░░░░░░░░░│░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│  ← 悬停状态
│░░  KEY   ░░│░░░░░░░░░░░ VALUE ░░░░░░░░░░░░░░░░░░░░│     背景色变化
│░░░░░░░░░░░░│░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│
└────────────┴──────────────────────────────────────┘

悬停背景色: rgba(255, 255, 255, 0.05)
```

### 选中状态

```
┌────────────┬──────────────────────────────────────┐
│▓▓▓▓▓▓▓▓▓▓▓▓│▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓│  ← 选中状态
│▓▓  KEY   ▓▓│▓▓▓▓▓▓▓▓▓▓▓ VALUE ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓│     高亮边框
│▓▓▓▓▓▓▓▓▓▓▓▓│▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓│
└────────────┴──────────────────────────────────────┘

选中边框色: #528bff
选中背景色: rgba(82, 139, 255, 0.1)
```

### 编辑状态

```
┌────────────┬──────────────────────────────────────┐
│            │ ┌──────────────────────────────────┐ │
│    KEY     │ │  editable input                  │ │  ← 编辑模式
│            │ │  光标闪烁                         │ │     VALUE 变为输入框
│            │ └──────────────────────────────────┘ │
└────────────┴──────────────────────────────────────┘

输入框样式:
  - 背景色: #282c34
  - 边框: 1px solid #528bff
  - 内边距: 与普通单元格一致
```

---

## 动画效果

### 展开/折叠动画

```css
.nested-table {
  overflow: hidden;
  transition: max-height 200ms ease-out;
}

/* 折叠状态 */
.nested-table.collapsed {
  max-height: 0;
}

/* 展开状态 */
.nested-table.expanded {
  max-height: var(--computed-height);
}
```

### 展开图标旋转

```css
.expand-icon {
  transition: transform 150ms ease;
}

/* 折叠：指向右 */
.expand-icon.collapsed {
  transform: rotate(0deg);
}

/* 展开：指向下 */
.expand-icon.expanded {
  transform: rotate(90deg);
}
```

---

## 响应式设计

### 窄屏适配

当容器宽度 < 400px 时：

```
┌─────────────────────────────────────────┐
│  KEY: users                             │  ← KEY 和 VALUE 垂直堆叠
│  VALUE: [3]                             │
├─────────────────────────────────────────┤
│    ├─ 0: "张三"                         │  ← 子项缩进显示
│    ├─ 1: "李四"                         │
│    └─ 2: "王五"                         │
├─────────────────────────────────────────┤
│  KEY: tags                              │
│  VALUE: "hello"                         │
└─────────────────────────────────────────┘
```

### 宽屏优化

当容器宽度 > 1200px 时，可以考虑：
- KEY 列宽度自适应内容
- VALUE 列显示更多内容
- 支持列宽拖拽调整

---

## 核心数据结构

### TableNode 类型

```typescript
interface TableNode {
  path: string;           // JSON 路径，如 "$.users[0].name"
  key: string | number;   // 当前节点的 key
  value: JsonValue;       // 当前节点的值
  depth: number;          // 嵌套深度 (0 = 顶层)
  isExpanded: boolean;    // 是否展开
  isExpandable: boolean;  // 是否可展开 (object/array)
  childCount: number;     // 子元素数量 (仅容器节点)
  valueType: ValueType;   // 值类型
}

type ValueType = 'string' | 'number' | 'boolean' | 'null' | 'object' | 'array';
```

### 渲染流程

```
1. 数据层
   JSON 对象 → buildTableTree() → TableNode[] (递归树结构)
   
2. 状态管理
   expandedPaths: Set<string>  // 记录哪些路径是展开的
   
3. 行渲染 (TableRow)
   对于每个 TableNode:
   ├── 渲染 KEY 单元格
   │   ├── 如果可展开，渲染展开图标
   │   └── 渲染 KEY 文本
   └── 渲染 VALUE 单元格
       ├── 如果是叶子节点，渲染值
       └── 如果是展开的容器，递归渲染子表格
       
4. 嵌套表格渲染 (NestedTable)
   对于展开的容器节点:
   ├── 渲染容器标识行 ({n} 或 [n])
   └── 递归渲染所有子节点
```

---

## 对比：Tree Editor vs Table Editor

| 特性 | Tree Editor | Table Editor |
|------|-------------|--------------|
| 布局方式 | 单列 + 缩进 | 双列 + 嵌套单元格 |
| 层级表示 | 连接线 (├─ └─) | 表格边框 |
| KEY 位置 | 行内，随深度缩进 | 固定第一列 |
| VALUE 位置 | 行内，KEY 后面 | 固定第二列 |
| 展开机制 | 子节点作为新行 | 子表格嵌套在单元格内 |
| 视觉特点 | 像文件树 | 像数据库表 |
| 适用场景 | 深层嵌套数据 | 扁平或浅层数据 |

---

## 总结

### 核心设计思想

1. **固定两列结构**：KEY 列固定宽度，VALUE 列自适应
2. **嵌套单元格**：展开时在 VALUE 单元格内部渲染子表格
3. **边框分隔**：用表格边框代替树形连接线
4. **递归渲染**：每个容器节点展开后递归创建子表格

### 关键特性

| 特性 | 实现方式 |
|------|---------|
| 层级可视化 | 嵌套表格边框 |
| 展开/折叠 | expandedPaths Set + 递归渲染 |
| 类型着色 | ValueRenderer 根据类型显示不同颜色 |
| 编辑功能 | 双击进入编辑模式 |
| 虚拟滚动 | 可选，针对大数据量场景 |

### 扩展性

如需调整布局，只需修改以下常量：

```typescript
const KEY_COL_WIDTH = 120     // 调整 KEY 列宽度
const CELL_PADDING_X = 12     // 调整单元格水平内边距
const CELL_PADDING_Y = 6      // 调整单元格垂直内边距
const ROW_HEIGHT = 28         // 调整行高
```
