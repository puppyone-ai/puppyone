# æ•°æ®åº“è¿ç§»ä¸æ¶æ„å‡çº§è®¡åˆ’

> æœ€åæ›´æ–°: 2024-12

## çŠ¶æ€ä¸å¾…åŠ

| é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **é˜¶æ®µä¸€ï¼šåŸºç¡€è¿ç§»** | âœ… å®Œæˆ | è¡¨ç»“æ„è¿ç§»ã€ä»£ç é€‚é…ã€Supabase Auth é›†æˆ |
| **é˜¶æ®µäºŒï¼šTools ç‹¬ç«‹åŒ–** | ğŸš§ è§„åˆ’ä¸­ | Tool å®ä½“åŒ–ã€å¤šæ¸ é“è®¿é—®ã€æœ¬åœ°æ‰§è¡Œå¼•æ“ |

**é˜¶æ®µäºŒå¾…åŠï¼š**
- [ ] DB: åˆ›å»º `tool`, `tool_access_key`, `mcp_instance_tool`, `tool_execution_log` è¡¨
- [ ] Backend: å®ç° `src/tool/` æ¨¡å— (CRUD API)
- [ ] Backend: å®ç° `src/tool_engine/` (æœ¬åœ°æ‰§è¡Œå¼•æ“)
- [ ] Frontend: Tools Sidebar æ¥å…¥æ–° API
- [ ] Migration: æ—§ JSONB æ•°æ®è¿ç§»åˆ° `tool` è¡¨

---

## æ¦‚è¿°

å°† puppyone (ContextBase) çš„ Tool ç³»ç»Ÿä» "MCP é™„å±é…ç½®" å‡çº§ä¸º "ç‹¬ç«‹å®ä½“"ï¼Œå®ç°ï¼š
- **å¤šæ¸ é“è®¿é—®**ï¼šAPIã€MCPã€CLI ç»Ÿä¸€å…¥å£
- **æœ¬åœ°æ‰§è¡Œ**ï¼šæ‘†è„±å¯¹è¿œç¨‹ MCP Server çš„ä¾èµ–
- **Tool å¤ç”¨**ï¼šä¸€æ¬¡å®šä¹‰ï¼Œå¤šå¤„å¼•ç”¨

---

## èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦è¿™æ¬¡å‡çº§

### å½“å‰ç—›ç‚¹

1. **Tools ä¸æ˜¯ç‹¬ç«‹å®ä½“**ï¼šTools ä½œä¸º JSONB å­˜å‚¨åœ¨ `mcp_instance.tools_definition`ï¼Œæ²¡æœ‰ç‹¬ç«‹ ID
2. **å•ä¸€è®¿é—®å…¥å£**ï¼šåªèƒ½é€šè¿‡ MCP Server Proxy è®¿é—®ï¼Œæ— æ³•ç›´æ¥è°ƒç”¨
3. **Tool æ— æ³•å¤ç”¨**ï¼šæ¯ä¸ª MCP Instance ç‹¬ç«‹é…ç½®ï¼Œç›¸åŒ Tool éœ€è¦é‡å¤å®šä¹‰
4. **ç¼ºä¹å®¡è®¡èƒ½åŠ›**ï¼šæ²¡æœ‰æ‰§è¡Œæ—¥å¿—ï¼Œæ— æ³•è¿½è¸ª Tool ä½¿ç”¨æƒ…å†µ
5. **æ‰©å±•æ€§å·®**ï¼šæ— æ³•æ”¯æŒ CLIã€ç›´æ¥ API ç­‰å¤šæ¸ é“è®¿é—®

### ç›®æ ‡

- æ”¯æŒå¤šæ¸ é“è®¿é—®ï¼ˆAPIã€MCPã€CLIã€æœªæ¥ gRPCï¼‰
- Tool æˆä¸ºç‹¬ç«‹å®ä½“ï¼Œå¯å¤ç”¨ã€å¯è¿½è¸ª
- æœ¬åœ°æ‰§è¡Œå¼•æ“ï¼Œå‡å°‘å¯¹å¤–éƒ¨æœåŠ¡ä¾èµ–
- çµæ´»çš„è®¤è¯æœºåˆ¶ï¼ˆJWTã€Tool Keyï¼‰

---

## æ¶æ„å¯¹æ¯”

### ç°æœ‰æ¶æ„ï¼ˆé˜¶æ®µä¸€ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Access Channel (å”¯ä¸€å…¥å£)                    â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                      â”‚ MCP Server  â”‚                            â”‚
â”‚                      â”‚   Proxy     â”‚                            â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MCP Instance (æ ¸å¿ƒå®ä½“)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  api_key (JWT)                                             â”‚ â”‚
â”‚  â”‚  user_id, project_id, table_id, json_pointer               â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  tools_definition: {        â† å·¥å…·æ˜¯ JSONB é…ç½®ï¼Œä¸æ˜¯å®ä½“   â”‚ â”‚
â”‚  â”‚    "query_data": {...},                                    â”‚ â”‚
â”‚  â”‚    "create": {...},                                        â”‚ â”‚
â”‚  â”‚  }                                                         â”‚ â”‚
â”‚  â”‚  register_tools: ["query_data", "create"]                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¿œç¨‹ MCP Server (å¤–éƒ¨æœåŠ¡)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ¥æ”¶ api_key â†’ æŸ¥è¯¢ mcp_instance â†’ æ‰§è¡Œå·¥å…·               â”‚ â”‚
â”‚  â”‚  å·¥å…·é€»è¾‘ç¡¬ç¼–ç åœ¨ MCP Server é‡Œ                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Layer (æ•°æ®å±‚)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   project   â”‚  â”‚context_tableâ”‚  â”‚mcp_instance â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                           â”‚                     â”‚
â”‚                                    tools_definition (JSONB)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯·æ±‚æµç¨‹ï¼š**
```
Client
  â”‚
  â”‚ POST /mcp/server/{mcp_api_key}/mcp
  â–¼
Backend (Proxy)
  â”‚ 1. éªŒè¯ mcp_api_key å­˜åœ¨
  â”‚ 2. æ£€æŸ¥ mcp_instance.status == 1
  â”‚ 3. è½¬å‘è¯·æ±‚åˆ°è¿œç¨‹ MCP Server
  â–¼
Remote MCP Server (settings.MCP_SERVER_URL)
  â”‚ 1. è§£æ X-API-KEY header
  â”‚ 2. å›è°ƒ Backend è·å– mcp_instance ä¿¡æ¯
  â”‚ 3. æ ¹æ® tools_definition æ‰§è¡Œå·¥å…·
  â–¼
Response
```

---

### ç›®æ ‡æ¶æ„ï¼ˆé˜¶æ®µäºŒï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Access Channels (å¤šå…¥å£)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   API   â”‚   â”‚   MCP   â”‚   â”‚   CLI   â”‚   â”‚ Future  â”‚         â”‚
â”‚  â”‚ (REST)  â”‚   â”‚ Server  â”‚   â”‚ (Shell) â”‚   â”‚ (gRPC?) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Tool Execution Engine (æœ¬åœ°æ‰§è¡Œå¼•æ“)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  authenticate() â†’ authorize() â†’ execute() â†’ audit()        â”‚â”‚
â”‚  â”‚                                                            â”‚â”‚
â”‚  â”‚  å·¥å…·æ‰§è¡Œé€»è¾‘åœ¨æœ¬åœ°ï¼Œä¸ä¾èµ–å¤–éƒ¨ MCP Server                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Tool Registry (å·¥å…·æ³¨å†Œè¡¨)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  query   â”‚  â”‚  create  â”‚  â”‚  update  â”‚  â”‚  delete  â”‚  ...   â”‚
â”‚  â”‚  å®ä½“    â”‚  â”‚  å®ä½“    â”‚  â”‚  å®ä½“    â”‚  â”‚  å®ä½“    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Layer (æ•°æ®å±‚)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   project   â”‚  â”‚context_tableâ”‚  â”‚   tool   â”‚  â”‚mcp_instanceâ”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                          â”‚              â”‚              â”‚        â”‚
â”‚                          â”‚    1:N       â”‚     N:M      â”‚        â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                         â”‚                       â”‚
â”‚                              mcp_instance_tool (å…³è”è¡¨)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯·æ±‚æµç¨‹ (API æ¸ é“)ï¼š**
```
Client
  â”‚
  â”‚ POST /tools/{tool_id}/execute
  â”‚ Header: Authorization: Bearer {jwt} æˆ– X-Tool-Key: {key}
  â–¼
Backend (Tool Router)
  â”‚ 1. è®¤è¯ (JWT æˆ– Tool Key)
  â”‚ 2. æˆæƒ (æ£€æŸ¥å¯¹ tool çš„è®¿é—®æƒé™)
  â–¼
Tool Execution Engine
  â”‚ 1. è·å– Tool å®ä½“
  â”‚ 2. æ£€æŸ¥ status, rate_limit
  â”‚ 3. æ‰§è¡Œå·¥å…·é€»è¾‘ (æœ¬åœ°)
  â”‚ 4. è®°å½•å®¡è®¡æ—¥å¿—
  â–¼
Response
```

**è¯·æ±‚æµç¨‹ (MCP æ¸ é“)ï¼š**
```
Client (AI Agent)
  â”‚
  â”‚ POST /mcp/server/{mcp_api_key}/mcp
  â–¼
Backend (MCP Proxy)
  â”‚ 1. éªŒè¯ mcp_api_key
  â”‚ 2. è½¬å‘åˆ° MCP Server
  â–¼
MCP Server
  â”‚ 1. è§£æ tool_call
  â”‚ 2. å›è°ƒ Backend çš„ Tool Engine
  â–¼
Tool Execution Engine (æœ¬åœ°)
  â”‚ 1. æŸ¥æ‰¾ mcp_instance_tool å…³è”
  â”‚ 2. æ‰§è¡Œå·¥å…· (å…±ç”¨é€»è¾‘)
  â”‚ 3. è®°å½•å®¡è®¡æ—¥å¿—
  â–¼
Response
```

---

### æ ¸å¿ƒå·®å¼‚å¯¹æ¯”

| ç»´åº¦ | ç°æœ‰æ¶æ„ | ç›®æ ‡æ¶æ„ |
|------|---------|---------|
| **Tool èº«ä»½** | JSONB é…ç½®ï¼Œæ— ç‹¬ç«‹ ID | ç‹¬ç«‹å®ä½“ï¼ŒUUID ä¸»é”® |
| **Tool å­˜å‚¨** | `mcp_instance.tools_definition` | ç‹¬ç«‹ `tool` è¡¨ |
| **è®¿é—®å…¥å£** | ä»… MCP Server Proxy | API + MCP + CLI + ... |
| **æ‰§è¡Œä½ç½®** | è¿œç¨‹ MCP Server | æœ¬åœ° Execution Engine |
| **è®¤è¯ç²’åº¦** | MCP Instance çº§åˆ« | Tool çº§åˆ« (å¯é€‰) |
| **Tool å¤ç”¨** | âŒ ç»‘å®šå•ä¸ª Instance | âœ… å¤š Instance å¼•ç”¨ |
| **ç›´æ¥è®¿é—®** | âŒ å¿…é¡»é€šè¿‡ MCP | âœ… `/tools/:id/execute` |
| **å®¡è®¡æ—¥å¿—** | âŒ æ—  | âœ… `tool_execution_log` |
| **é™æµæ§åˆ¶** | âŒ æ—  | âœ… `rate_limit` å­—æ®µ |

---

## é˜¶æ®µä¸€ï¼šåŸºç¡€è¿ç§»ï¼ˆå½“å‰ï¼‰

### ç›®æ ‡

å°†ç°æœ‰ puppyone çš„ä¸‰å¼ è¡¨è¿ç§»åˆ°ç›®æ ‡ Supabase é¡¹ç›®ï¼Œé€‚é… Supabase Authã€‚

### æ•°æ®æ¨¡å‹

```
auth.users (Supabase å†…ç½®)
    â”‚
    â”‚ 1:N
    â–¼
project
    â”‚
    â”‚ 1:N
    â–¼
context_table (åŸå table)
    â”‚
    â”‚ 1:N
    â–¼
mcp_instance (åŸå mcp)
    â”‚
    â””â”€â”€ tools_definition (JSONB) â† æš‚æ—¶ä¿ç•™
```

### ä¸»è¦å˜æ›´

| åŸè¡¨å | æ–°è¡¨å | å˜æ›´åŸå›  |
|--------|--------|----------|
| `table` | `context_table` | é¿å… SQL ä¿ç•™å­— |
| `mcp` | `mcp_instance` | æ›´æ¸…æ™°çš„å‘½å |
| `user_temp` | åˆ é™¤ | æ”¹ç”¨ `auth.users` |

### user_id ç±»å‹å˜æ›´

- åŸ: `bigint` (å…³è” `user_temp.id`)
- æ–°: `uuid` (å…³è” `auth.users.id`)

### è¿ç§»æ­¥éª¤

1. [x] åˆ†æç°æœ‰ Supabase é¡¹ç›®è¡¨ç»“æ„
2. [x] åœ¨æµ‹è¯• Branch åˆ›å»º `project`, `context_table`, `mcp_instance` è¡¨
3. [x] é…ç½® RLS ç­–ç•¥
4. [x] ä¿®æ”¹åç«¯ä»£ç é€‚é…æ–°è¡¨å (`table` â†’ `context_table`, `mcp` â†’ `mcp_instance`)
5. [ ] æµ‹è¯•éªŒè¯
6. [ ] Merge åˆ° Production

---

## é˜¶æ®µäºŒï¼šTools ç‹¬ç«‹åŒ–ï¼ˆæœªæ¥ï¼‰

### ç›®æ ‡

å°† Tools ä» `mcp_instance.tools_definition` (JSONB) æ‹†åˆ†ä¸ºç‹¬ç«‹çš„ `tool` è¡¨ï¼Œä½¿ Tools æˆä¸ºä¸€ç­‰å…¬æ°‘ã€‚

### æœ€ç»ˆæ•°æ®æ¨¡å‹

```
auth.users
    â”‚
    â–¼
project
    â”‚
    â–¼
context_table
    â”‚
    â”‚ 1:N
    â–¼
tool (æ–°è¡¨)  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚ N:M
    â”‚                 â”‚
    â–¼                 â”‚
mcp_instance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (é€šè¿‡ mcp_instance_tool)
```

### æ–°å¢è¡¨ç»“æ„

#### `tool` è¡¨

```sql
CREATE TABLE public.tool (
  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  table_id        bigint NOT NULL REFERENCES public.context_table(id) ON DELETE CASCADE,
  path            text NOT NULL,              -- JSON è·¯å¾„ï¼Œå¦‚ "/metadata/author"
  tool_type       text NOT NULL,              -- 'query_data', 'create', 'update', 'delete' ç­‰
  
  -- å·¥å…·å®šä¹‰
  name            text NOT NULL,              -- å·¥å…·åç§°
  description     text,                       -- å·¥å…·æè¿°
  input_schema    jsonb DEFAULT '{}',         -- è¾“å…¥å‚æ•° schema
  config          jsonb DEFAULT '{}',         -- æ‰©å±•é…ç½®ï¼ˆrate limit, schema hints ç­‰ï¼‰
  
  -- è®¿é—®æ§åˆ¶
  status          text DEFAULT 'active',      -- 'active', 'disabled', 'deprecated'
  visibility      text DEFAULT 'private',     -- 'private', 'public', 'shared'
  
  -- æ—¶é—´æˆ³
  created_at      timestamptz DEFAULT now(),
  updated_at      timestamptz DEFAULT now(),
  
  UNIQUE(table_id, path, tool_type)           -- æ¯ä¸ªè·¯å¾„æ¯ç§ç±»å‹åªèƒ½æœ‰ä¸€ä¸ª
);
```

#### `tool_access_key` è¡¨ï¼ˆTool ç‹¬ç«‹è®¤è¯ï¼‰

```sql
CREATE TABLE public.tool_access_key (
  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tool_id         uuid NOT NULL REFERENCES tool(id) ON DELETE CASCADE,
  
  -- Key ä¿¡æ¯
  key_hash        text NOT NULL,              -- bcrypt hashï¼Œä¸å­˜æ˜æ–‡
  key_prefix      text NOT NULL,              -- å‰ç¼€ç”¨äºè¯†åˆ«ï¼Œå¦‚ "tk_abc..."
  name            text DEFAULT 'default',     -- ç”¨æˆ·è‡ªå®šä¹‰åç§°
  
  -- æƒé™
  scopes          text[] DEFAULT ARRAY['execute'],  -- execute, read, admin
  
  -- ç”Ÿå‘½å‘¨æœŸ
  expires_at      timestamptz,
  last_used_at    timestamptz,
  revoked_at      timestamptz,
  
  created_at      timestamptz DEFAULT now()
);
```

#### `mcp_instance_tool` è¡¨ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰

```sql
CREATE TABLE public.mcp_instance_tool (
  id                   bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  mcp_instance_id      bigint NOT NULL REFERENCES public.mcp_instance(id) ON DELETE CASCADE,
  tool_id              uuid NOT NULL REFERENCES public.tool(id) ON DELETE CASCADE,
  
  -- Server çº§è¦†ç›–é…ç½®
  override_name        text,
  override_description text,
  enabled              boolean DEFAULT true,
  
  UNIQUE(mcp_instance_id, tool_id)
);
```

#### `tool_execution_log` è¡¨ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰

```sql
CREATE TABLE public.tool_execution_log (
  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tool_id         uuid NOT NULL REFERENCES tool(id),
  
  -- è®¿é—®æ¸ é“
  channel         text NOT NULL,              -- 'api', 'mcp', 'cli'
  
  -- è®¤è¯ä¿¡æ¯
  auth_method     text NOT NULL,              -- 'jwt', 'api_key', 'mcp_proxy'
  auth_identity   text,                       -- user_id æˆ– key_prefix
  
  -- æ‰§è¡Œä¿¡æ¯
  input           jsonb,
  output          jsonb,
  status          text,                       -- 'success', 'error'
  error_message   text,
  duration_ms     int,
  
  created_at      timestamptz DEFAULT now()
);
```

### é¢„æœŸæ”¶ç›Š

| ç‰¹æ€§ | é˜¶æ®µä¸€ | é˜¶æ®µäºŒ |
|------|--------|--------|
| Tools æŒä¹…åŒ– | âœ… (JSONB) | âœ… (ç‹¬ç«‹è¡¨) |
| CLI ç›´æ¥è®¿é—® Tool | âŒ | âœ… `/tools/:id/execute` |
| Tool è·¨ Server å¤ç”¨ | âŒ | âœ… |
| Tool ç‹¬ç«‹ Token | âŒ | âœ… `tool_access_key` |
| Tool ç‰ˆæœ¬æ§åˆ¶ | âŒ | âœ… å¯æ‰©å±• |
| Rate Limiting | âŒ | âœ… `config` å­—æ®µ |
| å®¡è®¡æ—¥å¿— | âŒ | âœ… `tool_execution_log` |

---

## åç«¯æ¨¡å—è®¾è®¡ï¼ˆé˜¶æ®µäºŒï¼‰

### ç›®å½•ç»“æ„

```
backend/src/
â”œâ”€â”€ tool/                          # ğŸ†• Tool æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ models.py                  # Tool, ToolAccessKey é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ schemas.py                 # API schemas
â”‚   â”œâ”€â”€ repository.py              # æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ service.py                 # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ router.py                  # REST API è·¯ç”±
â”‚   â””â”€â”€ dependencies.py            # ä¾èµ–æ³¨å…¥
â”‚
â”œâ”€â”€ tool_engine/                   # ğŸ†• ç»Ÿä¸€æ‰§è¡Œå¼•æ“
â”‚   â”œâ”€â”€ executor.py                # æ ¸å¿ƒæ‰§è¡Œé€»è¾‘
â”‚   â”œâ”€â”€ auth.py                    # å¤šæ¸ é“è®¤è¯
â”‚   â”œâ”€â”€ rate_limiter.py            # é™æµ
â”‚   â””â”€â”€ audit.py                   # å®¡è®¡æ—¥å¿—
â”‚
â”œâ”€â”€ channels/                      # ğŸ†• æ¥å…¥æ¸ é“é€‚é…å™¨
â”‚   â”œâ”€â”€ api/                       # REST API æ¸ é“
â”‚   â”‚   â””â”€â”€ router.py              # /tools/:id/execute
â”‚   â”œâ”€â”€ mcp/                       # MCP æ¸ é“ (ç°æœ‰ï¼Œéœ€æ”¹é€ )
â”‚   â”‚   â””â”€â”€ adapter.py             # MCP â†’ Tool Engine é€‚é…
â”‚   â””â”€â”€ cli/                       # CLI æ¸ é“ (é¢„ç•™)
â”‚       â””â”€â”€ handler.py
â”‚
â”œâ”€â”€ mcp/                           # ç°æœ‰ MCP æ¨¡å— (ä¿ç•™ï¼Œéƒ¨åˆ†æ”¹é€ )
â”‚   â””â”€â”€ ...
```

---

## API è®¾è®¡ï¼ˆé˜¶æ®µäºŒï¼‰

### Tools APIï¼ˆç›´æ¥è®¿é—®ï¼‰

```
GET    /api/v1/tools                    # åˆ—å‡ºæ‰€æœ‰ tools
GET    /api/v1/tools/:id                # è·å–å•ä¸ª tool
POST   /api/v1/tools                    # åˆ›å»º tool
PUT    /api/v1/tools/:id                # æ›´æ–° tool
DELETE /api/v1/tools/:id                # åˆ é™¤ tool
POST   /api/v1/tools/:id/execute        # ğŸ”¥ ç›´æ¥æ‰§è¡Œ toolï¼ˆCLI/Sandbox ç”¨ï¼‰

# Tool Access Key ç®¡ç†
POST   /api/v1/tools/:id/keys           # åˆ›å»º access key
GET    /api/v1/tools/:id/keys           # åˆ—å‡º access keys
DELETE /api/v1/tools/:id/keys/:keyId    # æ’¤é”€ access key
```

### MCP Servers API

```
GET    /api/v1/mcp-instances            # åˆ—å‡º servers
POST   /api/v1/mcp-instances            # åˆ›å»º server
PUT    /api/v1/mcp-instances/:id        # æ›´æ–° server
DELETE /api/v1/mcp-instances/:id        # åˆ é™¤ server
POST   /api/v1/mcp-instances/:id/tools  # æ·»åŠ  tools åˆ° server
DELETE /api/v1/mcp-instances/:id/tools/:toolId  # ç§»é™¤ tool
```

### è®¿é—®æ–¹å¼å¯¹æ¯”

| æ¸ é“ | è®¤è¯æ–¹å¼ | URL/å‘½ä»¤ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|
| **API** | JWT æˆ– Tool Key | `POST /tools/:id/execute` | Web App, åç«¯æœåŠ¡ |
| **MCP** | MCP API Key | `POST /mcp/server/:key/mcp` | AI Agent, Claude |
| **CLI** | Tool Key | `puppyone exec :tool_id` | å¼€å‘è€…ç»ˆç«¯ |

---

## è¿ç§»æ­¥éª¤

### é˜¶æ®µä¸€ï¼ˆå½“å‰ï¼‰

1. [x] åˆ†æç°æœ‰ Supabase é¡¹ç›®è¡¨ç»“æ„
2. [x] åœ¨æµ‹è¯• Branch åˆ›å»º `project`, `context_table`, `mcp_instance` è¡¨
3. [x] é…ç½® RLS ç­–ç•¥
4. [x] ä¿®æ”¹åç«¯ä»£ç é€‚é…æ–°è¡¨å (`table` â†’ `context_table`, `mcp` â†’ `mcp_instance`)
5. [ ] æµ‹è¯•éªŒè¯
6. [ ] Merge åˆ° Production

### é˜¶æ®µäºŒ

#### Phase 2.1: åŸºç¡€è®¾æ–½
- [ ] åˆ›å»º `tool` è¡¨
- [ ] åˆ›å»º `tool_access_key` è¡¨
- [ ] åˆ›å»º `mcp_instance_tool` å…³è”è¡¨
- [ ] åˆ›å»º `tool_execution_log` è¡¨
- [ ] é…ç½® RLS ç­–ç•¥

#### Phase 2.2: åç«¯æ¨¡å—
- [ ] åˆ›å»º `src/tool/` æ¨¡å—
- [ ] åˆ›å»º `src/tool_engine/` æ¨¡å—
- [ ] å®ç° Tool CRUD API
- [ ] å®ç° `/tools/:id/execute` API
- [ ] å®ç° Tool Key è®¤è¯

#### Phase 2.3: MCP æ”¹é€ 
- [ ] ä¿®æ”¹ MCP Server è°ƒç”¨ Tool Engine
- [ ] å®ç° `mcp_instance_tool` å…³è”é€»è¾‘
- [ ] ä¿æŒå‘åå…¼å®¹ (`tools_definition`)

#### Phase 2.4: å‰ç«¯æ›´æ–°
- [ ] æ›´æ–° Tools Sidebar ä½¿ç”¨æ–° API
- [ ] æ·»åŠ  Tool Key ç®¡ç†ç•Œé¢

#### Phase 2.5: æ¸…ç†
- [ ] è¿ç§»å†å²æ•°æ®ï¼š`mcp_instance.tools_definition` â†’ `tool` è¡¨
- [ ] ç§»é™¤ `mcp_instance.tools_definition` å­—æ®µ

---

## æ³¨æ„äº‹é¡¹

1. **é˜¶æ®µä¸€ä¿ç•™ `tools_definition` å­—æ®µ**ï¼šä¸ºäº†å¿«é€Ÿè¿ç§»ï¼Œé˜¶æ®µä¸€æš‚æ—¶ä¿ç•™ JSONB å­˜å‚¨æ–¹å¼
2. **UUID vs bigint**ï¼š`tool.id` ä½¿ç”¨ UUIDï¼Œä¾¿äºç‹¬ç«‹å¯»å€ï¼›å…¶ä»–è¡¨ä¿æŒ bigint
3. **RLS ç­–ç•¥**ï¼šéµå¾ªç°æœ‰é¡¹ç›®çš„å‘½åè§„èŒƒ `{table}_{action}`
4. **service_role è®¿é—®**ï¼šåç«¯ API éœ€è¦ service_role æƒé™ç»•è¿‡ RLS
5. **å‘åå…¼å®¹**ï¼šé˜¶æ®µäºŒéœ€è¦åŒæ—¶æ”¯æŒæ–°æ—§ä¸¤ç§æ•°æ®ç»“æ„ï¼Œé€æ­¥è¿ç§»
