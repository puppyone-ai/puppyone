# Content Storage Architecture

> **AI Content Space 存储架构设计文档**
>
> 最后更新: 2026-01-25
> 状态: 已确认

---

## 1. 设计目标

构建一个面向 AI Agent 的云端 Content Space，支持：

- ✅ 多种内容类型：JSON、Markdown、图片、PDF 等
- ✅ 文件夹层级结构：用户看到的是类似文件系统的界面
- ✅ 精细权限控制：控制哪些 Agent 能访问哪些内容
- ✅ 高性能读写：小文件快速访问，大文件流式传输
- ✅ 成本优化：根据内容特性选择最佳存储

---

## 2. 架构概览

### 2.1 三层存储架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        用户视角                                       │
│                                                                       │
│   📁 我的项目/                                                        │
│   ├── 📁 文档/                                                       │
│   │   ├── 📄 需求.md                                                 │
│   │   └── 📄 配置.json                                               │
│   ├── 📁 图片/                                                       │
│   │   └── 🖼️ logo.png                                               │
│   └── 📄 README.md                                                   │
│                                                                       │
│   路径：/我的项目/文档/需求.md                                         │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 映射
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        实际存储                                       │
│                                                                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
│  │   PostgreSQL    │  │       S3        │  │   向量数据库     │      │
│  │ (元数据+结构化)  │  │  (非结构化)      │  │   (索引层)      │      │
│  │                 │  │                 │  │                 │      │
│  │ • 树形结构       │  │ • Markdown      │  │ • 文本 Embedding│      │
│  │ • 路径索引       │  │ • 图片/PDF      │  │ • 语义搜索      │      │
│  │ • 权限控制       │  │ • 视频/二进制   │  │ • RAG 检索      │      │
│  │ • JSON 内容     │  │ • 版本历史      │  │                 │      │
│  │   (JSONB)       │  │                 │  │                 │      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘      │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 各层职责

| 层 | 技术 | 存储内容 | 职责 |
|----|------|---------|------|
| **结构化层** | PostgreSQL JSONB | 节点信息、权限、**所有 JSON** | 树形结构、路径解析、事务、部分更新、字段查询 |
| **非结构化层** | S3 | Markdown、图片、PDF、视频 | 海量存储、CDN 分发、版本控制 |
| **索引层** | Turbopuffer | Embeddings | 语义搜索、RAG |

---

## 3. 核心设计决策

### 3.1 路径表示法：邻接表 + 物化路径

**选择理由：**
- 读操作远多于写操作
- 需要支持"按路径访问"这一高频操作
- 移动文件夹相对少见

**实现方式：**

每个节点同时存储：
1. `parent_id` - 父节点 ID（邻接表）
2. `path` - 完整路径字符串（物化路径）

```
用户路径：/我的项目/文档/需求.md

数据库记录：
┌──────────┬───────────┬──────────┬─────────────────────────┐
│ id       │ name      │ parent_id│ path                    │
├──────────┼───────────┼──────────┼─────────────────────────┤
│ aaa      │ 我的项目   │ NULL     │ /我的项目                │
│ bbb      │ 文档       │ aaa      │ /我的项目/文档           │
│ ccc      │ 需求.md    │ bbb      │ /我的项目/文档/需求.md   │
└──────────┴───────────┴──────────┴─────────────────────────┘
```

**操作映射：**

| 操作 | 实现 |
|------|------|
| 列出子项 | `WHERE parent_id = ?` |
| 按路径访问 | `WHERE path = ?` |
| 移动节点 | 更新 `parent_id` + 批量更新子节点 `path` |

### 3.2 存储分流策略

**核心原则：按「内容性质」分流，而非按「大小」分流**

```
结构化数据（需要部分更新/查询） → PostgreSQL JSONB
非结构化内容（整体读写）         → S3 对象存储
```

**按类型分流：**

| 内容类型 | 存储位置 | 理由 |
|---------|---------|------|
| **JSON（任意大小）** | PostgreSQL JSONB | 结构化数据，需要部分更新、字段查询、事务 |
| **Markdown** | S3 | 非结构化文本，整体读写，同时建立向量索引 |
| **图片/PDF/视频** | S3 | 二进制文件，无需数据库操作 |
| **其他文本文件** | S3 | 非结构化内容 |
| **文件夹** | PostgreSQL | 只有元数据，无内容体 |

**为什么 JSON 统一用 JSONB？**

1. JSON 是「结构化数据」，不是「文件」
2. AI Agent 需要操作 JSON 的内部字段（读取、修改、删除某个 key）
3. JSONB 支持 `jsonb_set()` 部分更新，S3 必须整体覆盖
4. JSONB 支持 SQL 查询 JSON 内部（`WHERE data->>'key' = 'value'`）
5. JSONB 支持事务（多个修改要么全成功要么全回滚）

### 3.3 S3 Key 设计

**S3 使用扁平的 UUID key，不使用用户可见路径：**

```
用户路径：/我的项目/文档/需求.md
S3 Key：  users/{user_id}/content/{random_uuid}.md
```

**理由：**
- 重命名/移动不需要改 S3 key
- 避免路径中的特殊字符问题
- 防止通过 S3 key 推断文件结构

---

## 4. 文件夹机制

### 4.1 树形结构的实现方式

**文件夹层级通过「每个节点独立存储 + parent_id 关联」实现，不是中心化 JSON。**

```
┌─────────────────────────────────────────────────────────────────┐
│                    树形结构的构建方式                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│   每个资源（包括文件夹）= 数据库里的独立一行                        │
│   树形结构通过 parent_id 字段关联                                 │
│                                                                   │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │ id     │ name      │ type    │ parent_id │ path         │    │
│   ├────────┼───────────┼─────────┼───────────┼──────────────┤    │
│   │ 001    │ 我的项目   │ folder  │ NULL      │ /我的项目     │    │
│   │ 002    │ 文档       │ folder  │ 001       │ /我的项目/文档│    │
│   │ 003    │ readme.md  │ markdown│ 002       │ /我的项目/... │    │
│   │ 004    │ config.json│ json    │ 001       │ /我的项目/... │    │
│   └────────┴───────────┴─────────┴───────────┴──────────────┘    │
│                                                                   │
│   逻辑视图（通过 parent_id 拼出来）：                              │
│                                                                   │
│     001 (我的项目)                                                │
│      ├── 002 (文档)        ← parent_id = 001                     │
│      │    └── 003 (readme) ← parent_id = 002                     │
│      └── 004 (config)      ← parent_id = 001                     │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

**这种方式的优势：**

1. **并发安全**：多人同时添加文件，各自 INSERT 一行，互不影响
2. **独立权限**：每个节点有自己的 permissions 字段
3. **高效查询**：`WHERE parent_id = ?` 有索引，列出子项很快
4. **原子操作**：删除/移动一个节点是独立事务，不影响其他节点
5. **灵活扩展**：每个节点可以有不同的元数据

### 4.2 文件夹节点

**文件夹 = type 为 'folder' 的节点，没有内容体，只作为组织结构存在。**

```
┌──────────────────────────────────────────────────────────┐
│  content_nodes (文件夹记录示例)                            │
├──────────────────────────────────────────────────────────┤
│  id: "folder-001"                                         │
│  name: "文档"                                             │
│  type: "folder"         ← 标识这是文件夹                   │
│  parent_id: "project-001"                                 │
│  path: "/我的项目/文档"                                    │
│  content: NULL          ← 文件夹没有 JSONB 内容            │
│  s3_key: NULL           ← 文件夹没有 S3 对象               │
│  permissions: {...}     ← 文件夹也有独立权限               │
└──────────────────────────────────────────────────────────┘
```

**各类型节点对比：**

| type | content (JSONB) | s3_key | 说明 |
|------|-----------------|--------|------|
| `folder` | NULL | NULL | 组织结构，无内容体 |
| `json` | ✅ 有值 | NULL | JSON 数据存 JSONB 列 |
| `markdown` | NULL | ✅ 有值 | 内容存 S3 |
| `image` | NULL | ✅ 有值 | 内容存 S3 |

### 4.3 文件夹操作

| 操作 | 实现逻辑 |
|------|---------|
| **创建文件夹** | INSERT 一个 type='folder' 的节点 |
| **删除文件夹** | 递归删除所有子节点 + 对应的 S3 对象 |
| **移动文件夹** | 更新 parent_id + 批量更新所有子节点的 path |
| **重命名** | 更新 name + 批量更新所有子节点的 path |

---

## 5. 权限模型

### 5.1 权限存储

每个节点有独立的 `permissions` 字段：

```json
{
  "public": false,
  "inherit": true,
  "agents": [
    { "agent_id": "agent-001", "level": "read" },
    { "agent_id": "agent-002", "level": "write" }
  ],
  "users": [
    { "user_id": "user-001", "level": "admin" }
  ]
}
```

### 5.2 权限继承

- `inherit: true` → 继承父文件夹权限
- `inherit: false` → 使用自己的权限，不继承

**权限检查流程：**

```
1. 检查节点自身权限
2. 如果 inherit=true，递归检查父节点
3. 直到找到 inherit=false 的节点或到达根节点
```

---

## 6. 读写流程

### 6.1 写入流程

```
用户上传内容
     │
     ▼
┌─────────────────────────────┐
│ 1. 验证权限                  │
│ 2. 判断内容类型              │
└──────────────┬──────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
    ▼                     ▼
  JSON？              非 JSON？
(结构化数据)         (Markdown/图片/PDF)
    │                     │
    ▼                     ▼
PostgreSQL            S3 上传
JSONB 列              获取 s3_key
    │                     │
    └──────────┬──────────┘
               │
               ▼
┌─────────────────────────────┐
│ 3. INSERT/UPDATE 节点记录    │
│    - 设置 storage_class     │
│    - 更新 path              │
│    - 记录 size, mime_type   │
└─────────────────────────────┘
               │
               ▼
┌─────────────────────────────┐
│ 4. (可选) 建立向量索引       │
│    - Markdown/文本内容       │
└─────────────────────────────┘
```

### 6.2 读取流程

```
用户请求：GET /path/to/content
     │
     ▼
┌─────────────────────────────┐
│ 1. 通过 path 查找节点        │
│    SELECT * FROM nodes      │
│    WHERE path = ?           │
└──────────────┬──────────────┘
               │
               ▼
┌─────────────────────────────┐
│ 2. 验证权限                  │
│    检查 Agent/User 访问权限  │
└──────────────┬──────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
    ▼                     ▼
type = 'json'        type = 其他
(结构化数据)         (Markdown/图片等)
    │                     │
    ▼                     ▼
返回                  S3 下载
JSONB 列内容          s3_key 对应文件
    │                     │
    └──────────┬──────────┘
               │
               ▼
         返回内容给用户
```

---

## 7. 与现有架构的关系

### 7.1 现有结构

```
当前：
- project 表：项目/工作区
- table 表：内容表（data JSONB 列存 JSON）

问题：
- 只支持 JSON，不支持 Markdown/图片
- 没有文件夹层级
- 大 JSON 性能差
```

### 7.2 迁移路径

```
Phase 1 (当前)：
  project → table (data JSONB)

Phase 2 (目标)：
  project → content_nodes (树形结构)
                ↓
        ┌───────┴───────┐
        │               │
   inline_content      S3
   (小内容)            (大内容)
```

### 7.3 兼容策略

- 保留现有 `table` 表，作为 `content_nodes` 的特例
- 新内容使用 `content_nodes` 表
- 渐进式迁移老数据

---

## 8. 技术选型确认

| 组件 | 选型 | 理由 |
|------|------|------|
| **元数据 + JSON** | PostgreSQL (Supabase) | 事务、JSONB 部分更新、字段查询 |
| **非结构化内容** | S3 (兼容) | Markdown/图片/PDF，成本低、CDN 加速 |
| **向量数据库** | Turbopuffer | 已集成、性能好 |
| **路径模型** | 邻接表 + 物化路径 | 读多写少场景最优 |
| **分流标准** | 按内容性质 | JSON→JSONB，其他→S3 |

---

## 9. 待定事项

- [ ] content_nodes 表详细 Schema 设计
- [ ] 权限继承的具体实现
- [ ] 路径更新的触发器/批量更新逻辑
- [ ] S3 生命周期策略（版本保留、过期删除）
- [ ] 向量索引的自动更新机制
- [ ] 前端文件浏览器组件设计

---

## 10. 参考

- [PostgreSQL JSONB 文档](https://www.postgresql.org/docs/current/datatype-json.html)
- [AWS S3 性能指南](https://docs.aws.amazon.com/AmazonS3/latest/userguide/optimizing-performance.html)
- [树形结构存储模式对比](https://www.slideshare.net/billkarwin/models-for-hierarchical-data)

