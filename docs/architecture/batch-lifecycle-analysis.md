# Batch èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†åˆ†æ

## ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: Template Creation (æ¨¡æ¿åˆ›ä½œ)                       â”‚
â”‚ Actor: Template Author                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: Template Storage (æ¨¡æ¿å­˜å‚¨)                        â”‚
â”‚ Location: Git Repository                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: Template Loading (æ¨¡æ¿åŠ è½½)                        â”‚
â”‚ Actor: CloudTemplateLoader                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 4: Template Instantiation (æ¨¡æ¿å®ä¾‹åŒ–)                â”‚
â”‚ Actor: CloudTemplateLoader.processVectorCollection()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 5: Runtime Processing (è¿è¡Œæ—¶å¤„ç†)                    â”‚
â”‚ Actor: VectorAutoRebuildService, User                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 6: Update & Rebuild (æ›´æ–°ä¸é‡å»º)                      â”‚
â”‚ Actor: User, Frontend UI                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 7: Cleanup & Deletion (æ¸…ç†ä¸åˆ é™¤)                    â”‚
â”‚ Actor: Workspace Deletion, Vector DB Cleanup                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 1: Template Creation (æ¨¡æ¿åˆ›ä½œ)

### å½“å‰çŠ¶æ€ï¼šâš ï¸ éƒ¨åˆ†å®Œå¤‡

#### å·²å®ç°

âœ… Batch ç±»å‹å®šä¹‰ (`types.ts`)
âœ… æ•°æ®æ ¼å¼è§„èŒƒ (æ–‡æ¡£)

#### ç¼ºå¤±

âŒ **æ¨¡æ¿åˆ›å»ºå·¥å…·/CLI**
âŒ **Batch éªŒè¯å·¥å…·**
âŒ **Schema éªŒè¯**

### å½“å‰å·¥ä½œæµï¼ˆæ‰‹åŠ¨ï¼‰

```bash
# ä½œè€…æ‰‹åŠ¨åˆ›å»º Batch æ–‡ä»¶
cat > templates/my-template/resources/knowledge.json <<EOF
{
  "content": [...],
  "indexing_config": {...}
}
EOF

# âŒ æ²¡æœ‰éªŒè¯å·¥å…·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®
# âŒ æ²¡æœ‰å·¥å…·å¸®åŠ©ç”Ÿæˆ indexing_config
```

### éœ€è¦çš„å·¥å…·

```typescript
// âŒ ç¼ºå¤±ï¼šBatch åˆ›å»ºå·¥å…·
interface BatchCreationTool {
  // 1. ä» CSV/Excel å¯¼å…¥
  importFromCSV(file: File, keyColumn: string, valueColumn: string): Batch;
  
  // 2. äº¤äº’å¼ç”Ÿæˆ indexing_config
  buildIndexingConfig(sampleData: any[]): VectorIndexingConfig;
  
  // 3. éªŒè¯ Batch
  validateBatch(batch: Batch): ValidationResult;
  
  // 4. é¢„è§ˆ entries
  previewEntries(batch: Batch): VectorEntry[];
}
```

---

## Phase 2: Template Storage (æ¨¡æ¿å­˜å‚¨)

### å½“å‰çŠ¶æ€ï¼šâœ… å®Œå¤‡

#### å·²å®ç°

âœ… Batch å­˜å‚¨ä¸º JSON æ–‡ä»¶
âœ… Git ç‰ˆæœ¬æ§åˆ¶
âœ… æ–‡ä»¶å‘½åçº¦å®š
âœ… ç›®å½•ç»“æ„è§„èŒƒ

### å­˜å‚¨ç»“æ„

```
templates/
  agentic-rag/
    package.json               # âœ… æ¨¡æ¿å®šä¹‰
    resources/
      faq-vector-kb.json      # âœ… Batch æ–‡ä»¶
      web-content.txt         # âœ… å…¶ä»–èµ„æº
```

### éªŒè¯

```json
// âœ… package.json ä¸­æ­£ç¡®å¼•ç”¨
{
  "resources": {
    "resources": [
      {
        "id": "faq-vector-kb",
        "type": "vector_collection",
        "source": {
          "path": "resources/faq-vector-kb.json",
          "format": "structured"
        }
      }
    ]
  }
}
```

---

## Phase 3: Template Loading (æ¨¡æ¿åŠ è½½)

### å½“å‰çŠ¶æ€ï¼šâœ… å®Œå¤‡

#### å·²å®ç° (`cloud.ts:196-210`)

```typescript
// âœ… è¯»å–èµ„æºæ–‡ä»¶
const resourceContent = await fs.readFile(resourcePath, 'utf-8');

// âœ… Parse if structured
let parsedContent: any;
if (resource.source.format === 'structured') {
  parsedContent = JSON.parse(resourceContent);
}
```

#### éªŒè¯ç‚¹

âœ… æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
âœ… JSON è§£æé”™è¯¯å¤„ç†
âœ… æ ¼å¼ç±»å‹æ£€æŸ¥

---

## Phase 4: Template Instantiation (æ¨¡æ¿å®ä¾‹åŒ–)

### å½“å‰çŠ¶æ€ï¼šâœ… åŸºæœ¬å®Œå¤‡ï¼Œâš ï¸ éœ€è¦å¢å¼º

#### å·²å®ç° (`cloud.ts:325-480`)

```typescript
// âœ… Batch ç±»å‹éªŒè¯
if (!isBatch(parsedContent)) {
  throw new Error('Invalid Batch format');
}

// âœ… å†…å®¹æ³¨å…¥
const batch = parsedContent as Batch;
this.updateWorkflowReference(
  workflow,
  block.id,
  resource.mounted_paths.content,
  batch.content  // âœ… åªæ³¨å…¥ content
);

// âœ… Indexing config æ³¨å…¥
block.data.indexingList[0] = {
  type: 'vector',
  entries: [],  // âœ… åˆå§‹ä¸ºç©º
  status: 'notStarted',
  key_path: batch.indexing_config.key_path,      // âœ… ä» Batch å¤åˆ¶
  value_path: batch.indexing_config.value_path,  // âœ… ä» Batch å¤åˆ¶
  // ...
};
```

#### éªŒè¯ç‚¹

âœ… Batch ç»“æ„éªŒè¯ï¼ˆisBatchï¼‰
âœ… Content æ•°ç»„éªŒè¯
âœ… indexing_config å¯¹è±¡éªŒè¯
âœ… æ•°æ®éš”ç¦»ï¼ˆcontent å’Œ config åˆ†å¼€å­˜å‚¨ï¼‰

#### æ½œåœ¨é—®é¢˜

âš ï¸ **External Storage æ—¶çš„ Batch å¤„ç†**

```typescript
// â“ å¦‚æœ Batch æ–‡ä»¶ > 1MBï¼Œä¼šèµ° external storage
if (isExternal) {
  const resourceKey = await this.uploadWithPartitioning(
    resourceContent,  // âŒ ä¸Šä¼ æ•´ä¸ª JSON string
    resource.source.format,
    targetKey,
    userId
  );
  // â“ é—®é¢˜ï¼šä¸Šä¼ çš„æ˜¯å®Œæ•´çš„ Batch JSONï¼Œè¿˜æ˜¯åªæ˜¯ contentï¼Ÿ
  // â“ é—®é¢˜ï¼šindexing_config å¦‚ä½•å¤„ç†ï¼Ÿ
}
```

**å½“å‰å®ç°çš„é—®é¢˜**ï¼š

1. å¦‚æœ Batch æ–‡ä»¶ > 1MBï¼Œä¼šä¸Šä¼ æ•´ä¸ª JSON
2. ä½†æ˜¯ `indexing_config` åº”è¯¥å§‹ç»ˆåœ¨ workflow JSON ä¸­ï¼ˆä¸åº”è¯¥ä¸Šä¼ åˆ° storageï¼‰
3. å¯èƒ½å¯¼è‡´ `indexing_config` ä¸¢å¤±

#### éœ€è¦ä¿®å¤

```typescript
// âœ… ä¿®å¤æ–¹æ¡ˆï¼šExternal storage æ—¶åˆ†ç¦»å¤„ç†
if (isExternal) {
  // 1. åªä¸Šä¼  content éƒ¨åˆ†
  const contentOnly = JSON.stringify(batch.content);
  const resourceKey = await this.uploadWithPartitioning(
    contentOnly,  // âœ… åªä¸Šä¼  content
    'structured',
    targetKey,
    userId
  );
  
  // 2. indexing_config ä»ç„¶å­˜å‚¨åœ¨ workflow JSON ä¸­
  block.data.indexingList[0].key_path = batch.indexing_config.key_path;
  block.data.indexingList[0].value_path = batch.indexing_config.value_path;
}
```

---

## Phase 5: Runtime Processing (è¿è¡Œæ—¶å¤„ç†)

### å½“å‰çŠ¶æ€ï¼šâœ… å®Œå¤‡

#### 5.1 Auto-Rebuild (ç”Ÿæˆ Entries)

âœ… **å·²å®ç°** (`vector-auto-rebuild.ts:71-185`)

```typescript
// âœ… ä» Batch æå– entries
const indexingConfig = batch.indexing_config;
entries = VectorIndexing.extractEntries(batch.content, indexingConfig);

// âœ… è¿”å›ç»“æœ
return {
  success: true,
  status: 'prepared',
  entries,
  collectionName,
  model: compatibility.suggestedModel,
};
```

#### 5.2 Auto-Embedding (ç”Ÿæˆ Vectors)

âœ… **å·²å®ç°** (`cloud.ts:430-465`)

```typescript
// âœ… è°ƒç”¨ embedding API
const embeddingResult = await this.callEmbeddingAPI(
  userId,
  block.id,
  rebuildResult.entries  // âœ… ä½¿ç”¨ç”Ÿæˆçš„ entries
);

// âœ… æ›´æ–°çŠ¶æ€
indexingItem.status = 'done';
indexingItem.index_name = embeddingResult.collection_name;
indexingItem.collection_configs = {
  set_name: embeddingResult.set_name,
  model: 'text-embedding-ada-002',
  vdb_type: 'pgvector',
  user_id: userId,
  collection_name: embeddingResult.collection_name,
};
```

#### éªŒè¯ç‚¹

âœ… Entries ç”Ÿæˆæ­£ç¡®
âœ… Embedding API è°ƒç”¨
âœ… çŠ¶æ€æ›´æ–°
âœ… Error handling

---

## Phase 6: Update & Rebuild (æ›´æ–°ä¸é‡å»º)

### å½“å‰çŠ¶æ€ï¼šâš ï¸ éƒ¨åˆ†å®Œå¤‡

#### 6.1 ç”¨æˆ·ä¿®æ”¹ Content

âœ… **å‰ç«¯æ”¯æŒ**ï¼ˆç”¨æˆ·å¯ä»¥åœ¨ UI ä¸­ä¿®æ”¹ `block.data.content`ï¼‰

#### 6.2 é‡æ–°ç”Ÿæˆ Entries

âš ï¸ **éƒ¨åˆ†å®ç°**

```typescript
// âœ… å‰ç«¯æœ‰ "é‡æ–°æ„å»ºç´¢å¼•" æŒ‰é’®
// âœ… useIndexingUtils.handleAddIndex() å¯ä»¥é‡æ–°ç”Ÿæˆ

// â“ é—®é¢˜ï¼šä¿®æ”¹ content åï¼Œæ˜¯å¦è‡ªåŠ¨æç¤ºç”¨æˆ·é‡å»ºï¼Ÿ
// â“ é—®é¢˜ï¼šindexing_config æ˜¯å¦å¯ä»¥ä¿®æ”¹ï¼Ÿ
```

#### éœ€è¦çš„åŠŸèƒ½

```typescript
// âŒ ç¼ºå¤±ï¼šContent å˜æ›´æ£€æµ‹
interface ContentChangeDetection {
  // æ£€æµ‹ content æ˜¯å¦è¢«ä¿®æ”¹
  detectContentChange(
    oldContent: any[],
    newContent: any[]
  ): boolean;
  
  // æç¤ºç”¨æˆ·é‡å»ºç´¢å¼•
  promptRebuild(): void;
  
  // è‡ªåŠ¨é‡å»ºï¼ˆå¯é€‰ï¼‰
  autoRebuild(block: Block): Promise<void>;
}
```

#### 6.3 Indexing Config æ›´æ–°

âŒ **æœªå®ç°**

```typescript
// âŒ ç¼ºå¤±ï¼šç”¨æˆ·æ— æ³•ä¿®æ”¹ indexing_config
// å¦‚æœç”¨æˆ·æƒ³æ”¹å˜æå–è§„åˆ™ï¼ˆæ¯”å¦‚ä» "question" æ”¹ä¸º "title"ï¼‰ï¼Œ
// ç›®å‰æ²¡æœ‰ UI æ”¯æŒ
```

---

## Phase 7: Cleanup & Deletion (æ¸…ç†ä¸åˆ é™¤)

### å½“å‰çŠ¶æ€ï¼šâš ï¸ éƒ¨åˆ†å®Œå¤‡

#### 7.1 Workspace åˆ é™¤

âœ… **å·²å®ç°**ï¼ˆåˆ é™¤å·¥ä½œåŒºæ—¶ä¼šæ¸…ç† workflow JSONï¼‰

#### 7.2 Vector Collection åˆ é™¤

âš ï¸ **éƒ¨åˆ†å®ç°**

```typescript
// âœ… å‰ç«¯æœ‰åˆ é™¤ç´¢å¼•çš„åŠŸèƒ½ (useIndexingUtils.handleDeleteIndex)
// âœ… è°ƒç”¨ /api/storage/vector/delete

// â“ é—®é¢˜ï¼šåˆ é™¤ç´¢å¼•åï¼Œcontent å’Œ indexing_config æ˜¯å¦ä¿ç•™ï¼Ÿ
// âœ… ç­”æ¡ˆï¼šåº”è¯¥ä¿ç•™ï¼ˆç”¨æˆ·å¯ä»¥é‡æ–°æ„å»ºï¼‰
```

#### 7.3 External Storage æ¸…ç†

âŒ **æœªå®ç°**

```typescript
// âŒ ç¼ºå¤±ï¼šåˆ é™¤å·¥ä½œåŒºæ—¶ï¼Œexternal storage çš„ content æ˜¯å¦æ¸…ç†ï¼Ÿ
// âŒ ç¼ºå¤±ï¼šæ˜¯å¦æœ‰ orphaned resources æ£€æµ‹ï¼Ÿ
```

---

## å®Œå¤‡æ€§æ€»ç»“

| Phase | çŠ¶æ€ | å®Œå¤‡åº¦ | ç¼ºå¤±åŠŸèƒ½ |
|-------|------|--------|----------|
| 1. Template Creation | âš ï¸ | 40% | CLI å·¥å…·ã€éªŒè¯å·¥å…· |
| 2. Template Storage | âœ… | 100% | - |
| 3. Template Loading | âœ… | 100% | - |
| 4. Instantiation | âš ï¸ | 85% | External storage æ—¶çš„ Batch åˆ†ç¦» |
| 5. Runtime Processing | âœ… | 100% | - |
| 6. Update & Rebuild | âš ï¸ | 60% | å˜æ›´æ£€æµ‹ã€indexing_config ä¿®æ”¹ |
| 7. Cleanup | âš ï¸ | 70% | External storage æ¸…ç† |

**æ€»ä½“å®Œå¤‡åº¦**: ~75%

---

## å…³é”®ç¼ºå¤±åŠŸèƒ½æ¸…å•

### ğŸ”´ High Priority (å½±å“æ ¸å¿ƒåŠŸèƒ½)

1. **Phase 4: External Storage æ—¶çš„ Batch åˆ†ç¦»**
   - é—®é¢˜ï¼šå¤§æ–‡ä»¶æ—¶ indexing_config å¯èƒ½ä¸¢å¤±
   - å½±å“ï¼šæ— æ³•é‡å»ºç´¢å¼•
   - ä¿®å¤éš¾åº¦ï¼šä¸­

2. **Phase 6: Content å˜æ›´æ£€æµ‹**
   - é—®é¢˜ï¼šç”¨æˆ·ä¿®æ”¹ content åä¸çŸ¥é“éœ€è¦é‡å»º
   - å½±å“ï¼šæ•°æ®ä¸ä¸€è‡´
   - ä¿®å¤éš¾åº¦ï¼šä½

### ğŸŸ¡ Medium Priority (å½±å“ç”¨æˆ·ä½“éªŒ)

3. **Phase 1: Batch åˆ›å»ºå·¥å…·**
   - é—®é¢˜ï¼šä½œè€…éœ€è¦æ‰‹åŠ¨ç¼–å†™ JSON
   - å½±å“ï¼šæ¨¡æ¿åˆ›å»ºæˆæœ¬é«˜
   - ä¿®å¤éš¾åº¦ï¼šé«˜

4. **Phase 6: Indexing Config ä¿®æ”¹**
   - é—®é¢˜ï¼šç”¨æˆ·æ— æ³•ä¿®æ”¹æå–è§„åˆ™
   - å½±å“ï¼šçµæ´»æ€§å·®
   - ä¿®å¤éš¾åº¦ï¼šä¸­

### ğŸŸ¢ Low Priority (ä¼˜åŒ–æ€§)

5. **Phase 7: External Storage æ¸…ç†**
   - é—®é¢˜ï¼šå¯èƒ½æ®‹ç•™ orphaned resources
   - å½±å“ï¼šå­˜å‚¨æµªè´¹
   - ä¿®å¤éš¾åº¦ï¼šä¸­

6. **Phase 1: Batch éªŒè¯å·¥å…·**
   - é—®é¢˜ï¼šæ— æ³•æå‰éªŒè¯ Batch æ ¼å¼
   - å½±å“ï¼šè¿è¡Œæ—¶æ‰å‘ç°é”™è¯¯
   - ä¿®å¤éš¾åº¦ï¼šä½

---

## æ¨èä¿®å¤é¡ºåº

### Milestone 1: æ ¸å¿ƒåŠŸèƒ½å®Œå¤‡ï¼ˆç«‹å³ä¿®å¤ï¼‰

1. âœ… Phase 4: External Storage Batch åˆ†ç¦»å¤„ç†
2. âœ… Phase 6: Content å˜æ›´æ£€æµ‹ + UI æç¤º

### Milestone 2: ç”¨æˆ·ä½“éªŒæå‡ï¼ˆçŸ­æœŸï¼‰

3. Phase 1: åŸºç¡€ Batch éªŒè¯å·¥å…·ï¼ˆCLIï¼‰
4. Phase 6: Indexing Config æŸ¥çœ‹/ç¼–è¾‘ UI

### Milestone 3: å·¥å…·é“¾å®Œå–„ï¼ˆä¸­æœŸï¼‰

5. Phase 1: å¯è§†åŒ– Batch åˆ›å»ºå·¥å…·
6. Phase 7: External Storage æ¸…ç†æœºåˆ¶

---

## è¯¦ç»†ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: External Storage Batch åˆ†ç¦»

**é—®é¢˜å®šä½**: `cloud.ts:340-354`

```typescript
// âŒ å½“å‰å®ç°ï¼šä¸Šä¼ æ•´ä¸ª Batch
if (isExternal) {
  const resourceKey = await this.uploadWithPartitioning(
    resourceContent,  // åŒ…å« {content, indexing_config}
    resource.source.format,
    targetKey,
    userId
  );
}
```

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// âœ… ä¿®å¤ï¼šåˆ†ç¦» content å’Œ indexing_config
if (isExternal) {
  const batch = parsedContent as Batch;
  
  // 1. åªä¸Šä¼  content éƒ¨åˆ†
  const contentOnly = JSON.stringify(batch.content);
  const resourceKey = await this.uploadWithPartitioning(
    contentOnly,
    'structured',
    targetKey,
    userId
  );
  
  // 2. è®¾ç½® external storage metadata
  block.data.external_metadata = {
    resource_key: resourceKey
  };
  block.data.storage_class = 'external';
  
  // 3. indexing_config å­˜å‚¨åœ¨ workflow JSON ä¸­ï¼ˆä¸ä¸Šä¼ ï¼‰
  block.data.indexingList[0] = {
    type: 'vector',
    entries: [],
    status: 'notStarted',
    key_path: batch.indexing_config.key_path,      // âœ… ä¿ç•™åœ¨ workflow
    value_path: batch.indexing_config.value_path,  // âœ… ä¿ç•™åœ¨ workflow
    // ...
  };
}
```

### ä¿®å¤ 2: Content å˜æ›´æ£€æµ‹

**æ–°å¢æ–‡ä»¶**: `PuppyFlow/lib/batch/change-detection.ts`

```typescript
/**
 * Batch Content Change Detection
 */
export class BatchChangeDetection {
  /**
   * Detect if content has been modified
   */
  static hasContentChanged(
    originalContent: any[],
    currentContent: any[]
  ): boolean {
    // Simple comparison: length and JSON stringify
    if (originalContent.length !== currentContent.length) {
      return true;
    }
    
    return JSON.stringify(originalContent) !== JSON.stringify(currentContent);
  }
  
  /**
   * Check if entries need to be rebuilt
   */
  static needsRebuild(
    block: any
  ): {
    needsRebuild: boolean;
    reason?: string;
  } {
    const indexingList = block.data.indexingList || [];
    
    if (indexingList.length === 0) {
      return { needsRebuild: false };
    }
    
    const indexingItem = indexingList[0];
    
    // Case 1: No entries yet
    if (!indexingItem.entries || indexingItem.entries.length === 0) {
      return {
        needsRebuild: true,
        reason: 'No entries generated yet'
      };
    }
    
    // Case 2: Content count mismatch
    const contentLength = block.data.content?.length || 0;
    const entriesLength = indexingItem.entries.length;
    
    if (contentLength !== entriesLength) {
      return {
        needsRebuild: true,
        reason: `Content has ${contentLength} items but entries has ${entriesLength}`
      };
    }
    
    // Case 3: Status is error
    if (indexingItem.status === 'error') {
      return {
        needsRebuild: true,
        reason: 'Previous build failed'
      };
    }
    
    return { needsRebuild: false };
  }
}
```

**å‰ç«¯é›†æˆ**: åœ¨ Structure Block ç¼–è¾‘æ—¶æ˜¾ç¤ºæç¤º

```typescript
// åœ¨ StructureBlock UI ä¸­
const rebuildStatus = BatchChangeDetection.needsRebuild(block);

if (rebuildStatus.needsRebuild) {
  return (
    <Alert severity="warning">
      {rebuildStatus.reason}
      <Button onClick={handleRebuild}>é‡å»ºç´¢å¼•</Button>
    </Alert>
  );
}
```

---

## ç»“è®º

### å½“å‰çŠ¶æ€

âœ… **æ ¸å¿ƒæµç¨‹å®Œå¤‡**ï¼šä»æ¨¡æ¿åŠ è½½ â†’ å®ä¾‹åŒ– â†’ è¿è¡Œæ—¶å¤„ç†ï¼Œä¸»æµç¨‹å·²ç»å®Œæ•´å®ç°

âš ï¸ **è¾¹ç•Œåœºæ™¯ä¸å®Œå–„**ï¼š

- External storage æ—¶çš„ Batch å¤„ç†æœ‰éšæ‚£
- ç”¨æˆ·ä¿®æ”¹ content åç¼ºå°‘æç¤º
- ç¼ºå°‘æ¨¡æ¿åˆ›ä½œå·¥å…·

### å»ºè®®

1. **ç«‹å³ä¿®å¤**: External Storage Batch åˆ†ç¦»ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰
2. **çŸ­æœŸä¼˜åŒ–**: æ·»åŠ å˜æ›´æ£€æµ‹å’Œ UI æç¤ºï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰
3. **ä¸­æœŸå®Œå–„**: å¼€å‘æ¨¡æ¿åˆ›ä½œå·¥å…·é“¾ï¼ˆé™ä½åˆ›ä½œæˆæœ¬ï¼‰

**ä¼˜å…ˆçº§**: æ ¸å¿ƒåŠŸèƒ½ç¨³å®šæ€§ > ç”¨æˆ·ä½“éªŒ > å·¥å…·é“¾å®Œå–„
