ContextBase æ¨¡å—åŒ–æ¶æ„è®¾è®¡

> ç§¯æœ¨å¼æ‹†åˆ†ï¼šæ¯å—ç‹¬ç«‹å¯ç”¨ï¼Œæ‹¼èµ·æ¥æ˜¯å®Œæ•´äº§å“ã€‚

---

## ä¸€ã€ä¸ºä»€ä¹ˆè¦åšç§¯æœ¨å¼æ‹†åˆ†

### 1.1 é—®é¢˜ï¼šAgent ç”Ÿæ€ç¢ç‰‡åŒ–

Agent çš„è¿è¡Œç¯å¢ƒæ²¡æœ‰ç»Ÿä¸€æ ‡å‡†ã€‚ä¸åŒç”¨æˆ·ã€ä¸åŒæ¡†æ¶ã€ä¸åŒéƒ¨ç½²æ–¹å¼ä¸‹ï¼Œå¯¹"æ•°æ®æ€ä¹ˆç»™ Agent ç”¨"çš„éœ€æ±‚å®Œå…¨ä¸åŒï¼š

| ç”¨æˆ·åœºæ™¯ | Agent åœ¨å“ªé‡Œè·‘ | æ€ä¹ˆè®¿é—®æ•°æ® | æœ‰æ²¡æœ‰æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ | éœ€è¦æˆ‘ä»¬ç®¡æ²™ç›’å— |
|---------|--------------|------------|------------------|----------------|
| ç”¨æˆ‘ä»¬çš„ CloudBot | æˆ‘ä»¬çš„ Docker | æœ¬åœ°æ–‡ä»¶å¤¹ | æœ‰ï¼ˆå®¹å™¨å†…ï¼‰ | éœ€è¦ |
| OpenClaw on Mac mini | ç”¨æˆ·çš„ Docker | æœ¬åœ°æ–‡ä»¶å¤¹ | æœ‰ï¼ˆå®¿ä¸»æœºï¼‰ | ä¸éœ€è¦ |
| Claude Code on Mac | æ— æ²™ç›’ï¼ˆç”¨æˆ·è¿›ç¨‹ï¼‰ | æœ¬åœ°æ–‡ä»¶å¤¹ | æœ‰ï¼ˆé¡¹ç›®ç›®å½•ï¼‰ | ä¸éœ€è¦ |
| Cursor on Mac | æ— æ²™ç›’ï¼ˆç”¨æˆ·è¿›ç¨‹ï¼‰ | æœ¬åœ°æ–‡ä»¶å¤¹ | æœ‰ï¼ˆé¡¹ç›®ç›®å½•ï¼‰ | ä¸éœ€è¦ |
| n8n on VM | n8n è¿›ç¨‹ | REST API | ä¸éœ€è¦ | ä¸éœ€è¦ |
| Manusï¼ˆäº‘ç«¯ï¼‰ | Manus è‡ªå·±çš„æ²™ç›’ | REST API | ä¸éœ€è¦ | ä¸éœ€è¦ |
| AWS Lambda | Lambda ä¸´æ—¶ç¯å¢ƒ | REST API / SDK | æ— æŒä¹…æ–‡ä»¶ç³»ç»Ÿ | ä¸éœ€è¦ |
| è‡ªå®šä¹‰ Python Agent | ç”¨æˆ·è¿›ç¨‹ | æ–‡ä»¶å¤¹ æˆ– SDK | å¯é€‰ | ä¸éœ€è¦ |
| Railway + OpenClaw | Railway å®¹å™¨ | å®¹å™¨å†…æ–‡ä»¶å¤¹ï¼ˆä¸´æ—¶ï¼‰ | æœ‰ï¼ˆä½†ä¼šè¢«é”€æ¯ï¼‰ | ä¸éœ€è¦ |
| EC2 + 100 ä¸ª Agent | VM ä¸Šçš„ Docker | æœ¬åœ°æ–‡ä»¶å¤¹ | æœ‰ | ä¸éœ€è¦ |

å¦‚æœæˆ‘ä»¬æŠŠæ‰€æœ‰åŠŸèƒ½å†™æˆä¸€ä¸ªæ•´ä½“ï¼ˆåƒå½“å‰çš„ `AgentService`ï¼‰ï¼Œè¦ä¹ˆç»™æ¯ç§åœºæ™¯å†™ä¸€å¥—ç‰¹æ®Šé€»è¾‘ï¼Œè¦ä¹ˆå¼ºè¿«æ‰€æœ‰ç”¨æˆ·èµ°åŒä¸€æ¡è·¯å¾„ã€‚ä¸¤è€…éƒ½ä¸å¯æŒç»­ã€‚

### 1.2 è§£æ³•ï¼šç§¯æœ¨å¼æ¶æ„

æŠŠäº§å“æ‹†æˆ **5 å—ç‹¬ç«‹ç§¯æœ¨**ï¼ˆL1 / L2 / L2.5 / L3 / L4ï¼‰ï¼Œæ¯å—æœ‰æ¸…æ™°çš„èŒè´£è¾¹ç•Œå’Œæ¥å£å¥‘çº¦ã€‚

- **å†…ç½® CloudBot**ï¼šæ‹¼å…¨å¥—ç§¯æœ¨ â†’ å®Œæ•´ä½“éªŒ
- **å¤–éƒ¨ API æ¥å…¥**ï¼šåªç”¨ L1 + L2 + L3-API â†’ æœ€ç²¾ç®€
- **æœ¬åœ° Daemon æ¨¡å¼**ï¼šç”¨ L1 + L2 + L2.5 + L3-Folder â†’ æ–‡ä»¶çº§ä½“éªŒ
- **SDK æ¨¡å¼**ï¼šç”¨ L1 + L2 + L3-SDK â†’ å¼€å‘è€…å‹å¥½

**æ ¸å¿ƒåŸåˆ™**ï¼šæ¯å—ç§¯æœ¨ç‹¬ç«‹å¯ç”¨ã€æ¥å£ç¨³å®šã€æ— ç¯ä¾èµ–ã€‚æ‹¼åœ¨ä¸€èµ·èƒ½å·¥ä½œï¼Œæ‹†å¼€æ¥ä¹Ÿèƒ½å·¥ä½œã€‚

### 1.3 ä¸å˜é‡

æ— è®ºå“ªç§åœºæ™¯ï¼Œæœ‰ä¸‰ä»¶äº‹æ°¸è¿œä¸å˜ï¼š

1. **æ•°æ®åªæœ‰ä¸€ä»½çœŸç›¸æº**ï¼šS3ï¼ˆæ–‡ä»¶å†…å®¹ï¼‰+ PGï¼ˆå…ƒæ•°æ®ï¼‰ï¼Œåœ¨äº‘ç«¯
2. **ååŒé€»è¾‘åœ¨äº‘ç«¯**ï¼šç‰ˆæœ¬ç®¡ç†ã€å†²çªè§£å†³ã€æƒé™æ§åˆ¶ï¼Œåœ¨äº‘ç«¯ç»Ÿä¸€æ‰§è¡Œ
3. **æ¥å£å±‚å¯æ›¿æ¢**ï¼šç»™ Agent æä¾›æ•°æ®çš„æ–¹å¼ï¼ˆæ–‡ä»¶å¤¹ / API / SDKï¼‰æ˜¯å¯æ’æ‹”çš„

---

## äºŒã€åˆ†å±‚æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ L4: Sandbox æ²™ç›’å±‚ï¼ˆå¯é€‰ç§¯æœ¨ï¼‰                              â”‚  â”‚
â”‚  â”‚ Agent åœ¨å“ªé‡Œè¿è¡Œ                                           â”‚  â”‚
â”‚  â”‚ Docker å®¹å™¨ / E2B äº‘æ²™ç›’ / æ— æ²™ç›’ï¼ˆç”¨æˆ·è¿›ç¨‹ï¼‰               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ L3: Interface æ¥å£å±‚ï¼ˆä¸‰ç§å½¢æ€ï¼ŒæŒ‰éœ€é€‰æ‹©ï¼‰                    â”‚  â”‚
â”‚  â”‚ Agent / å·¥å…·é€šè¿‡ä»€ä¹ˆæ–¹å¼è¯»å†™æ•°æ®                              â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ L3-API   â”‚    â”‚ L3-Folder â”‚    â”‚ L3-SDK           â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ RESTæ¥å£  â”‚    â”‚ æœ¬åœ°æ–‡ä»¶å¤¹ â”‚    â”‚ Python/JS/Go åŒ…  â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚       â”‚                â”‚                    â”‚              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                â”‚                    â”‚                 â”‚
â”‚          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”             â”‚                 â”‚
â”‚          â”‚         â”‚ L2.5: Sync  â”‚             â”‚                 â”‚
â”‚          â”‚         â”‚ åŒæ­¥ç¼“å­˜å±‚   â”‚             â”‚                 â”‚
â”‚          â”‚         â”‚ (å¯é€‰ç§¯æœ¨)   â”‚             â”‚                 â”‚
â”‚          â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚                 â”‚
â”‚          â”‚                â”‚                    â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ L2: Collaboration ååŒå±‚ï¼ˆæ ¸å¿ƒç§¯æœ¨ï¼Œå¿…é€‰ï¼‰                    â”‚  â”‚
â”‚  â”‚ æƒé™ â”‚ ç‰ˆæœ¬ç®¡ç† â”‚ å†²çªè§£å†³ â”‚ ä¹è§‚é” â”‚ å®¡è®¡æ—¥å¿—               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ L1: Storage å­˜å‚¨å±‚ï¼ˆåŸºç¡€ç§¯æœ¨ï¼Œå¿…é€‰ï¼‰                         â”‚  â”‚
â”‚  â”‚ S3ï¼ˆæ–‡ä»¶å†…å®¹ï¼‰ â”‚ PGï¼ˆå…ƒæ•°æ®ã€ç‰ˆæœ¬é“¾ã€æƒé™è¡¨ï¼‰                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµå‘è§„åˆ™**ï¼š

- L3-API å’Œ L3-SDK **ç›´è¿** L2ï¼ˆæ— éœ€ L2.5ï¼‰
- L3-Folder **å¿…é¡»ç»è¿‡** L2.5ï¼ˆéœ€è¦æœ¬åœ°ç¼“å­˜å’ŒåŒæ­¥ï¼‰
- L4 é€šè¿‡ L3 è®¿é—®æ•°æ®ï¼ˆä¸ç›´æ¥è®¿é—® L2ï¼‰
- æ‰€æœ‰å†™æ“ä½œ**æœ€ç»ˆéƒ½ç»è¿‡** L2ï¼ˆååŒå±‚æ˜¯å”¯ä¸€çš„å†™å…¥ç½‘å…³ï¼‰

---

## ä¸‰ã€åœºæ™¯ç©·ä¸¾ä¸ç§¯æœ¨æ˜ å°„

### åœºæ™¯ 1ï¼šå†…ç½® CloudBotï¼ˆå…¨æ ˆæ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šåœ¨ ContextBase å¹³å°ä¸Šç›´æ¥ä½¿ç”¨ AI Agent å¯¹è¯ã€ç¼–è¾‘æ•°æ®ã€‚

```
ç”¨æˆ· â†’ å‰ç«¯ â†’ AgentOrchestrator
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ L4      â”‚ â”‚ L2.5  â”‚ â”‚ L3   â”‚ â”‚ L2         â”‚ â”‚
    â”‚ Docker  â”‚ â”‚ Sync  â”‚ â”‚Folderâ”‚ â”‚ Collab     â”‚ â”‚
    â”‚ æ²™ç›’    â”‚ â”‚ åŒæ­¥   â”‚ â”‚      â”‚ â”‚ ç‰ˆæœ¬+å†²çª  â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”‚          â”‚         â”‚          â”‚         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                    â”‚              â”‚
                              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”‚
                              â”‚ L1        â”‚        â”‚
                              â”‚ S3 + PG   â”‚        â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨ç§¯æœ¨**ï¼šL1 + L2 + L2.5 + L3-Folder + L4ï¼ˆå…¨å¥—ï¼‰

**æ•°æ®æµ**ï¼š
1. `L2.checkout()` â†’ è·å–æ•°æ® + base_version
2. `L2.5.provision()` â†’ åŒæ­¥åˆ°æœ¬åœ°å·¥ä½œåŒº
3. `L4.create()` + `L4.mount()` â†’ åˆ›å»ºæ²™ç›’ï¼ŒæŒ‚è½½å·¥ä½œåŒº
4. `L4.exec()` â†’ Agent åœ¨æ²™ç›’ä¸­æ‰§è¡Œå‘½ä»¤
5. `L2.5.collect_changes()` â†’ æ£€æµ‹æ”¹åŠ¨
6. `L2.commit()` â†’ å†²çªè§£å†³ + å†™å›
7. `L4.destroy()` â†’ æ¸…ç†

---

### åœºæ™¯ 2ï¼šMac mini + OpenClawï¼ˆæœ¬åœ° Daemon æ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šåœ¨å®¶é‡Œçš„ Mac mini ä¸Šè·‘ OpenClawï¼Œæœ‰ 3 ä¸ª Agentã€‚

```
         Mac mini                                    äº‘ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            â”‚              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚              â”‚
â”‚  â”‚ L4: OpenClaw çš„ Dockerâ”‚  â”‚              â”‚              â”‚
â”‚  â”‚ (ä¸æ˜¯æˆ‘ä»¬çš„ç§¯æœ¨)       â”‚  â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚              â”‚
â”‚             â”‚ è¯»å†™æ–‡ä»¶       â”‚              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚              â”‚
â”‚  â”‚ L3-Folder: æœ¬åœ°æ–‡ä»¶å¤¹ â”‚  â”‚              â”‚              â”‚
â”‚  â”‚ Agent A â”‚ B â”‚ C å„ä¸€ä¸ª â”‚  â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚              â”‚
â”‚             â”‚ watch         â”‚              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    REST      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ L2.5: SyncDaemon     â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ â”‚ L2       â”‚ â”‚
â”‚  â”‚ æœ¬åœ°ç¼“å­˜ + åŒå‘åŒæ­¥    â”‚  â”‚             â”‚ â”‚ Collab   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚              â”‚      â”‚       â”‚
â”‚                            â”‚              â”‚ â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚
â”‚                            â”‚              â”‚ â”‚ L1       â”‚ â”‚
â”‚                            â”‚              â”‚ â”‚ S3 + PG  â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”˜
```

**ä½¿ç”¨æˆ‘ä»¬çš„ç§¯æœ¨**ï¼šL1 + L2 + L2.5 + L3-Folder
**ä¸ä½¿ç”¨**ï¼šL4ï¼ˆOpenClaw è‡ªå·±ç®¡æ²™ç›’ï¼‰

**æ•°æ®æµ**ï¼š
1. `L2.5.SyncDaemon` å¯åŠ¨ï¼Œä» L2 æ‹‰å–æ•°æ®åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
2. OpenClaw çš„ Agent åœ¨å„è‡ª Docker å†…è¯»å†™å„è‡ªçš„æ–‡ä»¶å¤¹
3. `L2.5.FileWatcher` æ£€æµ‹æ–‡ä»¶å˜æ›´
4. å˜æ›´é€šè¿‡ `L2.commit()` å†™å›äº‘ç«¯ï¼ˆå«å†²çªè§£å†³ï¼‰

**å…³é”®éœ€æ±‚**ï¼š
- SyncDaemon ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œï¼ˆä¸ä¾èµ–ä»»ä½• Agent æ¡†æ¶ï¼‰
- æ”¯æŒå¤šä¸ª Agent å„è‡ªç‹¬ç«‹çš„å·¥ä½œç›®å½•
- WorkspaceProvider å¯é€‰ APFS Clone ä¼˜åŒ–ï¼ˆå¤š Agent å…±äº«æ•°æ®æ—¶çœå­˜å‚¨ï¼‰

---

### åœºæ™¯ 3ï¼šEC2 + OpenClawï¼ˆå¤§è§„æ¨¡æœ¬åœ° Daemon æ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šåœ¨ AWS EC2 ä¸Šè·‘ OpenClawï¼Œ100 ä¸ª Agent å…±äº« 500MB æ•°æ®ã€‚

**ä¸åœºæ™¯ 2 çš„åŒºåˆ«**ï¼š
- Linux ç³»ç»Ÿ â†’ WorkspaceProvider å¯ä½¿ç”¨ OverlayFS
- Agent æ•°é‡å¤š â†’ L2.5 çš„å­˜å‚¨ä¼˜åŒ–ä»"å¯é€‰"å˜ä¸º"å¿…è¦"

```
æ—  OverlayFSï¼š100 ä¸ª Agent Ã— 500MB = 50GB æœ¬åœ°å­˜å‚¨
æœ‰ OverlayFSï¼š1 ä»½ Lower (500MB) + 100 ä¸ª Upper (å‡ KB) â‰ˆ 502MB
```

**ä½¿ç”¨ç§¯æœ¨**ï¼šL1 + L2 + L2.5ï¼ˆå« OverlayFS ä¼˜åŒ–ï¼‰ + L3-Folder
**ä¸ä½¿ç”¨**ï¼šL4

---

### åœºæ™¯ 4ï¼šæœ¬åœ° Mac + Claude Code / Cursorï¼ˆæ— æ²™ç›’ Daemon æ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šåœ¨è‡ªå·±çš„ Mac ä¸Šç”¨ Claude Code æˆ– Cursor ç¼–è¾‘é¡¹ç›®ã€‚

```
         ç”¨æˆ·çš„ Mac                                  äº‘ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            â”‚              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚              â”‚
â”‚  â”‚ Claude Code / Cursor  â”‚  â”‚              â”‚              â”‚
â”‚  â”‚ ç›´æ¥è¯»å†™é¡¹ç›®æ–‡ä»¶å¤¹     â”‚  â”‚              â”‚              â”‚
â”‚  â”‚ (æ— æ²™ç›’ï¼Œç”¨æˆ·è¿›ç¨‹)     â”‚  â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚              â”‚
â”‚             â”‚ è¯»å†™æ–‡ä»¶       â”‚              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚              â”‚
â”‚  â”‚ L3-Folder: é¡¹ç›®ç›®å½•   â”‚  â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚              â”‚
â”‚             â”‚ watch         â”‚    REST      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ â”‚ L2+L1    â”‚ â”‚
â”‚  â”‚ L2.5: SyncDaemon     â”‚  â”‚             â”‚ â”‚ Collab   â”‚ â”‚
â”‚  â”‚ (ç±»ä¼¼ Dropbox ä½“éªŒ)   â”‚  â”‚              â”‚ â”‚ + Storageâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨ç§¯æœ¨**ï¼šL1 + L2 + L2.5 + L3-Folder
**ä¸ä½¿ç”¨**ï¼šL4
**å’Œåœºæ™¯ 2 çš„åŒºåˆ«**ï¼šåªæœ‰ 1 ä¸ª Agentï¼ˆä¸éœ€è¦ WorkspaceProvider éš”ç¦»å¤šä¸ªå·¥ä½œåŒºï¼‰

---

### åœºæ™¯ 5ï¼šRailway + OpenClawï¼ˆä¸´æ—¶å®¹å™¨ Daemon æ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šç”¨ Railway éƒ¨ç½² OpenClawï¼Œå¼¹æ€§å®¹å™¨ã€‚

**ä¸åœºæ™¯ 2 çš„åŒºåˆ«**ï¼šå®¹å™¨æ˜¯ä¸´æ—¶çš„ï¼Œéšæ—¶å¯èƒ½è¢«é”€æ¯é‡å»ºã€‚

**å…³é”®éœ€æ±‚**ï¼š
- SyncDaemon å¿…é¡»èƒ½**å†·å¯åŠ¨**ï¼ˆä»é›¶å¿«é€Ÿæ¢å¤æœ¬åœ°ç¼“å­˜ï¼‰
- ä¸èƒ½å‡è®¾æœ¬åœ°æ–‡ä»¶ä¼šæŒä¹…å­˜åœ¨
- å¯åŠ¨é€Ÿåº¦å¾ˆå…³é”®ï¼ˆå½±å“å®¹å™¨å†·å¯åŠ¨æ—¶é—´ï¼‰

**ä½¿ç”¨ç§¯æœ¨**ï¼šL1 + L2 + L2.5ï¼ˆå¼ºè°ƒå†·å¯åŠ¨èƒ½åŠ›ï¼‰ + L3-Folder
**ä¸ä½¿ç”¨**ï¼šL4

---

### åœºæ™¯ 6ï¼šn8n / Zapierï¼ˆçº¯ API æ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šåœ¨ VM ä¸Šè·‘ n8n å·¥ä½œæµï¼Œé€šè¿‡ HTTP Request èŠ‚ç‚¹è¯»å†™æ•°æ®ã€‚

```
         VM                                          äº‘ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        â”‚                  â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     REST API     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ n8n å·¥ä½œæµ        â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ â”‚ L3-API   â”‚ â”‚
â”‚  â”‚ HTTP Request èŠ‚ç‚¹ â”‚  â”‚                 â”‚ â”‚    â”‚      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚ â”‚ L2 Collabâ”‚ â”‚
â”‚                        â”‚                  â”‚ â”‚    â”‚      â”‚ â”‚
â”‚                        â”‚                  â”‚ â”‚ L1 Store â”‚ â”‚
â”‚                        â”‚                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨ç§¯æœ¨**ï¼šL1 + L2 + L3-APIï¼ˆæœ€ç²¾ç®€ï¼‰
**ä¸ä½¿ç”¨**ï¼šL2.5ã€L4
**ç‰¹ç‚¹**ï¼šæ— æœ¬åœ°çŠ¶æ€ï¼Œæ—  Daemonï¼Œçº¯è¯·æ±‚-å“åº”æ¨¡å¼

---

### åœºæ™¯ 7ï¼šManus / äº‘ç«¯ Agent å¹³å°ï¼ˆçº¯ API æ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šManus ç­‰äº‘ç«¯ Agent å¹³å°ï¼ŒAgent åœ¨ä»–ä»¬è‡ªå·±çš„äº‘æ²™ç›’ä¸­è¿è¡Œã€‚

```
         Manus çš„äº‘ç«¯                                æˆ‘ä»¬çš„äº‘ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        â”‚                  â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     REST API     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Manus Agent      â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ â”‚ L3-API   â”‚ â”‚
â”‚  â”‚ (Manus è‡ªå·±çš„æ²™ç›’)â”‚  â”‚                 â”‚ â”‚    â”‚      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚ â”‚ L2 Collabâ”‚ â”‚
â”‚                        â”‚                  â”‚ â”‚    â”‚      â”‚ â”‚
â”‚                        â”‚                  â”‚ â”‚ L1 Store â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨ç§¯æœ¨**ï¼šL1 + L2 + L3-API
**ä¸ä½¿ç”¨**ï¼šL2.5ã€L4
**ä¸åœºæ™¯ 6 ç›¸åŒæ¶æ„**ï¼ŒåŒºåˆ«ä»…åœ¨è°ƒç”¨æ–¹çš„èº«ä»½ã€‚

---

### åœºæ™¯ 8ï¼šAWS Lambda / Serverlessï¼ˆçº¯ API æˆ– SDK æ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šåœ¨ Lambda å‡½æ•°ä¸­è·‘çŸ­æš‚ Agent ä»»åŠ¡ã€‚

```
         Lambdaï¼ˆä¸´æ—¶ç¯å¢ƒï¼‰                           æˆ‘ä»¬çš„äº‘ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        â”‚                  â”‚              â”‚
â”‚  from contextbase      â”‚    SDK æˆ– REST   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    import ContextFS    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ â”‚ L3-SDK   â”‚ â”‚
â”‚                        â”‚                  â”‚ â”‚ æˆ– L3-APIâ”‚ â”‚
â”‚  ctx = ContextFS(...)  â”‚                  â”‚ â”‚    â”‚      â”‚ â”‚
â”‚  data = ctx.read(...)  â”‚                  â”‚ â”‚ L2 Collabâ”‚ â”‚
â”‚  ctx.write(...)        â”‚                  â”‚ â”‚    â”‚      â”‚ â”‚
â”‚                        â”‚                  â”‚ â”‚ L1 Store â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨ç§¯æœ¨**ï¼šL1 + L2 + L3-SDK æˆ– L3-API
**ä¸ä½¿ç”¨**ï¼šL2.5ï¼ˆæ— æŒä¹…æ–‡ä»¶ç³»ç»Ÿï¼‰ã€L4
**å…³é”®éœ€æ±‚**ï¼šSDK ä¸èƒ½æœ‰æœ¬åœ°çŠ¶æ€ï¼ˆLambda æ‰§è¡Œå®Œå°±é”€æ¯ï¼‰

---

### åœºæ™¯ 9ï¼šè‡ªå®šä¹‰ Python / JS Agentï¼ˆSDK æˆ– Daemon æ¨¡å¼ï¼‰

**å…¸å‹ç”¨æˆ·**ï¼šå¼€å‘è€…è‡ªå·±å†™ Agentï¼Œé€‰æœ€åˆé€‚çš„æ¥å…¥æ–¹å¼ã€‚

**æ–¹å¼ A**ï¼šç”¨ SDKï¼ˆå’Œ Lambda ä¸€æ ·ï¼‰

```python
from contextbase import ContextFS

ctx = ContextFS(token="cb_xxx", project="my-project")
config = ctx.read("/shared/config.json")
ctx.write("/reports/output.md", result)
history = ctx.versions("/shared/config.json")
```

**æ–¹å¼ B**ï¼šç”¨æœ¬åœ°æ–‡ä»¶å¤¹ + Daemonï¼ˆå’Œ Claude Code ä¸€æ ·ï¼‰

```bash
# å¯åŠ¨ Daemonï¼ŒåŒæ­¥åˆ°æœ¬åœ°
contextbase sync --project my-project --dir ./workspace

# Agent ç›´æ¥è¯»å†™ ./workspace
python my_agent.py --workspace ./workspace
```

**ä½¿ç”¨ç§¯æœ¨**ï¼š
- æ–¹å¼ Aï¼šL1 + L2 + L3-SDK
- æ–¹å¼ Bï¼šL1 + L2 + L2.5 + L3-Folder

---

### åœºæ™¯æ±‡æ€»çŸ©é˜µ

```
                    â”‚ L1      â”‚ L2       â”‚ L2.5    â”‚ L3          â”‚ L4       â”‚
                    â”‚ Storage â”‚ Collab   â”‚ Sync    â”‚ Interface   â”‚ Sandbox  â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
CloudBot (å†…ç½®)      â”‚ âœ…      â”‚ âœ…       â”‚ âœ…      â”‚ Folder      â”‚ âœ… Docker â”‚
OpenClaw on Mac     â”‚ âœ…      â”‚ âœ…       â”‚ âœ…      â”‚ Folder      â”‚ âŒ       â”‚
OpenClaw on EC2     â”‚ âœ…      â”‚ âœ…       â”‚ âœ…+OFS  â”‚ Folder      â”‚ âŒ       â”‚
Claude Code / Cursorâ”‚ âœ…      â”‚ âœ…       â”‚ âœ…      â”‚ Folder      â”‚ âŒ       â”‚
Railway + OpenClaw  â”‚ âœ…      â”‚ âœ…       â”‚ âœ… å†·å¯åŠ¨â”‚ Folder      â”‚ âŒ       â”‚
n8n / Zapier        â”‚ âœ…      â”‚ âœ…       â”‚ âŒ      â”‚ API         â”‚ âŒ       â”‚
Manus / äº‘Agent     â”‚ âœ…      â”‚ âœ…       â”‚ âŒ      â”‚ API         â”‚ âŒ       â”‚
Lambda / Serverless â”‚ âœ…      â”‚ âœ…       â”‚ âŒ      â”‚ API æˆ– SDK  â”‚ âŒ       â”‚
è‡ªå®šä¹‰Agent (SDK)    â”‚ âœ…      â”‚ âœ…       â”‚ âŒ      â”‚ SDK         â”‚ âŒ       â”‚
è‡ªå®šä¹‰Agent (Folder) â”‚ âœ…      â”‚ âœ…       â”‚ âœ…      â”‚ Folder      â”‚ âŒ       â”‚
```

**è§„å¾‹**ï¼š
- L1 + L2ï¼š**æ‰€æœ‰åœºæ™¯éƒ½éœ€è¦**ï¼ˆä¸å¯æ‹†å¸ï¼‰
- L2.5ï¼š**ä»…æœ¬åœ°æ–‡ä»¶å¤¹æ¨¡å¼éœ€è¦**ï¼ˆå¯æ‹†å¸ï¼‰
- L3ï¼š**å¿…é€‰å…¶ä¸€**ï¼Œä¸‰ç§å½¢æ€äº’æ–¥æˆ–ç»„åˆ
- L4ï¼š**ä»…å†…ç½® CloudBot éœ€è¦**ï¼ˆå¯æ‹†å¸ï¼‰

---

## å››ã€å„ç§¯æœ¨è¯¦ç»†è®¾è®¡

### 4.1 L1: Storage å­˜å‚¨ç§¯æœ¨

**èŒè´£**ï¼šæ•°æ®çš„å­˜å–ï¼Œä¸ç®¡æƒé™ã€ä¸ç®¡ç‰ˆæœ¬ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1: Storage                                  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ S3Service     â”‚  â”‚ ContentNodeRepo     â”‚  â”‚
â”‚  â”‚               â”‚  â”‚                     â”‚  â”‚
â”‚  â”‚ upload()      â”‚  â”‚ create()            â”‚  â”‚
â”‚  â”‚ download()    â”‚  â”‚ get_by_id()         â”‚  â”‚
â”‚  â”‚ delete()      â”‚  â”‚ update()            â”‚  â”‚
â”‚  â”‚ presign_url() â”‚  â”‚ list_children()     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ delete()            â”‚  â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â”‚  å¯¹å¤–æ¥å£ï¼šçº¯ CRUDï¼Œæ— ä¸šåŠ¡é€»è¾‘                  â”‚
â”‚  ä¾èµ–ï¼šS3 (Supabase Storage)ã€PG (Supabase)  â”‚
â”‚  çŠ¶æ€ï¼šâœ… å·²å®Œæˆ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 L2: Collaboration ååŒç§¯æœ¨

**èŒè´£**ï¼šæ•°æ®çš„ç®¡ç†è§„åˆ™â€”â€”è°èƒ½è®¿é—®ã€æ€ä¹ˆå¤„ç†å†²çªã€æ€ä¹ˆè¿½æº¯å†å²ã€‚

è¿™æ˜¯äº§å“çš„**æ ¸å¿ƒå£å’**ã€‚æ‰€æœ‰ä¸Šå±‚ï¼ˆL3-API / L3-Folder / L3-SDKï¼‰æœ€ç»ˆéƒ½é€šè¿‡ L2 è¯»å†™æ•°æ®ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2: Collaboration                                         â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CollaborationServiceï¼ˆç»Ÿä¸€å…¥å£ï¼‰                     â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚  checkout(node_ids, agent_id)                      â”‚   â”‚
â”‚  â”‚    â†’ WorkingCopy{ content, base_version, hash }    â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚  commit(node_id, new_content, base_version, agent) â”‚   â”‚
â”‚  â”‚    â†’ CommitResult{ status, final_content, version }â”‚   â”‚
â”‚  â”‚    status: "clean" | "merged" | "lww"              â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚  history(node_id, limit)                           â”‚   â”‚
â”‚  â”‚    â†’ list[FileVersion]                             â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚  rollback(node_id, target_version)                 â”‚   â”‚
â”‚  â”‚    â†’ ContentNode                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚ å†…éƒ¨è°ƒç”¨                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ VersionSvc   â”‚  â”‚ ConflictSvc  â”‚               â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ åˆ›å»ºç‰ˆæœ¬å¿«ç…§  â”‚  â”‚ JSON keyåˆå¹¶ â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ æŸ¥è¯¢ç‰ˆæœ¬é“¾    â”‚  â”‚ MD è¡Œçº§åˆå¹¶  â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ ç‰ˆæœ¬å·é€’å¢    â”‚  â”‚ LWW å…œåº•     â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ LockSvc      â”‚  â”‚ AuditSvc    â”‚               â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ ä¹è§‚é”æ£€æŸ¥    â”‚  â”‚ è®°å½•æ“ä½œæ—¥å¿— â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ expected_ver â”‚  â”‚ è°/ä½•æ—¶/æ”¹äº†å•¥â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  å¯¹å¤–æ¥å£ï¼šcheckout / commit / history / rollback          â”‚
â”‚  ä¾èµ–ï¼šä»… L1ï¼ˆStorageï¼‰                                    â”‚
â”‚  ä¸ä¾èµ–ï¼šL2.5ã€L3ã€L4ï¼ˆä»»ä½•ä¸€ä¸ªï¼‰                            â”‚
â”‚  çŠ¶æ€ï¼šğŸ”¶ é€»è¾‘å·²å®ç°ï¼ˆVersionService, MergeDaemonï¼‰ï¼Œ       â”‚
â”‚        ä½†æ•£è½åœ¨ AgentService ä¸­ï¼Œéœ€è¦æŠ½å‡ºæ¥ç‹¬ç«‹              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**commit() å†…éƒ¨æµç¨‹**ï¼š

```
commit(node_id, new_content, base_version, agent_id)
  â”‚
  â”œâ”€ 1. ä¹è§‚é”æ£€æŸ¥ï¼šcurrent_version == base_version ?
  â”‚     â”‚
  â”‚     â”œâ”€ YES â†’ ç›´æ¥å†™å…¥ï¼Œversion++
  â”‚     â”‚        return { status: "clean", version: N+1 }
  â”‚     â”‚
  â”‚     â””â”€ NO â†’ æœ‰äººå…ˆæ”¹äº†ï¼Œéœ€è¦åˆå¹¶
  â”‚              â”‚
  â”‚              â”œâ”€ 2. å–å‡º base_content (base_version çš„å¿«ç…§)
  â”‚              â”‚      å–å‡º current_content (å½“å‰æœ€æ–°)
  â”‚              â”‚
  â”‚              â”œâ”€ 3. ä¸‰æ–¹åˆå¹¶
  â”‚              â”‚     â”‚
  â”‚              â”‚     â”œâ”€ JSON â†’ key-level merge
  â”‚              â”‚     â”‚   base vs current vs newï¼Œéå†²çªå­—æ®µè‡ªåŠ¨åˆå¹¶
  â”‚              â”‚     â”‚
  â”‚              â”‚     â”œâ”€ Markdown â†’ line-level merge
  â”‚              â”‚     â”‚   ç±»ä¼¼ git diff3ï¼Œéå†²çªè¡Œè‡ªåŠ¨åˆå¹¶
  â”‚              â”‚     â”‚
  â”‚              â”‚     â””â”€ å…¶ä»– â†’ æ— æ³•åˆå¹¶
  â”‚              â”‚
  â”‚              â”œâ”€ åˆå¹¶æˆåŠŸ â†’ å†™å…¥åˆå¹¶ç»“æœï¼Œversion++
  â”‚              â”‚   return { status: "merged", version: N+1 }
  â”‚              â”‚
  â”‚              â””â”€ åˆå¹¶å¤±è´¥ï¼ˆçœŸå†²çªï¼‰â†’ LWWï¼Œåå†™è€…èƒœ
  â”‚                  return { status: "lww", version: N+1 }
  â”‚
  â””â”€ 4. è®°å½•å®¡è®¡æ—¥å¿—
```

### 4.3 L2.5: Sync åŒæ­¥ç§¯æœ¨

**èŒè´£**ï¼šæŠŠäº‘ç«¯æ•°æ®æ¬åˆ°æœ¬åœ°ï¼ŒæŠŠæœ¬åœ°æ”¹åŠ¨æ¬å›äº‘ç«¯ã€‚ä»…åœ¨ L3-Folderï¼ˆæœ¬åœ°æ–‡ä»¶å¤¹æ¨¡å¼ï¼‰ä¸‹éœ€è¦ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2.5: Sync Cache                                          â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SyncServiceï¼ˆç»Ÿä¸€å…¥å£ï¼‰                               â”‚  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚  provision(access_points, agent_id)                 â”‚  â”‚
â”‚  â”‚    â†’ WorkspacePath (æœ¬åœ°æ–‡ä»¶å¤¹è·¯å¾„)                   â”‚  â”‚
â”‚  â”‚    å†…éƒ¨ï¼šè°ƒç”¨ L2.checkout() â†’ å†™å…¥æœ¬åœ°æ–‡ä»¶             â”‚  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚  collect_changes(workspace_path)                    â”‚  â”‚
â”‚  â”‚    â†’ list[Change{ path, old_content, new_content }] â”‚  â”‚
â”‚  â”‚    å†…éƒ¨ï¼šå¯¹æ¯”æœ¬åœ°æ–‡ä»¶ä¸ checkout æ—¶çš„å¿«ç…§              â”‚  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚  apply_changes(changes)                             â”‚  â”‚
â”‚  â”‚    â†’ list[CommitResult]                             â”‚  â”‚
â”‚  â”‚    å†…éƒ¨ï¼šå¯¹æ¯ä¸ª change è°ƒç”¨ L2.commit()              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚ å†…éƒ¨ç»„ä»¶                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ SyncDaemon         â”‚  â”‚ FileWatcher           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚  â”‚                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ ä¸‹è¡ŒåŒæ­¥ï¼š          â”‚  â”‚ macOS: FSEvents       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ å®šæ—¶/äº‹ä»¶ä»äº‘ç«¯æ‹‰å–  â”‚  â”‚ Linux: inotify        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚  â”‚                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ ä¸Šè¡ŒåŒæ­¥ï¼š          â”‚  â”‚ æ£€æµ‹æ–‡ä»¶å¢åˆ æ”¹         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ FileWatcherè§¦å‘ â†’   â”‚  â”‚ è§¦å‘ SyncDaemon ä¸Šè¡Œ  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ collect + apply     â”‚  â”‚                       â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ WorkspaceProviderï¼ˆå¯é€‰ä¼˜åŒ–ï¼Œå¤š Agent åœºæ™¯ï¼‰     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ ç­–ç•¥ A: FallbackProvider â€” cp -r å…¨é‡å¤åˆ¶      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚         é€‚ç”¨ï¼šå• Agentï¼Œå°æ•°æ®                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ ç­–ç•¥ B: APFSProvider â€” cp -cR CoW å…‹éš†         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚         é€‚ç”¨ï¼šmacOS å¤š Agentï¼Œä¸­ç­‰æ•°æ®           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ ç­–ç•¥ C: OverlayFSProvider â€” mount -t overlay   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚         é€‚ç”¨ï¼šLinux å¤š Agentï¼Œå¤§æ•°æ® (100+)     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  å¯¹å¤–æ¥å£ï¼šprovision / collect_changes / apply_changes     â”‚
â”‚  ä¾èµ–ï¼šL2ï¼ˆCollaborationServiceï¼‰ã€L1ï¼ˆStorageï¼‰           â”‚
â”‚  ä¸ä¾èµ–ï¼šL3ã€L4                                            â”‚
â”‚  çŠ¶æ€ï¼šğŸ”¶ SyncWorker + WorkspaceProvider åŸå‹å·²æœ‰ï¼Œ        â”‚
â”‚        éœ€ä» AgentService ç‹¬ç«‹å‡ºæ¥                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 L3: Interface æ¥å£ç§¯æœ¨

ä¸‰ç§å½¢æ€ï¼Œäº’ä¸ä¾èµ–ï¼ŒæŒ‰éœ€é€‰ç”¨ã€‚

#### L3-API: REST æ¥å£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3-API: REST æ¥å£                             â”‚
â”‚                                               â”‚
â”‚  ç°æœ‰è·¯ç”±ï¼ˆæ•°æ® CRUDï¼‰ï¼š                        â”‚
â”‚    /api/v1/nodes/*       å†…å®¹èŠ‚ç‚¹æ“ä½œ           â”‚
â”‚    /api/v1/ingest/*      æ•°æ®æ‘„å–              â”‚
â”‚    /api/v1/tools/*       å·¥å…·ç®¡ç†              â”‚
â”‚    /api/v1/mcp/*         MCP åè®®             â”‚
â”‚    /api/v1/s3/*          æ–‡ä»¶ä¸Šä¼ ä¸‹è½½           â”‚
â”‚                                               â”‚
â”‚  éœ€æ–°å¢è·¯ç”±ï¼ˆååŒèƒ½åŠ›ï¼‰ï¼š                        â”‚
â”‚    POST /api/v1/collab/checkout               â”‚
â”‚    POST /api/v1/collab/commit                 â”‚
â”‚    GET  /api/v1/collab/history/:nodeId        â”‚
â”‚    POST /api/v1/collab/rollback               â”‚
â”‚                                               â”‚
â”‚  ä¾èµ–ï¼šL2ï¼ˆCollaborationServiceï¼‰              â”‚
â”‚  ä¸ä¾èµ–ï¼šL2.5ã€L4                              â”‚
â”‚  çŠ¶æ€ï¼šâœ… å¤§éƒ¨åˆ†å·²å®Œæˆï¼Œéœ€è¡¥å…… collab è·¯ç”±       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### L3-Folder: æœ¬åœ°æ–‡ä»¶å¤¹æ¥å£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3-Folder: æœ¬åœ°æ–‡ä»¶å¤¹æ¥å£                      â”‚
â”‚                                               â”‚
â”‚  èŒè´£ï¼šç»™ Agent æä¾›ä¸€ä¸ª"çœ‹èµ·æ¥åƒæ™®é€šæ–‡ä»¶å¤¹"      â”‚
â”‚       çš„æ•°æ®è®¿é—®æ–¹å¼                             â”‚
â”‚                                               â”‚
â”‚  Agent è§†è§’ï¼š                                  â”‚
â”‚    ls /workspace/                              â”‚
â”‚    cat /workspace/config.json                  â”‚
â”‚    echo "new" > /workspace/output.md           â”‚
â”‚  Agent ä¸çŸ¥é“åº•ä¸‹æ˜¯äº‘ç«¯æ•°æ®ï¼Œä¸çŸ¥é“æœ‰åŒæ­¥          â”‚
â”‚                                               â”‚
â”‚  ä¾èµ–ï¼šL2.5ï¼ˆSyncServiceï¼‰                     â”‚
â”‚  ä¸ä¾èµ–ï¼šL4                                    â”‚
â”‚  çŠ¶æ€ï¼šğŸ”¶ é€»è¾‘åµŒåœ¨ AgentService çš„             â”‚
â”‚        prepare_sandbox_data ä¸­                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### L3-SDK: Python / JS / Go SDK

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3-SDK: å¼€å‘è€… SDK                            â”‚
â”‚                                               â”‚
â”‚  Python ç¤ºä¾‹ï¼š                                 â”‚
â”‚                                               â”‚
â”‚    from contextbase import ContextFS          â”‚
â”‚                                               â”‚
â”‚    ctx = ContextFS(                           â”‚
â”‚        token="cb_xxx",                        â”‚
â”‚        project="my-project"                   â”‚
â”‚    )                                          â”‚
â”‚                                               â”‚
â”‚    # è¯»å–ï¼ˆå†…éƒ¨è°ƒ L3-API â†’ L2 â†’ L1ï¼‰           â”‚
â”‚    data = ctx.read("/shared/config.json")     â”‚
â”‚                                               â”‚
â”‚    # å†™å…¥ï¼ˆå†…éƒ¨è°ƒ L3-API â†’ L2.commitï¼‰         â”‚
â”‚    ctx.write("/reports/output.md", result)    â”‚
â”‚                                               â”‚
â”‚    # ç‰ˆæœ¬å†å²ï¼ˆå†…éƒ¨è°ƒ L3-API â†’ L2.historyï¼‰     â”‚
â”‚    versions = ctx.versions("/shared/config")  â”‚
â”‚                                               â”‚
â”‚    # å›æ»šï¼ˆå†…éƒ¨è°ƒ L3-API â†’ L2.rollbackï¼‰       â”‚
â”‚    ctx.rollback("/shared/config", version=2)  â”‚
â”‚                                               â”‚
â”‚  ä¾èµ–ï¼šL3-APIï¼ˆHTTP è°ƒç”¨ï¼‰                     â”‚
â”‚  ä¸ä¾èµ–ï¼šL2.5ã€L4                              â”‚
â”‚  çŠ¶æ€ï¼šâŒ æœªå¼€å‘                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.5 L4: Sandbox æ²™ç›’ç§¯æœ¨

**èŒè´£**ï¼šä¸ºå†…ç½® Agent æä¾›éš”ç¦»çš„æ‰§è¡Œç¯å¢ƒã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L4: Sandboxï¼ˆä»…å†…ç½® CloudBot éœ€è¦ï¼‰            â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SandboxManagerï¼ˆç»Ÿä¸€å…¥å£ï¼‰               â”‚  â”‚
â”‚  â”‚                                         â”‚  â”‚
â”‚  â”‚  create(image, resources)               â”‚  â”‚
â”‚  â”‚    â†’ SandboxInstance                    â”‚  â”‚
â”‚  â”‚                                         â”‚  â”‚
â”‚  â”‚  mount(sandbox, workspace_path)         â”‚  â”‚
â”‚  â”‚    â†’ æŠŠ L2.5 ç”Ÿæˆçš„æœ¬åœ°ç›®å½•æŒ‚è¿›å®¹å™¨       â”‚  â”‚
â”‚  â”‚                                         â”‚  â”‚
â”‚  â”‚  exec(sandbox, command)                 â”‚  â”‚
â”‚  â”‚    â†’ ExecResult{ stdout, stderr, code } â”‚  â”‚
â”‚  â”‚                                         â”‚  â”‚
â”‚  â”‚  destroy(sandbox)                       â”‚  â”‚
â”‚  â”‚    â†’ æ¸…ç†å®¹å™¨å’Œä¸´æ—¶æ–‡ä»¶                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚ å®ç°                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ DockerSandboxâ”‚  â”‚ E2BSandbox    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ æœ¬åœ° Docker  â”‚  â”‚ äº‘ç«¯ E2B      â”‚   â”‚  â”‚
â”‚  â”‚  â”‚              â”‚  â”‚               â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ docker run   â”‚  â”‚ e2b.create()  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ -v mount     â”‚  â”‚ e2b.exec()    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ --memory 128mâ”‚  â”‚               â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚
â”‚  ä¾èµ–ï¼šL3-Folderï¼ˆéœ€è¦ä¸€ä¸ªæœ¬åœ°è·¯å¾„æ¥æŒ‚è½½ï¼‰      â”‚
â”‚  ä¸ä¾èµ–ï¼šL2ï¼ˆä¸ç›´æ¥è°ƒç”¨ååŒé€»è¾‘ï¼‰               â”‚
â”‚  çŠ¶æ€ï¼šâœ… DockerSandbox + E2B å·²å®ç°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€ç§¯æœ¨é—´çš„æ¥å£å¥‘çº¦

### 5.1 ä¾èµ–å…³ç³»ï¼ˆå•å‘ï¼Œæ— ç¯ï¼‰

```
L4 â”€â”€dependsâ”€â”€â†’ L3-Folder â”€â”€dependsâ”€â”€â†’ L2.5 â”€â”€dependsâ”€â”€â†’ L2 â”€â”€dependsâ”€â”€â†’ L1
                L3-API    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dependsâ”€â”€â†’ L2 â”€â”€dependsâ”€â”€â†’ L1
                L3-SDK    â”€â”€dependsâ”€â”€â†’ L3-API
```

**è§„åˆ™**ï¼š
- ä¾èµ–æ–¹å‘åªèƒ½**å‘ä¸‹**ï¼ˆé«˜å±‚ä¾èµ–ä½å±‚ï¼‰
- åŒå±‚ä¹‹é—´**ä¸äº’ç›¸ä¾èµ–**ï¼ˆL3-API å’Œ L3-Folder äº’ä¸ä¾èµ–ï¼‰
- **L2 æ˜¯å”¯ä¸€çš„æ•°æ®å†™å…¥ç½‘å…³**ï¼ˆæ‰€æœ‰å†™æ“ä½œæœ€ç»ˆé€šè¿‡ L2ï¼‰

### 5.2 æ ¸å¿ƒæ¥å£å®šä¹‰

#### L2 å¯¹å¤–æ¥å£ï¼ˆæ‰€æœ‰ä¸Šå±‚éƒ½è°ƒè¿™ä¸ªï¼‰

```python
class CollaborationService:
    """L2 ååŒå±‚ â€” æ‰€æœ‰æ•°æ®è¯»å†™çš„å”¯ä¸€ç½‘å…³"""

    async def checkout(
        self,
        node_ids: list[str],
        agent_id: str | None = None,
    ) -> list[WorkingCopy]:
        """è·å–èŠ‚ç‚¹å†…å®¹ + ç‰ˆæœ¬å¿«ç…§ï¼ˆç”¨äºåç»­ commit çš„ baseï¼‰"""

    async def commit(
        self,
        node_id: str,
        new_content: str | dict,
        base_version: int,
        agent_id: str | None = None,
        operator: str | None = None,
    ) -> CommitResult:
        """
        å†™å…¥å˜æ›´ï¼Œè‡ªåŠ¨å¤„ç†å†²çªã€‚
        è¿”å› CommitResult:
          - status: "clean" | "merged" | "lww"
          - version: æ–°ç‰ˆæœ¬å·
          - final_content: æœ€ç»ˆå†™å…¥çš„å†…å®¹
        """

    async def history(
        self,
        node_id: str,
        limit: int = 50,
    ) -> list[FileVersion]:
        """æŸ¥è¯¢ç‰ˆæœ¬å†å²"""

    async def rollback(
        self,
        node_id: str,
        target_version: int,
    ) -> ContentNode:
        """å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬"""
```

#### L2.5 å¯¹å¤–æ¥å£

```python
class SyncService:
    """L2.5 åŒæ­¥å±‚ â€” äº‘ç«¯æ•°æ® â†” æœ¬åœ°æ–‡ä»¶å¤¹"""

    async def provision(
        self,
        access_points: list[AccessPoint],
        agent_id: str | None = None,
    ) -> WorkspacePath:
        """
        å‡†å¤‡æœ¬åœ°å·¥ä½œåŒºï¼šä»äº‘ç«¯æ‹‰å–æ•°æ®åˆ°æœ¬åœ°æ–‡ä»¶å¤¹ã€‚
        å†…éƒ¨è°ƒç”¨ L2.checkout()ã€‚
        """

    async def collect_changes(
        self,
        workspace_path: str,
    ) -> list[FileChange]:
        """æ£€æµ‹æœ¬åœ°æ–‡ä»¶å¤¹ä¸­çš„å˜æ›´"""

    async def apply_changes(
        self,
        changes: list[FileChange],
        agent_id: str | None = None,
    ) -> list[CommitResult]:
        """
        æŠŠæœ¬åœ°å˜æ›´å†™å›äº‘ç«¯ã€‚
        å†…éƒ¨å¯¹æ¯ä¸ª change è°ƒç”¨ L2.commit()ã€‚
        """
```

#### L4 å¯¹å¤–æ¥å£

```python
class SandboxManager:
    """L4 æ²™ç›’å±‚ â€” Agent æ‰§è¡Œç¯å¢ƒç®¡ç†"""

    async def create(
        self,
        image: str | None = None,
        resources: ResourceConfig | None = None,
    ) -> SandboxInstance:
        """åˆ›å»ºæ²™ç›’å®ä¾‹"""

    async def mount(
        self,
        sandbox: SandboxInstance,
        workspace_path: str,
        mount_point: str = "/workspace",
    ) -> None:
        """æŠŠæœ¬åœ°ç›®å½•æŒ‚è½½åˆ°æ²™ç›’ä¸­"""

    async def exec(
        self,
        sandbox: SandboxInstance,
        command: str,
    ) -> ExecResult:
        """åœ¨æ²™ç›’ä¸­æ‰§è¡Œå‘½ä»¤"""

    async def destroy(
        self,
        sandbox: SandboxInstance,
    ) -> None:
        """é”€æ¯æ²™ç›’ï¼Œæ¸…ç†èµ„æº"""
```

### 5.3 ç¼–æ’å™¨ï¼ˆAgentOrchestratorï¼‰

ç¼–æ’å™¨ä¸æ˜¯ç§¯æœ¨ï¼Œå®ƒæ˜¯**æ‹¼è£…ç§¯æœ¨çš„äºº**ã€‚å®ƒçŸ¥é“è¯¥ç”¨å“ªäº›ç§¯æœ¨ã€ä»¥ä»€ä¹ˆé¡ºåºæ‹¼è£…ã€‚

```python
class AgentOrchestrator:
    """ç¼–æ’å™¨ â€” æŠŠç§¯æœ¨æ‹¼æˆå®Œæ•´æµç¨‹"""

    def __init__(
        self,
        collab: CollaborationService,          # L2 (å¿…é€‰)
        sync: SyncService | None = None,       # L2.5 (å¯é€‰)
        sandbox: SandboxManager | None = None,  # L4 (å¯é€‰)
    ):
        self.collab = collab
        self.sync = sync
        self.sandbox = sandbox

    async def run_agent(self, agent_config, access_points):
        # 1. checkout
        working_copies = await self.collab.checkout(access_points)

        # 2. provision workspace (if sync available)
        if self.sync:
            workspace = await self.sync.provision(working_copies)
        else:
            # API-only æ¨¡å¼ï¼Œä¸éœ€è¦æœ¬åœ°æ–‡ä»¶å¤¹
            workspace = None

        # 3. create sandbox (if sandbox available)
        if self.sandbox and workspace:
            sandbox = await self.sandbox.create(agent_config.image)
            await self.sandbox.mount(sandbox, workspace)
        else:
            sandbox = None

        # 4. execute
        result = await self._execute(sandbox, workspace, agent_config)

        # 5. collect & commit changes
        if self.sync and workspace:
            changes = await self.sync.collect_changes(workspace)
            commit_results = await self.sync.apply_changes(changes)

        # 6. cleanup
        if sandbox:
            await self.sandbox.destroy(sandbox)
```

**ä¸åŒæ¨¡å¼ä¸‹çš„æ³¨å…¥**ï¼š

```python
# æ¨¡å¼ Aï¼šå†…ç½® CloudBotï¼ˆå…¨å¥—ç§¯æœ¨ï¼‰
orchestrator = AgentOrchestrator(
    collab=collaboration_service,
    sync=sync_service,
    sandbox=sandbox_manager,
)

# æ¨¡å¼ Bï¼šAPI-onlyï¼ˆæ— éœ€ç¼–æ’å™¨ï¼Œç›´æ¥è°ƒ L3-API è·¯ç”±ï¼‰

# æ¨¡å¼ Cï¼šæœ¬åœ° Daemonï¼ˆæ— æ²™ç›’ï¼‰
orchestrator = AgentOrchestrator(
    collab=collaboration_service,
    sync=sync_service,
    sandbox=None,  # æ²™ç›’æ˜¯ OpenClaw ç®¡çš„
)
```

---

## å…­ã€ä¿è¯ç§¯æœ¨å¯æ’æ‹”çš„è®¾è®¡åŸåˆ™

### 6.1 æ¥å£éš”ç¦»

æ¯å—ç§¯æœ¨åªé€šè¿‡**æ¥å£**ï¼ˆPython ABC / Protocolï¼‰ä¸å…¶ä»–ç§¯æœ¨äº¤äº’ï¼Œä¸ç›´æ¥ä¾èµ–å…·ä½“å®ç°ã€‚

```python
# é”™è¯¯ï¼šL2.5 ç›´æ¥ import L2 çš„å…·ä½“ç±»
from src.content_node.version_service import VersionService  # âŒ

# æ­£ç¡®ï¼šL2.5 ä¾èµ– L2 çš„æ¥å£
from src.collaboration.interface import CollaborationService  # âœ…
```

### 6.2 ä¾èµ–æ³¨å…¥

ç§¯æœ¨ä¹‹é—´é€šè¿‡ FastAPI `Depends` æ³¨å…¥ï¼Œä¸ç¡¬ç¼–ç ä¾èµ–ã€‚

```python
# L2.5 çš„ SyncService é€šè¿‡ä¾èµ–æ³¨å…¥è·å– L2
class SyncService:
    def __init__(self, collab: CollaborationService):
        self.collab = collab

# FastAPI è·¯ç”±ä¸­ç»„è£…
def get_sync_service(
    collab: CollaborationService = Depends(get_collaboration_service),
) -> SyncService:
    return SyncService(collab=collab)
```

### 6.3 æ— ç¯ä¾èµ–

```
L4 â†’ L3 â†’ L2.5 â†’ L2 â†’ L1      âœ… å•å‘

L2 â†’ L2.5 â†’ L2                 âŒ å¾ªç¯ï¼ˆç¦æ­¢ï¼‰
L3-API â†” L3-Folder              âŒ åŒå±‚äº’ç›¸ä¾èµ–ï¼ˆç¦æ­¢ï¼‰
```

### 6.4 ç‹¬ç«‹å¯æµ‹è¯•

æ¯å—ç§¯æœ¨å¯ä»¥**ç‹¬ç«‹å¯åŠ¨ã€ç‹¬ç«‹æµ‹è¯•**ï¼Œä¸éœ€è¦å…¶ä»–ç§¯æœ¨å­˜åœ¨ã€‚

```python
# æµ‹è¯• L2ï¼ˆä¸éœ€è¦ L2.5 æˆ– L4ï¼‰
async def test_commit_conflict():
    collab = CollaborationService(repo=mock_repo)
    result = await collab.commit("node-1", {"key": "new"}, base_version=1)
    assert result.status == "merged"

# æµ‹è¯• L2.5ï¼ˆMock L2ï¼‰
async def test_sync_provision():
    mock_collab = MockCollaborationService()
    sync = SyncService(collab=mock_collab)
    path = await sync.provision(access_points)
    assert os.path.exists(path)
```

### 6.5 é…ç½®é©±åŠ¨

é€šè¿‡é…ç½®å†³å®šå¯ç”¨å“ªäº›ç§¯æœ¨ï¼Œè€Œä¸æ˜¯ä»£ç åˆ†æ”¯ã€‚

```python
# config.py
class Settings:
    # L2.5 é…ç½®
    SYNC_ENABLED: bool = True
    WORKSPACE_PROVIDER: str = "fallback"  # fallback | apfs | overlayfs

    # L4 é…ç½®
    SANDBOX_ENABLED: bool = True
    SANDBOX_TYPE: str = "docker"  # docker | e2b | none
```

---

## ä¸ƒã€ä¸ç°æœ‰ä»£ç çš„æ˜ å°„å’Œè¿ç§»è·¯å¾„

### 7.1 ç°æœ‰ä»£ç å½’å±

| ç°æœ‰æ–‡ä»¶ | å½“å‰å½’å± | åº”å½’å± | è¿ç§»åŠ¨ä½œ |
|---------|---------|-------|---------|
| `content_node/repository.py` | L1 | L1 | âœ… ä¸åŠ¨ |
| `content_node/service.py` | L1+L2 æ··åˆ | L1 | å‰¥ç¦» L2 é€»è¾‘ |
| `content_node/version_service.py` | L2 | L2 | ç§»å…¥ `collaboration/` |
| `workspace/merge_daemon.py` | L2 | L2 | ç§»å…¥ `collaboration/` |
| `workspace/sync_worker.py` | L2.5 | L2.5 | ç§»å…¥ `sync/` |
| `workspace/apfs_provider.py` | L2.5 | L2.5 | ç§»å…¥ `sync/` |
| `workspace/fallback_provider.py` | L2.5 | L2.5 | ç§»å…¥ `sync/` |
| `content_node/router.py` | L3-API | L3-API | è¡¥å…… collab è·¯ç”± |
| `ingest/router.py` | L3-API | L3-API | âœ… ä¸åŠ¨ |
| `sandbox/docker_sandbox.py` | L4 | L4 | âœ… åŸºæœ¬ä¸åŠ¨ |
| `agent/service.py` | L2+L2.5+L3+L4 å…¨æ·· | ç¼–æ’å™¨ | **é‡ç‚¹é‡æ„** |

### 7.2 ç›®æ ‡ç›®å½•ç»“æ„ï¼ˆæ–‡ä»¶çº§è¯¦ç»†è®¾è®¡ï¼‰

ä¸‹é¢åˆ—å‡ºæ¯ä¸ªæ¨¡å—çš„æ¯ä¸ªæ–‡ä»¶ã€èŒè´£ã€è¡Œæ•°ä¼°ç®—ã€ä»¥åŠè¿ç§»æ¥æºã€‚

#### æ–°å»ºï¼š`src/collaboration/` â€” L2 ååŒå±‚

äº§å“æ ¸å¿ƒå£å’ã€‚æ‰€æœ‰æ•°æ®å†™å…¥æœ€ç»ˆç»è¿‡æ­¤å±‚ã€‚

```
src/collaboration/
â”‚
â”œâ”€â”€ __init__.py
â”‚
â”œâ”€â”€ service.py                 # CollaborationService â€” L2 ç»Ÿä¸€å…¥å£
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šå¯¹å¤–æš´éœ² checkout / commit / history / rollback å››ä¸ªæ–¹æ³•
â”‚   â”‚       å†…éƒ¨ç¼–æ’ VersionServiceã€ConflictServiceã€LockService
â”‚   â”‚       æ‰€æœ‰ä¸Šå±‚ï¼ˆL3-API / L2.5 / Agentç¼–æ’å™¨ï¼‰åªè°ƒè¿™ä¸ªç±»
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šæ–°å»ºï¼ˆé€»è¾‘ä» agent/service.py çš„ writeback éƒ¨åˆ†æå–ï¼‰
â”‚   â”‚  ~200 è¡Œ
â”‚   â”‚
â”‚   â”‚  æ ¸å¿ƒæ–¹æ³•ï¼š
â”‚   â”‚    async def checkout(node_ids, agent_id) â†’ list[WorkingCopy]
â”‚   â”‚    async def commit(node_id, content, base_version, agent_id) â†’ CommitResult
â”‚   â”‚    async def history(node_id, limit) â†’ list[FileVersion]
â”‚   â”‚    async def rollback(node_id, target_version) â†’ ContentNode
â”‚
â”œâ”€â”€ conflict_service.py        # ConflictService â€” ä¸‰æ–¹åˆå¹¶å¼•æ“
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šJSON key-level mergeã€Markdown line-level mergeã€LWW å…œåº•
â”‚   â”‚       çº¯å‡½æ•°å¼ï¼Œä¸è®¿é—®æ•°æ®åº“ï¼Œåªåšå†…å®¹æ¯”å¯¹å’Œåˆå¹¶
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šä» workspace/merge_daemon.py æ•´ä½“è¿ç§»ï¼ˆ410 è¡Œï¼‰
â”‚   â”‚  ~400 è¡Œ
â”‚   â”‚
â”‚   â”‚  æ ¸å¿ƒæ–¹æ³•ï¼š
â”‚   â”‚    def merge(base, current, new, node_type) â†’ MergeResult
â”‚   â”‚    def _json_three_way_merge(base, ours, theirs) â†’ dict | None
â”‚   â”‚    def _text_three_way_merge(base, ours, theirs) â†’ str | None
â”‚
â”œâ”€â”€ version_service.py         # VersionService â€” ç‰ˆæœ¬å¿«ç…§ç®¡ç†
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šåˆ›å»ºæ–‡ä»¶ç‰ˆæœ¬å¿«ç…§ã€æŸ¥è¯¢ç‰ˆæœ¬å†å²ã€ç‰ˆæœ¬å·é€’å¢
â”‚   â”‚       æ“ä½œ file_versions / folder_snapshots è¡¨
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šä» content_node/version_service.py æ•´ä½“è¿ç§»ï¼ˆ583 è¡Œï¼‰
â”‚   â”‚  ~550 è¡Œ
â”‚   â”‚
â”‚   â”‚  æ ¸å¿ƒæ–¹æ³•ï¼š
â”‚   â”‚    async def create_version(node_id, content, operator) â†’ FileVersion
â”‚   â”‚    async def get_version(node_id, version) â†’ FileVersion | None
â”‚   â”‚    async def list_versions(node_id, limit) â†’ list[FileVersion]
â”‚   â”‚    async def create_folder_snapshot(folder_id) â†’ FolderSnapshot
â”‚
â”œâ”€â”€ version_repository.py      # ç‰ˆæœ¬æ•°æ® DB æ“ä½œ
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šfile_versions / folder_snapshots è¡¨çš„çº¯ CRUD
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šä» content_node/version_repository.py æ•´ä½“è¿ç§»ï¼ˆ~240 è¡Œï¼‰
â”‚   â”‚  ~240 è¡Œ
â”‚
â”œâ”€â”€ lock_service.py            # OptimisticLockService â€” ä¹è§‚é”
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šå°è£…ä¹è§‚é”é€»è¾‘ï¼ˆæ£€æŸ¥ expected_version vs current_versionï¼‰
â”‚   â”‚       ä» content_node/repository.py çš„ update() ä¸­ expected_version é€»è¾‘æå–
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šæ–°å»ºï¼ˆé€»è¾‘ä» repository.py update() æå–ï¼‰
â”‚   â”‚  ~80 è¡Œ
â”‚   â”‚
â”‚   â”‚  æ ¸å¿ƒæ–¹æ³•ï¼š
â”‚   â”‚    async def try_acquire(node_id, expected_version) â†’ bool
â”‚   â”‚    async def force_write(node_id, content, new_version) â†’ ContentNode
â”‚
â”œâ”€â”€ audit_service.py           # AuditService â€” å®¡è®¡æ—¥å¿—ï¼ˆé¢„ç•™ï¼‰
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šè®°å½•è°ã€åœ¨ä»€ä¹ˆæ—¶é—´ã€å¯¹å“ªä¸ªèŠ‚ç‚¹ã€åšäº†ä»€ä¹ˆæ“ä½œ
â”‚   â”‚       Phase 1 å…ˆå†™æ¡†æ¶ï¼Œåç»­è¡¥å……å®Œæ•´å®ç°
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šæ–°å»º
â”‚   â”‚  ~60 è¡Œï¼ˆåˆç‰ˆï¼‰
â”‚
â”œâ”€â”€ schemas.py                 # L2 çš„æ•°æ®æ¨¡å‹
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šå®šä¹‰ WorkingCopyã€CommitResultã€MergeResultã€FileVersion ç­‰
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šåˆå¹¶ content_node/version_schemas.pyï¼ˆ134 è¡Œï¼‰+ æ–°å¢ç±»å‹
â”‚   â”‚  ~200 è¡Œ
â”‚   â”‚
â”‚   â”‚  æ ¸å¿ƒç±»å‹ï¼š
â”‚   â”‚    WorkingCopy { node_id, content, base_version, content_hash, node_type }
â”‚   â”‚    CommitResult { status: "clean"|"merged"|"lww", version, final_content }
â”‚   â”‚    MergeResult { success: bool, content, strategy }
â”‚
â”œâ”€â”€ router.py                  # /api/v1/collab/* REST è·¯ç”±
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šå¯¹å¤–æš´éœ² L2 èƒ½åŠ›ä¸º HTTP API
â”‚   â”‚       POST /checkoutã€POST /commitã€GET /history/:idã€POST /rollback
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šåˆå¹¶ content_node/version_router.pyï¼ˆ~170 è¡Œï¼‰+ æ–°å¢è·¯ç”±
â”‚   â”‚  ~250 è¡Œ
â”‚
â””â”€â”€ dependencies.py            # FastAPI ä¾èµ–æ³¨å…¥
    â”‚
    â”‚  èŒè´£ï¼šget_collaboration_service()ã€get_version_service() ç­‰å·¥å‚å‡½æ•°
    â”‚
    â”‚  æ¥æºï¼šæ–°å»º
    â”‚  ~40 è¡Œ
```

#### æ–°å»ºï¼š`src/sync/` â€” L2.5 åŒæ­¥å±‚

ä»…æœ¬åœ°æ–‡ä»¶å¤¹æ¨¡å¼éœ€è¦ã€‚æŠŠäº‘ç«¯æ•°æ®æ¬åˆ°æœ¬åœ°ï¼ŒæŠŠæœ¬åœ°æ”¹åŠ¨æ¬å›äº‘ç«¯ã€‚

```
src/sync/
â”‚
â”œâ”€â”€ __init__.py
â”‚
â”œâ”€â”€ service.py                 # SyncService â€” L2.5 ç»Ÿä¸€å…¥å£
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šåè°ƒä¸‹è¡ŒåŒæ­¥ï¼ˆäº‘ç«¯â†’æœ¬åœ°ï¼‰å’Œä¸Šè¡ŒåŒæ­¥ï¼ˆæœ¬åœ°â†’äº‘ç«¯ï¼‰
â”‚   â”‚       å†…éƒ¨è°ƒç”¨ L2.CollaborationService è¿›è¡Œè¯»å†™
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šæ–°å»ºï¼ˆé€»è¾‘ä» agent/service.py çš„ prepare_sandbox_data
â”‚   â”‚        å’Œ writeback éƒ¨åˆ†æå–ï¼‰
â”‚   â”‚  ~300 è¡Œ
â”‚   â”‚
â”‚   â”‚  æ ¸å¿ƒæ–¹æ³•ï¼š
â”‚   â”‚    async def provision(access_points, agent_id) â†’ WorkspacePath
â”‚   â”‚        # ä»äº‘ç«¯æ‹‰å–æ•°æ®ï¼Œå†™æˆæœ¬åœ°æ–‡ä»¶å¤¹
â”‚   â”‚    async def collect_changes(workspace_path) â†’ list[FileChange]
â”‚   â”‚        # å¯¹æ¯”æœ¬åœ°æ–‡ä»¶ä¸ checkout æ—¶çš„å¿«ç…§ï¼Œæ£€æµ‹æ”¹åŠ¨
â”‚   â”‚    async def apply_changes(changes, agent_id) â†’ list[CommitResult]
â”‚   â”‚        # å¯¹æ¯ä¸ª change è°ƒç”¨ L2.commit() å†™å›äº‘ç«¯
â”‚
â”œâ”€â”€ sync_worker.py             # SyncDaemon â€” æŒç»­è¿è¡Œçš„åŒæ­¥è¿›ç¨‹
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šä½œä¸ºç‹¬ç«‹è¿›ç¨‹ï¼ˆæˆ–åå°ä»»åŠ¡ï¼‰æŒç»­ç›‘æ§æ–‡ä»¶å˜æ›´
â”‚   â”‚       å®šæ—¶ä¸‹è¡Œæ‹‰å– + FileWatcher è§¦å‘ä¸Šè¡Œæ¨é€
â”‚   â”‚       ç”¨äº Daemon æ¨¡å¼ï¼ˆOpenClaw / Claude Code / Cursorï¼‰
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šä» workspace/sync_worker.py è¿ç§»æ”¹é€ ï¼ˆ261 è¡Œï¼‰
â”‚   â”‚  ~300 è¡Œ
â”‚
â”œâ”€â”€ file_watcher.py            # FileWatcher â€” æœ¬åœ°æ–‡ä»¶å˜æ›´æ£€æµ‹
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šç›‘æ§æŒ‡å®šç›®å½•çš„æ–‡ä»¶å¢åˆ æ”¹
â”‚   â”‚       macOS ç”¨ FSEventsï¼ŒLinux ç”¨ inotify
â”‚   â”‚       æ£€æµ‹åˆ°å˜æ›´åè§¦å‘ SyncService.apply_changes()
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šæ–°å»ºï¼ˆæœªæ¥å®ç°ï¼ŒPhase 2+ï¼‰
â”‚   â”‚  ~150 è¡Œ
â”‚
â”œâ”€â”€ workspace_provider.py      # WorkspaceProvider â€” å·¥ä½œåŒºåˆ›å»ºç­–ç•¥æŠ½è±¡
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šå®šä¹‰æŠ½è±¡æ¥å£ï¼Œç”±å…·ä½“ Provider å®ç°
â”‚   â”‚       é€‰æ‹©åˆé€‚çš„ç­–ç•¥åˆ›å»º Agent å·¥ä½œåŒºå‰¯æœ¬
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šä» workspace/provider.py è¿ç§»ï¼ˆ~100 è¡Œï¼‰
â”‚   â”‚  ~100 è¡Œ
â”‚   â”‚
â”‚   â”‚  æ¥å£ï¼š
â”‚   â”‚    class WorkspaceProvider(ABC):
â”‚   â”‚        async def create_workspace(lower_path, agent_id) â†’ str
â”‚   â”‚        async def cleanup_workspace(workspace_path) â†’ None
â”‚
â”œâ”€â”€ providers/                 # å…·ä½“çš„å·¥ä½œåŒºåˆ›å»ºç­–ç•¥
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ fallback.py            # FallbackProvider â€” cp -r å…¨é‡å¤åˆ¶
â”‚   â”‚   â”‚  æ¥æºï¼šä» workspace/fallback_provider.py è¿ç§»ï¼ˆ143 è¡Œï¼‰
â”‚   â”‚   â”‚  é€‚ç”¨ï¼šå• Agentã€å°æ•°æ®ã€ä»»ä½•æ“ä½œç³»ç»Ÿ
â”‚   â”‚
â”‚   â”œâ”€â”€ apfs.py                # APFSProvider â€” cp -cR CoW å…‹éš†
â”‚   â”‚   â”‚  æ¥æºï¼šä» workspace/apfs_provider.py è¿ç§»ï¼ˆ~190 è¡Œï¼‰
â”‚   â”‚   â”‚  é€‚ç”¨ï¼šmacOSã€å¤š Agentã€ä¸­ç­‰æ•°æ®
â”‚   â”‚
â”‚   â””â”€â”€ overlayfs.py           # OverlayFSProvider â€” mount -t overlay
â”‚       â”‚  æ¥æºï¼šæ–°å»ºï¼ˆPhase 5ï¼Œæš‚ä¸å®ç°ï¼‰
â”‚       â”‚  é€‚ç”¨ï¼šLinuxã€100+ Agentã€å¤§æ•°æ®
â”‚
â””â”€â”€ dependencies.py            # FastAPI ä¾èµ–æ³¨å…¥
    â”‚  æ¥æºï¼šæ–°å»º
    â”‚  ~30 è¡Œ
```

#### ç²¾ç®€ï¼š`src/content_node/` â€” L1 å­˜å‚¨å±‚

åˆ é™¤å·²è¿ç§»åˆ° L2 çš„æ–‡ä»¶ï¼Œä¿ç•™çº¯æ•°æ®æ“ä½œã€‚

```
src/content_node/
â”‚
â”œâ”€â”€ __init__.py                # ä¸å˜
â”‚
â”œâ”€â”€ models.py                  # ContentNode Pydantic æ¨¡å‹
â”‚   â”‚  ä¸å˜ï¼ˆ~140 è¡Œï¼‰
â”‚   â”‚  æ³¨ï¼šcurrent_version / content_hash å­—æ®µä¿ç•™ï¼ˆL1 å­˜å‚¨å­—æ®µï¼‰
â”‚
â”œâ”€â”€ repository.py              # çº¯ CRUDï¼ˆL1ï¼‰
â”‚   â”‚  ç²¾ç®€ï¼šç§»é™¤ expected_version ä¹è§‚é”é€»è¾‘åˆ° L2 lock_service
â”‚   â”‚  ä¿ç•™ï¼šcreate / get_by_id / update / delete / list_children
â”‚   â”‚  ~350 è¡Œï¼ˆä» 423 è¡Œç²¾ç®€ï¼‰
â”‚
â”œâ”€â”€ service.py                 # çº¯æ•°æ®æ“ä½œï¼ˆL1ï¼‰
â”‚   â”‚  ç²¾ç®€ï¼šç§»é™¤ç‰ˆæœ¬ç›¸å…³æ–¹æ³•åˆ° L2
â”‚   â”‚  ä¿ç•™ï¼šcreate_json_node / create_markdown_node / create_file_node
â”‚   â”‚        create_folder / get_by_id / update_node / delete_node
â”‚   â”‚  ~600 è¡Œï¼ˆä» 857 è¡Œç²¾ç®€ï¼‰
â”‚
â”œâ”€â”€ schemas.py                 # Request/Response æ•°æ®æ¨¡å‹
â”‚   â”‚  ä¸å˜ï¼ˆ~130 è¡Œï¼‰
â”‚
â”œâ”€â”€ router.py                  # /api/v1/nodes/* æ•°æ®è·¯ç”±
â”‚   â”‚  ä¸å˜ï¼ˆ~370 è¡Œï¼‰
â”‚
â”œâ”€â”€ dependencies.py            # FastAPI ä¾èµ–æ³¨å…¥
â”‚   â”‚  ä¸å˜ï¼ˆ~60 è¡Œï¼‰
â”‚
â”œâ”€â”€ [åˆ é™¤] version_service.py  â†’ å·²è¿ç§»åˆ° collaboration/version_service.py
â”œâ”€â”€ [åˆ é™¤] version_repository.py â†’ å·²è¿ç§»åˆ° collaboration/version_repository.py
â”œâ”€â”€ [åˆ é™¤] version_schemas.py  â†’ å·²åˆå¹¶åˆ° collaboration/schemas.py
â””â”€â”€ [åˆ é™¤] version_router.py   â†’ å·²åˆå¹¶åˆ° collaboration/router.py
```

#### å¾®è°ƒï¼š`src/sandbox/` â€” L4 æ²™ç›’å±‚

åŸºæœ¬ä¸å˜ï¼Œæ–°å¢ SandboxManager ç»Ÿä¸€å…¥å£ã€‚

```
src/sandbox/
â”‚
â”œâ”€â”€ __init__.py                # ä¸å˜
â”‚
â”œâ”€â”€ base.py                    # SandboxBase æŠ½è±¡åŸºç±»
â”‚   â”‚  ä¸å˜ï¼ˆ~100 è¡Œï¼‰
â”‚
â”œâ”€â”€ docker_sandbox.py          # DockerSandbox å®ç°
â”‚   â”‚  ä¸å˜ï¼ˆ~600 è¡Œï¼‰
â”‚
â”œâ”€â”€ e2b_sandbox.py             # E2BSandbox å®ç°
â”‚   â”‚  ä¸å˜ï¼ˆ~470 è¡Œï¼‰
â”‚
â”œâ”€â”€ manager.py                 # SandboxManager â€” L4 ç»Ÿä¸€å…¥å£ï¼ˆæ–°å»ºï¼‰
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šæ ¹æ®é…ç½®é€‰æ‹© Docker æˆ– E2Bï¼Œæä¾›ç»Ÿä¸€çš„
â”‚   â”‚       create / mount / exec / destroy æ¥å£
â”‚   â”‚
â”‚   â”‚  æ¥æºï¼šæ–°å»ºï¼ˆå°è£…ç°æœ‰ docker_sandbox + e2b_sandboxï¼‰
â”‚   â”‚  ~120 è¡Œ
â”‚   â”‚
â”‚   â”‚  æ ¸å¿ƒæ–¹æ³•ï¼š
â”‚   â”‚    async def create(image, resources) â†’ SandboxInstance
â”‚   â”‚    async def mount(sandbox, workspace_path, mount_point) â†’ None
â”‚   â”‚    async def exec(sandbox, command) â†’ ExecResult
â”‚   â”‚    async def destroy(sandbox) â†’ None
â”‚
â”œâ”€â”€ service.py                 # ç°æœ‰æ²™ç›’æœåŠ¡
â”‚   â”‚  ä¿ç•™ï¼ˆ~130 è¡Œï¼‰ï¼Œå†…éƒ¨ä½¿ç”¨ manager.py
â”‚
â”œâ”€â”€ file_utils.py              # æ–‡ä»¶å·¥å…·
â”‚   â”‚  ä¸å˜ï¼ˆ~270 è¡Œï¼‰
â”‚
â”œâ”€â”€ schemas.py                 # æ²™ç›’æ•°æ®æ¨¡å‹
â”‚   â”‚  ä¸å˜ï¼ˆ~20 è¡Œï¼‰
â”‚
â””â”€â”€ dependencies.py            # ä¾èµ–æ³¨å…¥
    â”‚  ä¸å˜ï¼ˆ~10 è¡Œï¼‰
```

#### é‡ç‚¹é‡æ„ï¼š`src/agent/` â€” ç¼–æ’å™¨

ä» 1487 è¡Œçš„ä¸Šå¸ç±»ç˜¦èº«ä¸ºçº¯ç¼–æ’é€»è¾‘ã€‚

```
src/agent/
â”‚
â”œâ”€â”€ __init__.py                # ä¸å˜
â”‚
â”œâ”€â”€ service.py                 # AgentOrchestrator â€” çº¯ç¼–æ’ï¼ˆé‡ç‚¹é‡æ„ï¼‰
â”‚   â”‚
â”‚   â”‚  å½“å‰ï¼š1487 è¡Œï¼ŒåŒ…å« L2+L2.5+L3+L4 æ‰€æœ‰é€»è¾‘
â”‚   â”‚  ç›®æ ‡ï¼š~500 è¡Œï¼Œåªåšæµç¨‹ç¼–æ’
â”‚   â”‚
â”‚   â”‚  èŒè´£ï¼šæŒ‰é¡ºåºè°ƒç”¨æ³¨å…¥çš„ç§¯æœ¨
â”‚   â”‚    1. L2.checkout() â†’ è·å–æ•°æ®+ç‰ˆæœ¬
â”‚   â”‚    2. L2.5.provision() â†’ å‡†å¤‡æœ¬åœ°å·¥ä½œåŒºï¼ˆå¯é€‰ï¼‰
â”‚   â”‚    3. L4.create()+mount() â†’ åˆ›å»ºæ²™ç›’ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚    4. L4.exec() â†’ æ‰§è¡Œ Agent å‘½ä»¤
â”‚   â”‚    5. L2.5.collect_changes() â†’ æ£€æµ‹æ”¹åŠ¨ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚    6. L2.commit() â†’ å†™å›ï¼ˆå«å†²çªè§£å†³ï¼‰
â”‚   â”‚    7. L4.destroy() â†’ æ¸…ç†ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚
â”‚   â”‚  ä¸å†åŒ…å«ï¼š
â”‚   â”‚    âœ— prepare_sandbox_data() â†’ ç§»åˆ° sync/service.py
â”‚   â”‚    âœ— build_name_path() â†’ ç§»åˆ° sync/service.py
â”‚   â”‚    âœ— _writeback_changes() â†’ ç§»åˆ° collaboration/service.py
â”‚   â”‚    âœ— SandboxFile ç±»å®šä¹‰ â†’ ç§»åˆ° sync/schemas.py
â”‚   â”‚    âœ— merge_daemon åˆå§‹åŒ– â†’ ç”± collaboration/ ç®¡ç†
â”‚   â”‚
â”‚   â”‚  ä¾èµ–æ³¨å…¥ï¼š
â”‚   â”‚    collab: CollaborationService (L2, å¿…é€‰)
â”‚   â”‚    sync: SyncService (L2.5, å¯é€‰)
â”‚   â”‚    sandbox: SandboxManager (L4, å¯é€‰)
â”‚
â”œâ”€â”€ router.py                  # SSE æµå¼è·¯ç”±
â”‚   â”‚  ä¸å˜ï¼ˆ~60 è¡Œï¼‰
â”‚
â”œâ”€â”€ schemas.py                 # Agent è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚  ä¸å˜ï¼ˆ~30 è¡Œï¼‰
â”‚
â”œâ”€â”€ dependencies.py            # ä¾èµ–æ³¨å…¥ï¼ˆæ›´æ–°ï¼‰
â”‚   â”‚  æ›´æ–°ï¼šæ³¨å…¥ CollaborationServiceã€SyncServiceã€SandboxManager
â”‚   â”‚  ~40 è¡Œ
â”‚
â”œâ”€â”€ config/                    # Agent é…ç½®ç®¡ç†ï¼ˆä¸å˜ï¼‰
â”‚   â”œâ”€â”€ service.py             # ä¸å˜
â”‚   â”œâ”€â”€ repository.py          # ä¸å˜
â”‚   â”œâ”€â”€ router.py              # ä¸å˜
â”‚   â”œâ”€â”€ models.py              # ä¸å˜
â”‚   â”œâ”€â”€ schemas.py             # ä¸å˜
â”‚   â””â”€â”€ dependencies.py        # ä¸å˜
â”‚
â””â”€â”€ chat/                      # èŠå¤©å†å²ï¼ˆä¸å˜ï¼‰
    â”œâ”€â”€ service.py             # ä¸å˜
    â”œâ”€â”€ repository.py          # ä¸å˜
    â”œâ”€â”€ schemas.py             # ä¸å˜
    â””â”€â”€ dependencies.py        # ä¸å˜
```

#### åºŸå¼ƒï¼š`src/workspace/` â€” æ•´ä½“æ‹†åˆ†ååˆ é™¤

```
src/workspace/                 # æ•´ä¸ªç›®å½•åœ¨è¿ç§»å®Œæˆååˆ é™¤
â”‚
â”œâ”€â”€ merge_daemon.py            â†’ è¿ç§»åˆ° collaboration/conflict_service.py
â”œâ”€â”€ sync_worker.py             â†’ è¿ç§»åˆ° sync/sync_worker.py
â”œâ”€â”€ apfs_provider.py           â†’ è¿ç§»åˆ° sync/providers/apfs.py
â”œâ”€â”€ fallback_provider.py       â†’ è¿ç§»åˆ° sync/providers/fallback.py
â”œâ”€â”€ provider.py                â†’ è¿ç§»åˆ° sync/workspace_provider.py
â””â”€â”€ router.py                  â†’ åˆå¹¶åˆ° collaboration/router.py æˆ–åˆ é™¤
```

#### ä¸å˜çš„æ¨¡å—ï¼ˆL1 / L3-API / åŸºç¡€è®¾æ–½ï¼‰

```
src/
â”œâ”€â”€ s3/                        # L1 â€” ä¸å˜
â”œâ”€â”€ supabase/                  # L1 â€” ä¸å˜
â”œâ”€â”€ auth/                      # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ config.py                  # æ–°å¢ SYNC_ENABLED / SANDBOX_TYPE é…ç½®é¡¹
â”œâ”€â”€ main.py                    # æ–°å¢ collaboration_router æ³¨å†Œ
â”œâ”€â”€ ingest/                    # L3-API â€” ä¸å˜
â”œâ”€â”€ project/                   # L3-API â€” ä¸å˜
â”œâ”€â”€ table/                     # L3-API â€” ä¸å˜
â”œâ”€â”€ tool/                      # L3-API â€” ä¸å˜
â”œâ”€â”€ mcp_v3/                    # L3-API â€” ä¸å˜
â”œâ”€â”€ oauth/                     # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ llm/                       # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ search/                    # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ chunking/                  # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ scheduler/                 # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ profile/                   # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ analytics/                 # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ context_publish/           # L3-API â€” ä¸å˜
â”œâ”€â”€ internal/                  # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ utils/                     # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â”œâ”€â”€ exception_handler.py       # åŸºç¡€è®¾æ–½ â€” ä¸å˜
â””â”€â”€ exceptions.py              # åŸºç¡€è®¾æ–½ â€” ä¸å˜
```

#### æ±‡æ€»ï¼šæ–‡ä»¶çº§è¿ç§»æ¸…å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¥æºæ–‡ä»¶                            â”‚ ç›®æ ‡æ–‡ä»¶                             â”‚ åŠ¨ä½œ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ workspace/merge_daemon.py          â”‚ collaboration/conflict_service.py   â”‚ è¿ç§»   â”‚
â”‚ content_node/version_service.py    â”‚ collaboration/version_service.py    â”‚ è¿ç§»   â”‚
â”‚ content_node/version_repository.py â”‚ collaboration/version_repository.py â”‚ è¿ç§»   â”‚
â”‚ content_node/version_schemas.py    â”‚ collaboration/schemas.py            â”‚ åˆå¹¶   â”‚
â”‚ content_node/version_router.py     â”‚ collaboration/router.py             â”‚ åˆå¹¶   â”‚
â”‚ workspace/sync_worker.py           â”‚ sync/sync_worker.py                 â”‚ è¿ç§»   â”‚
â”‚ workspace/provider.py              â”‚ sync/workspace_provider.py          â”‚ è¿ç§»   â”‚
â”‚ workspace/apfs_provider.py         â”‚ sync/providers/apfs.py              â”‚ è¿ç§»   â”‚
â”‚ workspace/fallback_provider.py     â”‚ sync/providers/fallback.py          â”‚ è¿ç§»   â”‚
â”‚ agent/service.py (writeback éƒ¨åˆ†)  â”‚ collaboration/service.py            â”‚ æå–   â”‚
â”‚ agent/service.py (sync éƒ¨åˆ†)       â”‚ sync/service.py                     â”‚ æå–   â”‚
â”‚ agent/service.py (ç¼–æ’éƒ¨åˆ†)         â”‚ agent/service.py (ä¿ç•™ï¼Œç˜¦èº«)        â”‚ ç²¾ç®€   â”‚
â”‚ ï¼ˆæ–°å»ºï¼‰                            â”‚ collaboration/service.py            â”‚ æ–°å»º   â”‚
â”‚ ï¼ˆæ–°å»ºï¼‰                            â”‚ collaboration/lock_service.py       â”‚ æ–°å»º   â”‚
â”‚ ï¼ˆæ–°å»ºï¼‰                            â”‚ collaboration/audit_service.py      â”‚ æ–°å»º   â”‚
â”‚ ï¼ˆæ–°å»ºï¼‰                            â”‚ collaboration/dependencies.py       â”‚ æ–°å»º   â”‚
â”‚ ï¼ˆæ–°å»ºï¼‰                            â”‚ sync/service.py                     â”‚ æ–°å»º   â”‚
â”‚ ï¼ˆæ–°å»ºï¼‰                            â”‚ sync/file_watcher.py               â”‚ æ–°å»º   â”‚
â”‚ ï¼ˆæ–°å»ºï¼‰                            â”‚ sync/dependencies.py               â”‚ æ–°å»º   â”‚
â”‚ ï¼ˆæ–°å»ºï¼‰                            â”‚ sandbox/manager.py                  â”‚ æ–°å»º   â”‚
â”‚ workspace/ (æ•´ä¸ªç›®å½•)               â”‚ ï¼ˆåˆ é™¤ï¼‰                             â”‚ åˆ é™¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 å®æ–½é˜¶æ®µ

```
Phase 1ï¼šæŠ½å‡º L2 CollaborationServiceï¼ˆ1-2 å¤©ï¼‰
  - æ–°å»º src/collaboration/
  - è¿ç§» version_service, merge_daemon é€»è¾‘
  - æ–°å¢ /api/v1/collab/* è·¯ç”±
  - AgentService çš„ writeback æ”¹ä¸ºè°ƒç”¨ CollaborationService
  - æµ‹è¯•ï¼šAPI æ¨¡å¼ï¼ˆæ¨¡å¼ Bï¼‰å¯ç›´æ¥ä½¿ç”¨ç‰ˆæœ¬ç®¡ç†å’Œå†²çªè§£å†³
  â†’ å®Œæˆåï¼šn8nã€Manusã€Lambda ç­‰çº¯ API åœºæ™¯å¯ç”¨

Phase 2ï¼šæŠ½å‡º L2.5 SyncServiceï¼ˆ1-2 å¤©ï¼‰
  - æ–°å»º src/sync/
  - è¿ç§» sync_worker, workspace providers
  - ä» AgentService å‰¥ç¦» prepare_sandbox_data
  - AgentService ç˜¦èº«ä¸ºç¼–æ’å™¨
  - æµ‹è¯•ï¼šSyncService å¯ç‹¬ç«‹è¿è¡Œ
  â†’ å®Œæˆåï¼šæœ¬åœ° Daemon æ¨¡å¼æœ‰ç‹¬ç«‹åŸºç¡€

Phase 3ï¼šå®Œå–„ L3-API collab è·¯ç”±ï¼ˆ0.5 å¤©ï¼‰
  - /api/v1/collab/checkout
  - /api/v1/collab/commit
  - /api/v1/collab/history/:nodeId
  - /api/v1/collab/rollback
  â†’ å®Œæˆåï¼šæ‰€æœ‰ API æ¥å…¥è€…å¯ç”¨ç‰ˆæœ¬ç®¡ç†

Phase 4ï¼šL3-SDKï¼ˆåç»­ï¼‰
  - contextbase Python åŒ…
  â†’ å®Œæˆåï¼šå¼€å‘è€…å‹å¥½çš„ SDK æ¥å…¥

Phase 5ï¼šOverlayFS ä¼˜åŒ–ï¼ˆåç»­ï¼‰
  - L2.5 çš„ WorkspaceProvider åŠ  OverlayFS ç­–ç•¥
  â†’ å®Œæˆåï¼šå¤§è§„æ¨¡åœºæ™¯ä¼˜åŒ–
```

---

## å…«ã€æ€»ç»“

| å±‚ | èŒè´£ | ä¸€å¥è¯ | æ˜¯å¦å¿…é€‰ |
|----|------|-------|---------|
| **L1 Storage** | æ•°æ®åœ¨å“ª | S3 å­˜æ–‡ä»¶ï¼ŒPG å­˜å…ƒæ•°æ® | å¿…é€‰ |
| **L2 Collaboration** | æ•°æ®æ€ä¹ˆç®¡ | ç‰ˆæœ¬ã€å†²çªã€æƒé™ã€å®¡è®¡ | å¿…é€‰ï¼ˆæ ¸å¿ƒå£å’ï¼‰ |
| **L2.5 Sync** | æ•°æ®æ€ä¹ˆæ¬ | äº‘ç«¯ â†” æœ¬åœ°åŒå‘åŒæ­¥ | ä»…æœ¬åœ°æ–‡ä»¶å¤¹æ¨¡å¼ |
| **L3 Interface** | æ•°æ®æ€ä¹ˆç»™ | API / æ–‡ä»¶å¤¹ / SDK ä¸‰é€‰ | å¿…é€‰å…¶ä¸€ |
| **L4 Sandbox** | Agent åœ¨å“ªè·‘ | Docker / E2B å®¹å™¨ | ä»…å†…ç½® CloudBot |

**äº§å“æ²¡æœ‰ L2.5 å’Œ L4**ï¼šAPI æ¨¡å¼å®Œæ•´å¯ç”¨ï¼ˆn8nã€Manusã€Lambda å…¨è¦†ç›–ï¼‰ã€‚
**äº§å“æœ‰ L2.5 æ—  L4**ï¼šæœ¬åœ°æ–‡ä»¶å¤¹æ¨¡å¼å®Œæ•´å¯ç”¨ï¼ˆOpenClawã€Claude Codeã€Cursor å…¨è¦†ç›–ï¼‰ã€‚
**äº§å“å…¨æœ‰**ï¼šå†…ç½® CloudBot å®Œæ•´ä½“éªŒã€‚