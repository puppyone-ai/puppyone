name: Batch Back-merge (prod)

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  batch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Resolve route (prod only; skip tmp-*)
        id: route
        uses: actions/github-script@v7
        with:
          script: |
            const src = context.ref.replace('refs/heads/','');
            if (src.startsWith('tmp-')) { core.setOutput('dest',''); return; }
            const map = { 'main':'convergency', 'convergency':'qubits' };
            // schedule runs on default branch only; for safety handle both
            const current = src || (process.env.GITHUB_REF_NAME || '');
            const dest = map[current] || '';
            core.setOutput('src', current);
            core.setOutput('dest', dest);

      - name: Skip if no route
        if: steps.route.outputs.dest == ''
        run: echo "No production route (or tmp-*), skipping." && exit 0

      - name: Path filter (non-critical)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            non_critical:
              - 'docs/**'
              - '.github/**'
              - '**/*.md'

      - name: Skip if nothing to sync
        if: steps.changes.outputs.non_critical != 'true'
        run: echo "No non-critical changes to batch-sync." && exit 0

      - name: Create/Update batch PR (draft)
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ steps.route.outputs.src }}
          destination_branch: ${{ steps.route.outputs.dest }}
          pr_title: "chore(batch-back-merge): ${{ steps.route.outputs.src }} â†’ ${{ steps.route.outputs.dest }}"
          pr_body: |
            Scheduled batch back-merge for non-critical changes (prod).
          pr_draft: true
          pr_label: "back-merge,chore"
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

