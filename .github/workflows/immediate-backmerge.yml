name: Immediate Back-merge (prod)

on:
  push:
    branches: [ main, convergency ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: immediate-backmerge-prod
  cancel-in-progress: false

jobs:
  backmerge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Resolve route (prod only; skip tmp-*)
        id: route
        uses: actions/github-script@v7
        with:
          script: |
            const src = context.ref.replace('refs/heads/','');
            if (src.startsWith('tmp-')) { core.setOutput('dest',''); return; }
            const map = { 'main':'convergency', 'convergency':'qubits' };
            core.setOutput('src', src);
            core.setOutput('dest', map[src] || '');

      - name: Skip if no route
        if: steps.route.outputs.dest == ''
        run: echo "No production route (or tmp-*), skipping." && exit 0

      - name: Path filter (critical)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            critical:
              - 'PuppyEngine/**'
              - 'PuppyStorage/**'
              - '!**/*.md'
              - '!.github/**'

      - name: Skip if not critical
        if: steps.changes.outputs.critical != 'true'
        run: echo "Non-critical change, skip immediate back-merge." && exit 0

      - name: Create/Update PR (draft, idempotent)
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ steps.route.outputs.src }}
          destination_branch: ${{ steps.route.outputs.dest }}
          pr_title: "chore(back-merge): ${{ steps.route.outputs.src }} â†’ ${{ steps.route.outputs.dest }}"
          pr_body: |
            Auto back-merge PR for critical changes (prod).

            - Source: `${{ github.sha }}`
            - Trigger: push to `${{ steps.route.outputs.src }}`
          pr_draft: true
          pr_label: "back-merge,chore"
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

