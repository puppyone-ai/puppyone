name: Back-merge PR (tmp-main → tmp-conv)

on:
  push:
    branches: [ tmp-main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: backmerge-tmp-main-to-tmp-conv
  cancel-in-progress: false

jobs:
  open-backmerge-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing PR and open if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          existing=$(gh pr list --base tmp-conv --head tmp-main --state open --json number -q 'length(.)')
          echo "Found $existing existing open PR(s) from tmp-main to tmp-conv"
          if [ "$existing" -gt 0 ]; then
            echo "Back-merge PR already exists. Skipping."
            exit 0
          fi

          gh pr create \
            --base tmp-conv \
            --head tmp-main \
            --title "chore(back-merge): tmp-main → tmp-conv" \
            --body "Auto back-merge PR to keep tmp-conv aligned with tmp-main.\n\n- Source: \`${{ github.sha }}\`\n- Trigger: push to \`tmp-main\`\n\nThis PR is generated by CI (dry-run) to validate back-merge behavior before production rollout." \
            --label back-merge \
            --label chore
