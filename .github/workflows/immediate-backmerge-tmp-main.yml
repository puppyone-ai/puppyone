name: Immediate Back-merge (tmp-main → tmp-conv)

on:
  push:
    branches: [ tmp-main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: immediate-backmerge-tmp-main
  cancel-in-progress: false

jobs:
  filter-and-backmerge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Path filter (critical)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            critical:
              - 'PuppyEngine/**'
              - 'PuppyStorage/**'
              - 'PuppyAgent-Jack/PuppyEngine/**'
              - '!**/*.md'
              - '!.github/**'

      - name: Skip if not critical
        if: steps.changes.outputs.critical != 'true'
        run: echo "No critical changes; skipping immediate back-merge." && exit 0

      - name: Find existing PR
        id: find
        uses: peter-evans/find-pull-request@v3
        with:
          base: tmp-conv
          head: tmp-main
          state: open

      - name: Create PR if missing (draft)
        if: steps.find.outputs.pull-request-number == ''
        uses: repo-sync/pull-request@v2
        with:
          source_branch: tmp-main
          destination_branch: tmp-conv
          pr_title: "chore(back-merge): tmp-main → tmp-conv"
          pr_body: |
            Auto back-merge PR for critical changes.

            - Source: `${{ github.sha }}`
            - Trigger: push to `tmp-main`
          pr_draft: true
          pr_label: "back-merge,chore"
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

      - name: Refresh PR number
        id: find2
        uses: peter-evans/find-pull-request@v3
        with:
          base: tmp-conv
          head: tmp-main
          state: open

      - name: Ensure base labels
        if: steps.find2.outputs.pull-request-number != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ steps.find2.outputs.pull-request-number }}
          labels: back-merge,chore
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

