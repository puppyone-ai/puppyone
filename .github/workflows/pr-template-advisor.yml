name: PR Template Advisor (comment-only)

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to check'
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-template-advisor-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: true

jobs:
  advise:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body and advise (no request-changes)
        uses: actions/github-script@v7
        with:
          script: |
            const prNumberInput = core.getInput('pr_number');
            let pr = context.payload.pull_request || null;
            if (!pr && prNumberInput) {
              const { data } = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: Number(prNumberInput) });
              pr = data;
            }
            if (!pr) return;

            const body = pr.body || '';
            const title = pr.title || '';
            const head = pr.head.ref || '';

            // Determine expected template type (supports feat/* and feat(scope):)
            const mapping = [
              { re: /^(feat|feature)\//i, type: 'feature' },
              { re: /^(fix|bugfix)\//i, type: 'bugfix' },
              { re: /^perf\//i, type: 'perf' },
              { re: /^(refactor|rfct)\//i, type: 'refactor' },
              { re: /^ci\//i, type: 'ci' },
              { re: /^docs\//i, type: 'docs' },
              { re: /^temp\//i, type: 'feature' },
            ];
            let expected = null;
            for (const m of mapping) { if (m.re.test(head)) { expected = m.type; break; } }
            const tl = title.toLowerCase();
            const titlePrefix = [
              { re: /^(feat|feature)(\([^)]*\))?:/, type: 'feature' },
              { re: /^fix(\([^)]*\))?:/, type: 'bugfix' },
              { re: /^perf(\([^)]*\))?:/, type: 'perf' },
              { re: /^refactor(\([^)]*\))?:/, type: 'refactor' },
              { re: /^ci(\([^)]*\))?:/, type: 'ci' },
              { re: /^docs(\([^)]*\))?:/, type: 'docs' },
            ];
            for (const p of titlePrefix) { if (p.re.test(tl)) expected = p.type; }

            if (!expected) return; // no-op if we can't infer

            function hasHeading(h) {
              const re = new RegExp(`^##\\s*${h.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')}\\s*$`, 'im');
              return re.test(body);
            }
            function missing(list) { return (list || []).filter(h => !hasHeading(h)); }

            const requiredByType = {
              feature: ['Summary', 'Background & Motivation', 'Goals / Non-goals', 'Proposed Changes', 'UX / UI', 'Test Plan'],
              bugfix: ['Issue Summary', 'Reproduction Steps', 'Root Cause Analysis', 'Fix Strategy', 'Verification', 'Risk & Mitigations'],
              perf: ['Performance Problem Statement', 'Bottleneck Analysis', 'Optimization Strategy', 'Before/After Metrics', 'Risk & Guardrails', 'Test Plan'],
              refactor: ['Motivation', 'Scope', 'Key Changes', 'Risk Assessment', 'Validation'],
              ci: ['Change Summary', 'Motivation', 'Impact', 'Security & Permissions', 'Rollback Strategy', 'Validation'],
              docs: ['Documentation Summary', 'Scope', 'Rationale', 'Accuracy & Consistency', 'Verification'],
            };
            const required = requiredByType[expected] || [];
            const missingHeaders = missing(required);

            const templateLink = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/qubits/.github/PULL_REQUEST_TEMPLATE/${expected}.md`;
            const adviseBody = missingHeaders.length
              ? `<!-- PR_TEMPLATE_ADVISOR -->\nHi @${pr.user.login} â€” please update the PR description to follow the ${expected} template.\n\nTemplate: ${templateLink}\n\nMissing sections:\n${missingHeaders.map(h => `- ${h}`).join('\n')}`
              : `<!-- PR_TEMPLATE_ADVISOR -->All required sections for ${expected} seem present. Thanks!`;

            // Upsert a single advisory comment (no review requests)
            const { data: comments } = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, per_page: 100 });
            const mine = comments.find(c => c.user.type === 'Bot' && c.body?.includes('PR_TEMPLATE_ADVISOR'));
            if (mine) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: mine.id, body: adviseBody });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body: adviseBody });
            }
