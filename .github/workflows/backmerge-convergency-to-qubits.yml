name: Back-merge PR (convergency → qubits)

on:
  push:
    branches: [ convergency ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: backmerge-convergency-to-qubits
  cancel-in-progress: false

jobs:
  open-backmerge-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing PR and open if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # List any existing open PRs from convergency → qubits
          existing=$(gh pr list --base qubits --head convergency --state open --json number -q 'length(.)')
          echo "Found $existing existing open PR(s) from convergency to qubits"
          if [ "$existing" -gt 0 ]; then
            echo "Back-merge PR already exists. Skipping."
            exit 0
          fi

          # Create back-merge PR
          gh pr create \
            --base qubits \
            --head convergency \
            --title "chore(back-merge): convergency → qubits" \
            --body "Auto back-merge PR to keep qubits aligned with convergency.\n\n- Source: \`${{ github.sha }}\`\n- Trigger: push to \`convergency\`\n\nThis PR is generated by CI to promote changes downstream for dev alignment." \
            --label back-merge \
            --label chore

