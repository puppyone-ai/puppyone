name: Back-merge PR (tmp-conv → tmp-qubits)

on:
  push:
    branches: [ tmp-conv ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: backmerge-tmp-conv-to-tmp-qubits
  cancel-in-progress: false

jobs:
  open-backmerge-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing PR and open if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          existing=$(gh pr list --base tmp-qubits --head tmp-conv --state open --json number -q 'length(.)')
          echo "Found $existing existing open PR(s) from tmp-conv to tmp-qubits"
          if [ "$existing" -gt 0 ]; then
            echo "Back-merge PR already exists. Skipping."
            exit 0
          fi

          gh pr create \
            --base tmp-qubits \
            --head tmp-conv \
            --title "chore(back-merge): tmp-conv → tmp-qubits" \
            --body "Auto back-merge PR to keep tmp-qubits aligned with tmp-conv.\n\n- Source: \`${{ github.sha }}\`\n- Trigger: push to \`tmp-conv\`\n\nThis PR is generated by CI (dry-run) to validate back-merge behavior before production rollout." \
            --label back-merge \
            --label chore
