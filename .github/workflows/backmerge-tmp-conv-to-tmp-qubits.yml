name: Back-merge PR (tmp-conv → tmp-qubits)

on:
  push:
    branches: [ tmp-conv ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: backmerge-tmp-conv-to-tmp-qubits
  cancel-in-progress: false

jobs:
  open-backmerge-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure PR exists (create if missing)
        id: ensure
        uses: actions/github-script@v7
        env:
          BASE: tmp-qubits
          HEAD: tmp-conv
        with:
          github-token: ${{ secrets.BACKMERGE_TOKEN }}
          script: |
            const base = process.env.BASE;
            const head = process.env.HEAD;
            const { owner, repo } = context.repo;
            const headRef = `${owner}:${head}`;
            let found = false;
            try {
              const prs = await github.rest.pulls.list({ owner, repo, base, head: headRef, state: 'open' });
              if (prs.data && prs.data.length > 0) {
                core.setOutput('pr_number', prs.data[0].number.toString());
                core.setOutput('pr_url', prs.data[0].html_url);
                core.info(`Existing PR found: #${prs.data[0].number} ${prs.data[0].html_url}`);
                found = true;
              }
            } catch (err) {
              core.warning(`List PRs failed (will try create): ${err}`);
            }
            if (!found) {
              const title = `chore(back-merge): ${head} → ${base}`;
              const body = `Auto back-merge PR to keep ${base} aligned with ${head}.\n\n- Source: \`${context.sha}\`\n- Trigger: push to \`${head}\`\n\nThis PR is generated by CI (dry-run) to validate back-merge behavior before production rollout.`;
              try {
                const pr = await github.rest.pulls.create({ owner, repo, base, head, title, body });
                core.setOutput('pr_number', pr.data.number.toString());
                core.setOutput('pr_url', pr.data.html_url);
                core.info(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
              } catch (err) {
                core.setFailed(`Create PR failed: ${err}`);
              }
            }
      - name: Add labels to PR
        if: steps.ensure.outputs.pr_number != ''
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.ensure.outputs.pr_number }}
        with:
          github-token: ${{ secrets.BACKMERGE_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.addLabels({ owner, repo, issue_number: Number(process.env.PR_NUMBER), labels: ['back-merge','chore'] });
