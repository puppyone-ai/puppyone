name: Template Feedback

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  schedule:
    - cron: "0 2 * * MON" # Mondays 10:00 CST
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  collect:
    if: ${{ github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment' }}
    runs-on: ubuntu-latest
    steps:
      - name: Collect /tf feedback
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.comment?.body || '').trim();
            if (!/^\/tf(\s|$)/i.test(body)) return;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // Determine PR number from issue or review comment
            let prNumber = context.payload.issue?.number || null;
            if (!prNumber && context.payload.pull_request) prNumber = context.payload.pull_request.number;
            if (!prNumber && context.payload.review?.pull_request_url) {
              prNumber = Number(context.payload.review.pull_request_url.split('/').pop());
            }
            if (!prNumber) return;

            const { data: pr } = await github.pulls.get({ owner, repo, pull_number: prNumber });
            const head = pr.head.ref || '';
            const author = context.payload.comment.user.login;

            const mapping = [
              { re: /^feature\//i, type: 'feature' },
              { re: /^fix\//i, type: 'bugfix' },
              { re: /^perf\//i, type: 'perf' },
              { re: /^(refactor|rfct)\//i, type: 'refactor' },
              { re: /^ci\//i, type: 'ci' },
              { re: /^docs\//i, type: 'docs' },
            ];
            let type = 'feature';
            for (const m of mapping) if (m.re.test(head)) { type = m.type; break; }

            const text = body.replace(/^\/tf\s*/i, '').trim() || '_No details provided_';
            const title = `Template feedback: ${type} from PR #${prNumber}`;
            const search = await github.search.issuesAndPullRequests({ q: `repo:${owner}/${repo} in:title "${title}" is:issue` });
            const existing = search.data.items[0];

            const md = `<!-- TEMPLATE_FEEDBACK pr:${prNumber} -->\nFrom PR #${prNumber} (${head}) by @${author}\n\n${text}\n`;

            if (!existing) {
              await github.issues.create({ owner, repo, title, labels: ['template:feedback', `template:type:${type}`, 'docs'], body: md });
            } else {
              await github.issues.createComment({ owner, repo, issue_number: existing.number, body: md });
            }

            await github.reactions.createForIssueComment({ owner, repo, comment_id: context.payload.comment.id, content: 'eyes' });

  digest:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Weekly digest
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const since = new Date(Date.now() - 7*24*60*60*1000).toISOString();
            const q = `repo:${owner}/${repo} is:issue label:"template:feedback" updated:>=${since}`;
            const { data: res } = await github.search.issuesAndPullRequests({ q, per_page: 100 });

            const byType = {};
            for (const it of res.items) {
              const labels = (it.labels || []).map(l => typeof l === 'string' ? l : l.name);
              const typeLabel = labels.find(n => n.startsWith('template:type:')) || 'template:type:unknown';
              byType[typeLabel] = byType[typeLabel] || [];
              byType[typeLabel].push(it);
            }

            let body = `## Weekly Template Feedback Digest\nSince ${since}\n\n`;
            for (const [k, items] of Object.entries(byType)) {
              body += `### ${k.replace('template:type:','')}: ${items.length}\n`;
              for (const it of items.slice(0, 10)) body += `- #${it.number} ${it.title}\n`;
              body += '\n';
            }

            const hubTitle = 'Template Feedback Hub';
            const search = await github.search.issuesAndPullRequests({ q: `repo:${owner}/${repo} is:issue in:title "${hubTitle}" state:open`, per_page: 1 });
            const hub = search.data.items[0];
            if (hub) {
              await github.issues.createComment({ owner, repo, issue_number: hub.number, body });
            }
