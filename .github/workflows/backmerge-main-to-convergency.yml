name: Back-merge PR (main → convergency)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: backmerge-main-to-convergency
  cancel-in-progress: false

jobs:
  open-backmerge-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing PR and open if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # List any existing open PRs from main → convergency
          existing=$(gh pr list --base convergency --head main --state open --json number -q 'length(.)')
          echo "Found $existing existing open PR(s) from main to convergency"
          if [ "$existing" -gt 0 ]; then
            echo "Back-merge PR already exists. Skipping."
            exit 0
          fi

          # Create back-merge PR
          gh pr create \
            --base convergency \
            --head main \
            --title "chore(back-merge): main → convergency" \
            --body "Auto back-merge PR to keep convergency aligned with main.\n\n- Source: \`${{ github.sha }}\`\n- Trigger: push to \`main\`\n\nThis PR is generated by CI to promote changes downstream for stage validation." \
            --label back-merge \
            --label chore

