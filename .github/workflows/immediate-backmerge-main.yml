name: Immediate Back-merge (main → convergency)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: immediate-backmerge-main
  cancel-in-progress: false

jobs:
  backmerge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Path filter (critical)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            critical:
              - 'PuppyEngine/**'
              - 'PuppyStorage/**'
              - '!**/*.md'
              - '!.github/**'

      - name: Skip if not critical
        if: steps.changes.outputs.critical != 'true'
        run: echo "No critical changes; skip back-merge." && exit 0

      - name: Wait required check (optional)
        id: wait
        uses: lewagon/wait-on-check-action@v1.3.3
        continue-on-error: true
        with:
          ref: ${{ github.sha }}
          check-name: Build and Test Check
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success
          timeout: 900

      - name: Create PR (draft, idempotent)
        uses: repo-sync/pull-request@v2
        with:
          source_branch: main
          destination_branch: convergency
          pr_title: "chore(back-merge): main → convergency"
          pr_body: |
            Auto back-merge PR for critical changes.

            - Source: `${{ github.sha }}`
            - Trigger: push to `main`
          pr_draft: true
          pr_label: "back-merge,chore"
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

      - name: Find PR number
        id: find
        uses: peter-evans/find-pull-request@v3
        with:
          base: convergency
          head: main
          state: open

      - name: Add do-not-merge if checks not green
        if: steps.wait.outcome != 'success' && steps.find.outputs.pull-request-number != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ steps.find.outputs.pull-request-number }}
          labels: do-not-merge
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

      - name: Remove do-not-merge if checks green
        if: steps.wait.outcome == 'success' && steps.find.outputs.pull-request-number != ''
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          number: ${{ steps.find.outputs.pull-request-number }}
          labels: do-not-merge
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

