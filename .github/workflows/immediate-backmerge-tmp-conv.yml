name: Immediate Back-merge (tmp-conv → tmp-qubits)

on:
  push:
    branches: [ tmp-conv ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: immediate-backmerge-tmp-conv
  cancel-in-progress: false

jobs:
  filter-and-backmerge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Path filter (critical)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            critical:
              - 'PuppyEngine/**'
              - 'PuppyStorage/**'
              - 'PuppyAgent-Jack/PuppyEngine/**'
              - '!**/*.md'
              - '!.github/**'

      - name: Skip if not critical
        if: steps.changes.outputs.critical != 'true'
        run: echo "No critical changes; skipping immediate back-merge." && exit 0

      - name: Wait required check (optional)
        id: wait
        uses: lewagon/wait-on-check-action@v1
        continue-on-error: true
        with:
          ref: ${{ github.sha }}
          check-name: Build and Test Check
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success
          timeout: 900

      - name: Find existing PR
        id: find
        uses: peter-evans/find-pull-request@v3
        with:
          base: tmp-qubits
          head: tmp-conv
          state: open

      - name: Create PR if missing (draft)
        if: steps.find.outputs.pull-request-number == ''
        uses: repo-sync/pull-request@v2
        with:
          source_branch: tmp-conv
          destination_branch: tmp-qubits
          pr_title: "chore(back-merge): tmp-conv → tmp-qubits"
          pr_body: |
            Auto back-merge PR for critical changes.

            - Source: `${{ github.sha }}`
            - Trigger: push to `tmp-conv`
          pr_draft: true
          pr_label: "back-merge,chore"
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

      - name: Refresh PR number
        id: find2
        uses: peter-evans/find-pull-request@v3
        with:
          base: tmp-qubits
          head: tmp-conv
          state: open

      - name: Add do-not-merge if checks not green
        if: steps.wait.outcome != 'success' && steps.find2.outputs.pull-request-number != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ steps.find2.outputs.pull-request-number }}
          labels: do-not-merge
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

      - name: Remove do-not-merge if checks green
        if: steps.wait.outcome == 'success' && steps.find2.outputs.pull-request-number != ''
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          number: ${{ steps.find2.outputs.pull-request-number }}
          labels: do-not-merge
          github_token: ${{ secrets.BACKMERGE_TOKEN }}

