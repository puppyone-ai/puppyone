name: Immediate Back-merge (tmp-conv → tmp-qubits)

on:
  push:
    branches: [ tmp-conv ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: immediate-backmerge-tmp-conv
  cancel-in-progress: false

jobs:
  filter-and-backmerge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Path filter (critical)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            critical:
              - 'PuppyEngine/**'
              - 'PuppyStorage/**'
              - 'PuppyAgent-Jack/PuppyEngine/**'
              - '!**/*.md'
              - '!.github/**'

      - name: Skip if not critical
        if: steps.changes.outputs.critical != 'true'
        run: echo "No critical changes; skipping immediate back-merge." && exit 0

      - name: Ensure upstream checks are green
        id: checks
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BACKMERGE_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;
            const res = await github.rest.checks.listForRef({ owner, repo, ref: sha });
            const required = res.data.check_runs.filter(r => r.app && r.app.slug !== 'dependabot');
            const failed = required.filter(r => ['failure','timed_out','cancelled','action_required'].includes(r.conclusion));
            if (failed.length > 0) {
              core.setOutput('all_green','false');
            } else {
              const pending = required.filter(r => !r.conclusion);
              core.setOutput('all_green', pending.length === 0 ? 'true' : 'false');
            }

      - name: Create draft PR (or ensure exists)
        if: steps.checks.outputs.all_green == 'true'
        id: ensure
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BACKMERGE_TOKEN }}
          script: |
            const base = 'tmp-qubits';
            const head = 'tmp-conv';
            const { owner, repo } = context.repo;
            const headRef = `${owner}:${head}`;
            const title = `chore(back-merge): ${head} → ${base}`;
            const body = `Auto back-merge PR (critical).\n\n- Source: \`${context.sha}\``;
            const prs = await github.rest.pulls.list({ owner, repo, base, head: headRef, state: 'open' });
            if (prs.data && prs.data.length > 0) {
              core.setOutput('pr_number', prs.data[0].number.toString());
              core.setOutput('pr_url', prs.data[0].html_url);
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, base, head, title, body, draft: true });
              core.setOutput('pr_number', pr.data.number.toString());
              core.setOutput('pr_url', pr.data.html_url);
            }

      - name: Label PR
        if: steps.ensure.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BACKMERGE_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.addLabels({ owner, repo, issue_number: Number(process.env.PR_NUMBER), labels: ['back-merge','chore'] });
        env:
          PR_NUMBER: ${{ steps.ensure.outputs.pr_number }}

      - name: If checks not green, open draft + do-not-merge
        if: steps.checks.outputs.all_green != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BACKMERGE_TOKEN }}
          script: |
            const base = 'tmp-qubits';
            const head = 'tmp-conv';
            const { owner, repo } = context.repo;
            const headRef = `${owner}:${head}`;
            const title = `chore(back-merge): ${head} → ${base}`;
            const body = `Auto back-merge PR (critical) - upstream checks not green.\n\n- Source: \`${context.sha}\``;
            const prs = await github.rest.pulls.list({ owner, repo, base, head: headRef, state: 'open' });
            let number = null; let url = null;
            if (prs.data && prs.data.length > 0) {
              number = prs.data[0].number; url = prs.data[0].html_url;
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, base, head, title, body, draft: true });
              number = pr.data.number; url = pr.data.html_url;
            }
            await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: ['back-merge','chore','do-not-merge'] });

