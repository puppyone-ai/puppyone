# Rich JSON Form Tree Style - 树结构编辑器设计文档

## 核心设计理念

### 树形结构的优势
与表格样式不同，树结构编辑器采用层次化的可视展示方式，更直观地反映 JSON 数据的嵌套关系。通过折叠/展开节点，用户可以专注于特定层级的数据，避免被复杂结构干扰。

### 设计哲学
- **层次化导航**：通过树形结构自然展示数据层级关系
- **渐进式披露**：支持节点折叠，按需展示详细信息
- **空间高效**：树形布局更好地利用垂直空间
- **认知友好**：符合用户对层次结构的直觉理解

## 核心元素类型及视觉设计

### 1. Text 元素（叶子节点）

#### 视觉外观
```
    ├── 📄 "Hello World"                    ← 叶子图标 + 文本内容
    │   └─ [编辑区域，点击展开Monaco编辑器]
```

**详细样式规格**：
- **节点图标**: 📄 (浅灰色，#6B7280)
- **连接线**: `#E5E7EB` 1px实线
- **文本样式**: `#374151` 14px 常规字体
- **悬停效果**: 背景 `#F9FAFB`，文本变为可编辑状态
- **编辑状态**: 展开Monaco编辑器，支持语法高亮
- **内边距**: 4px (上下) × 8px (左右)

#### 交互逻辑
1. **单击编辑**: 点击文本区域直接进入Monaco Editor编辑模式
2. **键盘导航**: 支持Tab键在节点间移动
3. **快速编辑**: 双击开始行内编辑，Enter确认，Esc取消

### 2. Dict 元素（对象节点）

#### 视觉外观
```
    ├── 📁 Object (3 items)                 ← 对象图标 + 项目数量
    │   ├── 🔑 name: "John Doe"             ← 键值对展示
    │   ├── 🔑 age: 25
    │   ├── 📁 profile                      ← 嵌套对象
    │   │   ├── 🔑 email: "john@example.com"
    │   │   └── 📁 settings                 ← 更深层嵌套
    │   │       ├── 🔑 theme: "dark"
    │   │       └── 🔑 language: "zh-CN"
    │   └── ➕ 添加新属性
```

**详细样式规格**：
- **节点图标**: 📁 (展开状态) / 📂 (折叠状态)，紫色 `#8B5CF6`
- **键图标**: 🔑 浅紫色 `#A78BFA`
- **键名样式**: 紫色 `#7C3AED`，14px 中等字重
- **计数显示**: `(n items)` 灰色 `#6B7280` 12px
- **缩进规则**: 每层级增加24px左缩进
- **连接线**: L形连接线，清晰显示父子关系

#### 键值对操作逻辑
1. **展开/折叠**: 点击节点图标切换显示状态
2. **键名编辑**: 双击键名进入编辑状态，支持重命名
3. **添加属性**: 点击 ➕ 图标在对象末尾添加新键值对
4. **拖拽排序**: 支持拖拽键值对调整顺序

### 3. List 元素（数组节点）

#### 视觉外观
```
    ├── 📋 Array (2 items)                  ← 数组图标 + 元素数量
    │   ├── [0] 📄 "First item"             ← 索引显示 + 元素内容
    │   ├── [1] 📁 Nested Object            ← 数组中的嵌套对象
    │   │   ├── 🔑 type: "example"
    │   │   └── 🔑 value: 123
    │   └── ➕ 添加新元素
```

**详细样式规格**：
- **节点图标**: 📋 橙色 `#F59E0B`
- **索引样式**: `[n]` 橙色 `#D97706`，12px 等宽字体
- **索引框**: 圆角矩形背景 `#FEF3C7`，padding: 2px 6px
- **计数显示**: `(n items)` 灰色 `#6B7280` 12px
- **元素间距**: 每个数组元素间有4px垂直间距

#### 索引管理逻辑
1. **自动编号**: 索引从0开始，插入删除后自动重新编号
2. **拖拽重排**: 支持拖拽数组元素改变顺序
3. **类型灵活**: 数组元素可以是任意类型，混合显示
4. **批量操作**: 支持选择多个元素进行批量删除或移动

### 4. Empty 元素（空值选择器）

#### 视觉外观
```
    ├── ❓ 选择数据类型
    │   └── [📄 Text] [📁 Object] [📋 Array]     ← 类型选择按钮
```

**类型选择设计**：
- **Text**: 📄 + "文本" 按钮，灰色主题
- **Object**: 📁 + "对象" 按钮，紫色主题  
- **Array**: 📋 + "数组" 按钮，橙色主题
- **按钮样式**: 圆角边框，悬停时填充对应主题色

## 树形导航系统

### 节点展开/折叠机制

#### 1. 展开状态指示
```
📁 Users (展开)                           📂 Users (折叠)
├── 🔑 name                              └── (2 items)
└── 🔑 age
```

#### 2. 深度层级控制
- **最大显示深度**: 默认展开3层，更深层级折叠显示
- **智能展开**: 编辑操作会自动展开相关路径
- **记忆状态**: 用户手动展开/折叠状态会被记住
- **全部展开/折叠**: 提供快捷按钮控制整树显示

### 树形布局特点

#### 连接线系统
```
Root Object
├── profile
│   ├── basic_info
│   │   ├── name
│   │   └── age  
│   └── settings
│       └── theme
└── permissions
    ├── read: true
    └── write: false
```

**连接线样式**：
- **颜色**: `#E5E7EB` (浅灰色)
- **宽度**: 1px
- **样式**: 实线，L形连接
- **对齐**: 精确对齐到图标中心

#### 缩进和间距
- **基础缩进**: 20px
- **每级增量**: 24px
- **节点高度**: 28px (最小行高)
- **图标尺寸**: 16×16px
- **图标边距**: 右侧8px间距

## 拖拽移动系统

### 树形拖拽特性

#### 1. 节点拖拽反馈
```
拖拽中:
  ┌─────────────────┐
  │ 🔑 name: "Alice" │  ← 跟随鼠标的预览卡片
  └─────────────────┘

目标位置:
├── profile
│   ├── 🔑 age: 25
│   ┃ ━━━━━━━━━━━━━━   ← 蓝色粗线表示插入位置  
│   └── 🔑 email: "..."
```

#### 2. 放置区域指示
- **有效放置**: 蓝色粗线 `#3B82F6` 2px，位置精确指示
- **无效放置**: 红色虚线 `#EF4444` + 禁止图标 🚫
- **层级调整**: 拖拽到不同层级会显示目标层级预览

### 跨节点移动逻辑

#### Object 内移动
1. **同级移动**: 保持键名，仅调整显示顺序
2. **跨级移动**: 
   - 目标层级无键名冲突：保持原键名
   - 键名冲突：自动生成 `key_[随机6位]` 格式的新键名
   - 显示冲突提示：`⚠️ 键名已存在，已重命名为 name_abc123`

#### Array 内移动  
1. **元素重排**: 直接调整索引位置，其他元素索引自动调整
2. **跨数组移动**: 从源数组删除，目标数组插入到指定位置

#### 跨类型移动
- **Object → Array**: 仅保留值，丢弃键名，获得新索引
- **Array → Object**: 生成随机键名，值保持不变
- **深层节点移动**: 支持任意深度的节点拖拽到任意位置

## 上下文菜单系统

### 右键菜单触发
每个节点右键点击显示上下文菜单：

```
┌─────────────────┐
│ 📋 复制节点      │
│ ✂️ 剪切节点      │
│ 📄 复制路径      │  ← 复制JSON路径，如 data.users[0].name
│ ├──────────────  │
│ ➕ 添加兄弟节点   │  ← 在同级添加新节点
│ ➕ 添加子节点     │  ← 在当前节点下添加子节点
│ ├──────────────  │
│ 🔄 更改类型      │
│ 🧹 清空内容      │
│ 🗑️ 删除节点      │
└─────────────────┘
```

### 操作详细说明

#### 复制操作
- **复制节点**: 复制完整的JSON结构到剪贴板
- **复制路径**: 复制如 `data.users[0].name` 格式的访问路径
- **格式化**: 支持美化格式和紧凑格式两种输出

#### 添加操作
- **添加兄弟节点**: 在当前节点同级别添加新节点
- **添加子节点**: 仅对Object和Array有效，在其内部添加新项目
- **智能定位**: 新添加的节点自动获得焦点，便于立即编辑

#### 修改操作
- **更改类型**: 弹出类型选择器，支持Text/Object/Array互转
- **清空内容**: 
  - Text → 空字符串 `""`
  - Object → 空对象 `{}`，显示 "空对象，点击添加属性"
  - Array → 空数组 `[]`，显示 "空数组，点击添加元素"

## 搜索与过滤系统

### 树形搜索功能

#### 搜索界面
```
┌─ 搜索框 ──────────────────────────┐
│ 🔍 输入关键词...  [🔍] [✗]        │  ← 搜索输入框
├──────────────────────────────────│
│ 📊 找到 3 个结果                  │  ← 结果统计
│ ├── 🔑 users[0].name              │  ← 搜索结果路径
│ ├── 🔑 users[1].name              │
│ └── 🔑 settings.username          │
└──────────────────────────────────┘
```

#### 搜索特性
1. **实时搜索**: 输入即搜，无需等待
2. **多类型匹配**: 支持搜索键名、值内容、数据类型
3. **路径显示**: 显示每个匹配项的完整JSON路径
4. **结果导航**: 点击结果自动定位并高亮对应节点

### 过滤显示

#### 搜索高亮
```
├── 📁 users
│   ├── [0] 📁 User Object
│   │   ├── 🔑 [name]: "Alice"      ← 黄色高亮匹配的键
│   │   └── 🔑 age: 25
│   └── [1] 📁 User Object  
│       └── 🔑 [name]: "Bob"        ← 高亮匹配的键
```

#### 过滤模式
- **仅显示匹配**: 隐藏不匹配的分支，只展示包含搜索结果的路径
- **高亮显示**: 保持完整树形结构，仅高亮匹配项
- **路径展开**: 自动展开包含搜索结果的所有父级节点

## 键盘快捷键支持

### 导航快捷键
- `↑/↓`: 在同级节点间移动
- `←/→`: 折叠/展开当前节点
- `Tab/Shift+Tab`: 深度优先遍历节点
- `Home/End`: 跳到同级节点的首/尾
- `Ctrl+↑/↓`: 跳到父/子节点

### 操作快捷键  
- `Enter`: 开始编辑当前节点
- `Esc`: 取消编辑，返回导航模式
- `F2`: 重命名键名 (对象属性)
- `Del`: 删除当前节点
- `Ctrl+C/V/X`: 复制/粘贴/剪切节点

### 快速添加
- `Ctrl+N`: 添加兄弟节点
- `Ctrl+Shift+N`: 添加子节点
- `Alt+1/2/3`: 快速创建Text/Object/Array类型

## 空状态处理和错误提示

### 空树状态
```
┌─────────────────────────────────────┐
│             📁 空的JSON对象          │
│                                     │
│         [📄 文本] [📁 对象] [📋 数组] │  ← 初始类型选择
│                                     │  
│            点击开始编辑JSON          │
└─────────────────────────────────────┘
```

### JSON解析错误
```
├── ⚠️ JSON 解析错误
│   └── 📄 { "name": "John           ← 显示错误的JSON片段
│       ⌃ 第1行第16列: 缺少结束引号   ← 具体错误位置和描述
```

### 数据验证提示
```
├── ⚠️ 数据验证警告
│   ├── 🔑 email: "not-an-email"     ← 无效的邮箱格式
│   └── 💡 建议: 请输入有效的邮箱地址
```

## 高级功能特性

### 树形结构优化

#### 虚拟滚动
- **大数据支持**: 超过100个节点时启用虚拟滚动
- **流畅体验**: 仅渲染可见区域的节点
- **内存效率**: 大幅降低大型JSON文件的内存占用

#### 懒加载展开
- **按需加载**: 大型对象/数组的子节点按需展开
- **性能优化**: 避免一次性渲染过多节点
- **用户体验**: 展开操作保持流畅响应

### 数据导入导出

#### 支持格式
- **JSON**: 标准JSON格式导入导出
- **YAML**: 支持YAML格式转换
- **CSV**: 扁平化结构的CSV导入导出
- **XML**: 基本的XML结构转换

#### 导出选项
```
┌─ 导出选项 ────────────────────────┐
│ □ 包含注释                        │
│ □ 紧凑格式 (无缩进)               │
│ ☑ 美化格式 (2空格缩进)            │
│ □ 排序键名                        │
│                                  │
│ [📋 复制到剪贴板] [📁 下载文件]   │
└──────────────────────────────────┘
```

### 协作功能

#### 多用户编辑
- **冲突检测**: 自动检测同时编辑的冲突
- **变更提示**: 实时显示其他用户的编辑位置
- **版本合并**: 智能合并多用户的编辑结果

#### 变更历史
```
├── 📅 编辑历史
│   ├── 🕒 10:30 添加用户Alice (张三)
│   ├── 🕒 10:25 修改年龄字段 (李四)  
│   └── 🕒 10:20 创建用户对象 (王五)
```

## 复杂嵌套结构示例

### 深层嵌套展示
```json
{
  "application": {
    "database": {
      "connections": [
        {
          "name": "primary",
          "config": {
            "host": "localhost",
            "credentials": {
              "username": "admin",
              "password": "secure123",
              "permissions": {
                "read": ["users", "products"],
                "write": ["logs", "cache"],
                "admin": {
                  "backup": true,
                  "restore": true,
                  "monitoring": {
                    "alerts": {
                      "email": ["admin@company.com"],
                      "sms": ["+1234567890"],
                      "webhook": {
                        "url": "https://api.company.com/alerts",
                        "headers": {
                          "Authorization": "Bearer token123",
                          "Content-Type": "application/json"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      ]
    }
  }
}
```

#### 树形结构可视化渲染
```
📁 application (1 item)
└── 📁 database (1 item)
    └── 📋 connections (1 item)
        └── [0] 📁 Connection Object (2 items)
            ├── 🔑 name: "primary"
            └── 📁 config (2 items)
                ├── 🔑 host: "localhost"
                └── 📁 credentials (2 items)
                    ├── 🔑 username: "admin"
                    ├── 🔑 password: "secure123"
                    └── 📁 permissions (3 items)
                        ├── 📋 read (2 items)
                        │   ├── [0] 📄 "users"
                        │   └── [1] 📄 "products"
                        ├── 📋 write (2 items)
                        │   ├── [0] 📄 "logs"
                        │   └── [1] 📄 "cache"
                        └── 📁 admin (3 items)
                            ├── 🔑 backup: true
                            ├── 🔑 restore: true
                            └── 📁 monitoring (1 item)
                                └── 📁 alerts (3 items)
                                    ├── 📋 email (1 item)
                                    │   └── [0] 📄 "admin@company.com"
                                    ├── 📋 sms (1 item)
                                    │   └── [0] 📄 "+1234567890"
                                    └── 📁 webhook (2 items)
                                        ├── 🔑 url: "https://api..."
                                        └── 📁 headers (2 items)
                                            ├── 🔑 Authorization: "Bearer..."
                                            └── 🔑 Content-Type: "application/json"
```

### 复杂操作场景

#### 场景1: 深层节点重组
**操作**: 将深层的 `webhook` 对象提升到 `alerts` 同级

**拖拽过程可视化**:
```
拖拽前 (webhook 在第6层):
└── 📁 alerts
    ├── 📋 email  
    ├── 📋 sms
    └── 📁 webhook ← 拖拽起点

拖拽中:
┌─────────────────────┐
│ 📁 webhook (2 items) │ ← 预览卡片跟随鼠标
└─────────────────────┘

目标位置 (提升到第5层):
└── 📁 monitoring
    ├── 📁 alerts
    │   ├── 📋 email
    │   └── 📋 sms  
    ┃ ━━━━━━━━━━━━━━━━━━━ ← 蓝色插入线
    └── ➕ 添加新属性

拖拽完成:
└── 📁 monitoring  
    ├── 📁 alerts (2 items) ← 子项减少
    │   ├── 📋 email
    │   └── 📋 sms
    └── 📁 webhook (2 items) ← 新位置
        ├── 🔑 url
        └── 📁 headers
```

#### 场景2: 数组类型转换
**操作**: 将简单字符串数组转换为对象数组

**转换过程**:
```
原始状态:
├── 📋 read (2 items)
│   ├── [0] 📄 "users"
│   └── [1] 📄 "products"

用户操作:
1. 右键点击 read[0] → "更改类型" → "对象"

转换中:
├── 📋 read (2 items)  
│   ├── [0] ❓ 选择数据类型       ← 类型选择器
│   │   └── [📄 Text] [📁 Object] [📋 Array]
│   └── [1] 📄 "products"

转换完成:
├── 📋 read (2 items)
│   ├── [0] 📁 Object (0 items)  ← 新的空对象
│   │   └── ➕ 添加属性
│   └── [1] 📄 "products"

用户继续添加属性:
├── 📋 read (2 items)
│   ├── [0] 📁 Permission Object (2 items)
│   │   ├── 🔑 resource: "users"
│   │   └── 🔑 level: "read"
│   └── [1] 📄 "products"
```

## 性能优化策略

### 渲染优化

#### 节点池技术
- **对象复用**: 复用DOM节点减少创建/销毁开销
- **增量更新**: 仅更新变化的节点，避免全量重渲染
- **批量操作**: 多个节点变更合并为单次DOM更新

#### 虚拟化技术
- **视窗渲染**: 仅渲染可见区域的节点
- **预加载**: 预渲染即将进入视窗的节点
- **内存管理**: 及时释放离开视窗的节点内存

### 数据处理优化

#### 懒加载策略
```
📁 large_array (10000+ items) 🔄    ← 显示加载状态
├── [0] 📄 "item1"                  ← 已加载的前50项
├── [1] 📄 "item2"  
├── ...
├── [49] 📄 "item50"
├── ⋯ 加载更多... (9950 items)      ← 懒加载占位符
└── ➕ 添加新元素
```

#### 增量搜索
- **分片搜索**: 大数据集分批次搜索，避免阻塞UI
- **结果缓存**: 缓存搜索结果，优化重复查询
- **智能索引**: 预建索引加速关键词搜索

## 响应式设计

### 自适应布局

#### 宽度适配
- **桌面端**: 充分利用水平空间，支持侧边栏展示
- **平板端**: 优化触摸操作，增大点击区域
- **手机端**: 垂直布局优化，支持手势导航

#### 交互适配
```
桌面端:                 平板端:                手机端:
右键菜单               长按菜单               全屏菜单
拖拽移动               触摸拖拽               长按+移动
键盘导航               虚拟键盘               手势导航
```

### 主题支持

#### 深色主题
```
深色模式下的树形显示:
📁 Root Object               
├── 🔑 name: "Alice"         ← 文字: #E5E7EB
│   (背景: #1F2937)           ← 深色背景
├── 📁 nested                ← 连接线: #4B5563
│   └── 🔑 value: 123        ← 图标保持彩色
```

#### 高对比度模式
- **强化边界**: 增强所有元素的边框和对比度
- **大字体**: 支持系统无障碍字体大小设置
- **键盘焦点**: 明显的键盘导航焦点指示

## 用户体验指标

### 核心体验目标

#### 学习曲线
- **新手用户**: 5分钟内掌握基本操作（展开、编辑、添加）
- **进阶用户**: 15分钟内掌握高级功能（搜索、拖拽、快捷键）
- **专家用户**: 键盘操作效率比鼠标快50%+

#### 操作效率
- **导航速度**: 在100级深度中定位到目标节点 < 10秒
- **编辑响应**: 所有编辑操作响应时间 < 200ms
- **大数据处理**: 1万个节点的JSON文件加载时间 < 3秒

### 错误预防机制

#### 操作确认
```
危险操作确认对话框:
┌─ 确认删除 ──────────────────┐
│ ⚠️ 即将删除包含 15 个子项的   │
│    "users" 对象             │
│                            │
│ 此操作无法撤销。            │
│                            │
│ [取消] [确认删除]           │
└────────────────────────────┘
```

#### 智能提示
- **类型冲突**: 阻止不兼容的操作，提供替代建议
- **格式验证**: 实时验证JSON格式，预防语法错误
- **性能警告**: 大数据操作前的性能影响提示

## 与表格样式的差异对比

| 特性对比 | 表格样式 | 树形样式 |
|---------|---------|---------|
| **数据展示** | 扁平化键值对展示 | 层次化树形展示 |
| **空间利用** | 水平空间优先 | 垂直空间优先 |
| **嵌套支持** | 通过视觉缩进 | 通过连接线和图标 |
| **导航方式** | 滚动查看 | 展开/折叠导航 |
| **搜索体验** | 线性搜索 | 路径导航搜索 |
| **大数据处理** | 表格虚拟化 | 树形虚拟化 |
| **用户认知** | 类似表格软件 | 类似文件管理器 |

### 使用场景建议

#### 适合树形样式:
- **配置文件编辑**: 层次结构清晰的配置数据
- **API响应查看**: 复杂嵌套的JSON API响应  
- **数据库架构**: 具有明确父子关系的数据
- **文档结构**: 章节层次分明的文档数据

#### 适合表格样式:
- **批量数据编辑**: 大量同级数据的批量修改
- **键值对管理**: 扁平化的配置项管理
- **快速浏览**: 需要快速扫描所有字段的场景
- **表单编辑**: 结构化表单数据的编辑

## 技术实现考虑

### 组件架构

#### 核心组件设计
```
TreeEditor/
├── TreeNode/              ← 单个节点组件
│   ├── TextNode           ← 文本节点
│   ├── ObjectNode         ← 对象节点  
│   └── ArrayNode          ← 数组节点
├── TreeView/              ← 树形视图容器
├── SearchPanel/           ← 搜索面板
├── ContextMenu/           ← 右键菜单
└── DragDropProvider/      ← 拖拽功能提供者
```

#### 状态管理
- **节点状态**: 展开/折叠状态的持久化存储
- **编辑状态**: 当前编辑节点和编辑模式跟踪
- **搜索状态**: 搜索关键词和结果高亮状态
- **历史状态**: 撤销/重做操作的历史记录

### 性能考虑

#### 关键性能指标
- **首屏渲染**: < 1秒 (1000个节点以内)
- **节点展开**: < 100ms (任意深度)
- **搜索响应**: < 200ms (10万个节点)
- **内存占用**: < 50MB (10万个节点)

#### 优化策略
- **按需渲染**: 仅渲染可见和即将可见的节点
- **事件委托**: 减少事件监听器数量
- **防抖优化**: 搜索和编辑操作的防抖处理
- **内存回收**: 及时清理不需要的节点引用

## 结论

Rich JSON Form Tree Style 通过树形结构的直观展示，为复杂 JSON 数据的编辑提供了全新的交互体验。相比表格样式，树形样式在处理深层嵌套数据时具有明显优势，能够帮助用户更好地理解和操作层次化数据结构。

通过精心设计的视觉层次、便捷的键盘导航、智能的搜索功能和流畅的拖拽操作，树形编辑器将成为处理复杂 JSON 数据的得力工具，大幅提升用户的编辑效率和体验满意度。