version: '3.9'

services:
  postgres:
    image: ankane/pgvector:latest
    container_name: e2e_postgres
    environment:
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"

  minio:
    image: minio/minio:latest
    container_name: e2e_minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"

  minio-setup:
    image: minio/mc:latest
    container_name: e2e_minio_setup
    depends_on:
      - minio
    entrypoint: ["/bin/sh","-c"]
    command: >
      "until mc alias set local http://minio:9000 minioadmin minioadmin; do
         echo 'Waiting for MinIO...'; sleep 2;
       done &&
       mc mb -p local/puppy-e2e || true &&
       mc anonymous set download local/puppy-e2e || true &&
       echo 'MinIO bucket puppy-e2e created successfully'"

  wiremock:
    image: wiremock/wiremock:3.6.0
    container_name: e2e_wiremock
    ports:
      - "8088:8080"
    volumes:
      - ./PuppyStorage/tests/e2e/wiremock:/home/wiremock

  ollama:
    image: ollama/ollama:latest
    container_name: e2e_ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    deploy:
      resources:
        limits:
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 5

  ollama-setup:
    image: curlimages/curl:latest
    container_name: e2e_ollama_setup
    depends_on:
      - ollama
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "echo 'Waiting for Ollama to be ready...' &&
       until curl -sf http://ollama:11434/api/tags; do
         echo 'Waiting for Ollama...'; sleep 2;
       done &&
       echo 'Pulling all-minilm embedding model...' &&
       curl -X POST http://ollama:11434/api/pull -d '{\"name\": \"all-minilm\"}' &&
       echo 'Model pulled successfully' &&
       curl -X POST http://ollama:11434/api/generate -d '{\"model\": \"all-minilm\", \"prompt\": \"test\", \"stream\": false}' &&
       echo 'Ollama is ready with all-minilm model'"

  # Local deployment: FS + Chroma + Local Auth + Ollama
  # Build the image once with storage-local, storage-remote will reuse it
  storage-local:
    build:
      context: ./PuppyStorage
      dockerfile: Dockerfile
      args:
        REQUIREMENTS_FILE: requirements-e2e.txt
    image: puppy-storage-e2e:latest
    container_name: e2e_storage_local
    environment:
      - DEPLOYMENT_TYPE=local
      - STORAGE_ROOT=/app/storage_data
      - STORAGE_SERVER_URL=http://localhost:8002
      - SUPABASE_URL=postgresql://postgres:postgres@postgres:5432/postgres
      - OLLAMA_ENDPOINT=http://ollama:11434
    ports:
      - "8002:8002"
    volumes:
      - storage-local-data:/app/storage_data
    depends_on:
      - postgres
      - ollama
    deploy:
      resources:
        limits:
          memory: 512M

  # Remote deployment: S3 + PGV + Remote Auth + OpenAI-compatible API (via Ollama)
  storage-remote:
    build:
      context: ./PuppyStorage
      dockerfile: Dockerfile
      args:
        REQUIREMENTS_FILE: requirements-e2e.txt
    image: puppy-storage-e2e:latest
    container_name: e2e_storage_remote
    environment:
      - DEPLOYMENT_TYPE=remote
      - USER_SYSTEM_URL=http://wiremock:8080
      - SERVICE_KEY=dummy
      - CLOUDFLARE_R2_ENDPOINT=http://minio:9000
      - CLOUDFLARE_R2_EXTERNAL_ENDPOINT=http://localhost:9000
      - CLOUDFLARE_R2_ACCESS_KEY_ID=minioadmin
      - CLOUDFLARE_R2_SECRET_ACCESS_KEY=minioadmin
      - CLOUDFLARE_R2_BUCKET=puppy-e2e
      - SUPABASE_URL=postgresql://postgres:postgres@postgres:5432/postgres
      - STORAGE_SERVER_URL=http://localhost:8003
      - OPENAI_API_BASE=http://ollama:11434/v1
      - OPENAI_API_KEY=dummy-key-for-e2e
    ports:
      - "8003:8002"
    depends_on:
      - postgres
      - minio
      - minio-setup
      - wiremock
      - ollama
      - storage-local
    deploy:
      resources:
        limits:
          memory: 512M

volumes:
  storage-local-data:
  ollama-data:


