# API 参考

PuppyOne REST API 完整文档。

---

## 基础信息

### Base URL

**生产环境**：
```
https://api.puppyone.ai/api/v1
```

**自托管**：
```
http://localhost:9090/api/v1
```

### 认证

所有请求需要在 Header 中携带 API Key：

```
Authorization: Bearer sk_live_xxx
```

### 响应格式

所有响应都是 JSON 格式：

**成功**：
```json
{
  "data": { ... },
  "error": null
}
```

**错误**：
```json
{
  "data": null,
  "error": {
    "code": "ERROR_CODE",
    "message": "Error description"
  }
}
```

---

## Table API

### 查询数据

```
POST /tables/{table_id}/query
```

**请求体**：
```json
{
  "path": "/products",
  "filter": {
    "price": { "$lt": 100 }
  },
  "limit": 10,
  "offset": 0
}
```

**参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | ✅ | JSON 路径 |
| `filter` | object | ❌ | 过滤条件 |
| `limit` | number | ❌ | 返回数量限制 |
| `offset` | number | ❌ | 分页偏移 |

**响应**：
```json
{
  "data": [
    { "id": "SKU-001", "name": "Widget", "price": 59.99 }
  ],
  "error": null
}
```

---

### 获取数据

```
GET /tables/{table_id}/data?path=/products
```

**参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | ❌ | JSON 路径，默认 `/` |

**响应**：
```json
{
  "data": {
    "products": [...]
  },
  "error": null
}
```

---

### 创建数据

```
POST /tables/{table_id}/data
```

**请求体**：
```json
{
  "path": "/products",
  "data": {
    "id": "SKU-003",
    "name": "New Widget",
    "price": 129.99
  }
}
```

**参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | ✅ | 目标路径（必须是数组） |
| `data` | any | ✅ | 要创建的数据 |

---

### 更新数据

```
PUT /tables/{table_id}/data
```

**请求体**：
```json
{
  "path": "/products/0/price",
  "value": 89.99
}
```

**参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | ✅ | 目标路径 |
| `value` | any | ✅ | 新值 |

---

### 删除数据

```
DELETE /tables/{table_id}/data?path=/products/0
```

**参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | ✅ | 要删除的路径 |

---

## 过滤器语法

### 比较操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `$eq` | 等于 | `{"status": {"$eq": "active"}}` |
| `$ne` | 不等于 | `{"status": {"$ne": "deleted"}}` |
| `$gt` | 大于 | `{"price": {"$gt": 100}}` |
| `$gte` | 大于等于 | `{"price": {"$gte": 100}}` |
| `$lt` | 小于 | `{"price": {"$lt": 100}}` |
| `$lte` | 小于等于 | `{"price": {"$lte": 100}}` |
| `$in` | 在数组中 | `{"category": {"$in": ["A", "B"]}}` |
| `$nin` | 不在数组中 | `{"category": {"$nin": ["C"]}}` |

### 逻辑操作符

```json
{
  "$and": [
    {"price": {"$gte": 50}},
    {"price": {"$lte": 100}}
  ]
}
```

```json
{
  "$or": [
    {"category": "电子"},
    {"category": "配件"}
  ]
}
```

---

## Project API

### 列出项目

```
GET /projects
```

### 获取项目

```
GET /projects/{project_id}
```

### 创建项目

```
POST /projects
```

**请求体**：
```json
{
  "name": "产品知识库",
  "description": "存储产品相关数据"
}
```

---

## 错误码

| 错误码 | HTTP 状态 | 说明 |
|--------|----------|------|
| `UNAUTHORIZED` | 401 | API Key 无效或缺失 |
| `FORBIDDEN` | 403 | 权限不足 |
| `NOT_FOUND` | 404 | 资源不存在 |
| `VALIDATION_ERROR` | 422 | 请求参数错误 |
| `RATE_LIMITED` | 429 | 请求过于频繁 |
| `INTERNAL_ERROR` | 500 | 服务器内部错误 |

---

## 速率限制

| 计划 | 限制 |
|------|------|
| Free | 100 请求/分钟 |
| Pro | 1000 请求/分钟 |
| Team | 无限制 |

响应 Header：
- `X-RateLimit-Limit`: 总配额
- `X-RateLimit-Remaining`: 剩余配额
- `X-RateLimit-Reset`: 重置时间（Unix 时间戳）

---

## 代码示例

### cURL

```bash
# 查询数据
curl -X POST "https://api.puppyone.ai/api/v1/tables/tbl_xxx/query" \
  -H "Authorization: Bearer sk_live_xxx" \
  -H "Content-Type: application/json" \
  -d '{"path": "/products", "filter": {"price": {"$lt": 100}}}'
```

### Python

```python
import requests

def query_products(api_key, table_id, max_price):
    response = requests.post(
        f"https://api.puppyone.ai/api/v1/tables/{table_id}/query",
        headers={"Authorization": f"Bearer {api_key}"},
        json={
            "path": "/products",
            "filter": {"price": {"$lt": max_price}}
        }
    )
    return response.json()["data"]
```

### JavaScript

```javascript
async function queryProducts(apiKey, tableId, maxPrice) {
  const response = await fetch(
    `https://api.puppyone.ai/api/v1/tables/${tableId}/query`,
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        path: "/products",
        filter: { price: { $lt: maxPrice } }
      })
    }
  );
  const data = await response.json();
  return data.data;
}
```




