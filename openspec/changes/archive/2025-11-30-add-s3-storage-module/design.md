# S3 存储模块设计

## Context

ContextBase 需要一个统一的对象存储管理层来支持即将到来的 ETL 功能。用户需要存储原始的多模态数据(音频、视频、图片、文档等)以及经过清洗和结构化后的 JSON 数据。该模块设计为独立服务,当前不与其他服务模块耦合,为将来集成提供灵活性。

**技术背景**:
- 本地开发: LocalStack 模拟 S3 环境
- 生产环境: AWS S3 或兼容的对象存储服务
- Python SDK: aioboto3 (异步版本,与 FastAPI 异步特性匹配)

**约束**:
- 必须遵循项目的模块化服务目录结构
- 必须使用 FastAPI 和 Pydantic
- 配置应通过环境变量管理
- 错误处理应统一和规范
- 存储路径结构: `/{raw/processed}/{project_id}/{原始文件名或table_id.后缀}`

## Goals / Non-Goals

**Goals:**
1. 提供完整的 S3 文件管理 API (上传、下载、删除、列表、元信息)
2. 支持批量操作以提高效率
3. 支持大文件的流式上传和下载
4. **支持大文件分片上传(multipart upload)**
5. 支持预签名 URL,允许客户端直接与 S3 交互
6. 统一的错误处理和响应格式
7. 配置灵活,支持本地开发和生产环境切换
8. 可配置的文件大小限制

**Non-Goals:**
1. 不实现文件版本控制(依赖 S3 自身版本功能)
2. 不实现复杂的访问控制列表(ACL)管理
3. 不实现文件内容的转换或处理(属于 ETL 模块职责)
4. 不直接集成数据库(文件元信息完全依赖 S3)
5. 当前不与 `auth`、`user_context` 等模块集成
6. 不实现文件内容类型自动检测(依赖客户端提供)

## Decisions

### Decision 1: 使用 aioboto3 作为 S3 客户端

**选择:** 使用 aioboto3 异步 SDK

**理由:**
- 与 FastAPI 的异步特性完美匹配,不会阻塞事件循环
- 基于 boto3,保持 API 一致性和稳定性
- 支持所有 S3 操作,功能完整
- 与 LocalStack 完全兼容
- 在高并发场景下性能更优

**替代方案:**
- `boto3` (同步版本): 会阻塞 FastAPI 事件循环,影响并发性能,不推荐
- 手动调用 S3 REST API: 增加维护成本,不推荐

### Decision 2: 单服务单 S3 Bucket 策略与标准化存储路径

**选择:** 所有文件存储在单个 S3 bucket 中,使用标准化的 key 结构: `/{raw/processed}/{project_id}/{filename}`

**理由:**
- 简化配置和权限管理
- 降低成本(避免多 bucket 管理开销)
- 更容易实现跨数据类型的操作
- 标准化路径便于后续 ETL 处理和数据管理
- `raw/` 存储原始数据,`processed/` 存储转换后的 JSON 数据
- `project_id` 提供项目级隔离

**路径示例:**
- `raw/proj123/document.pdf` - 原始文档
- `processed/proj123/table_users.json` - 处理后的 JSON 数据

**替代方案:**
- 多 bucket 策略: 增加配置复杂度,当前需求不需要
- 扁平化路径: 难以管理和组织,不利于后续扩展

### Decision 3: 流式响应用于文件下载

**选择:** 使用 FastAPI 的 `StreamingResponse` 进行文件下载

**理由:**
- 内存高效,适合大文件
- 更快的首字节响应时间
- 避免服务器内存溢出

### Decision 4: 预签名 URL 过期时间可配置

**选择:** 预签名 URL 的过期时间由客户端请求时指定,有默认值(3600秒)和最大值限制(86400秒)

**理由:**
- 灵活性:不同场景需要不同的有效期
- 安全性:设置最大值限制,避免长期有效的 URL 泄露

### Decision 5: 错误处理统一使用自定义异常

**选择:** 定义 `S3OperationError`、`S3FileNotFoundError` 等自定义异常,由全局异常处理器捕获并转换为标准 HTTP 响应

**理由:**
- 统一的错误响应格式
- 便于调试和日志记录
- 与项目现有的异常处理机制一致

### Decision 6: 批量操作采用部分成功模式

**选择:** 批量上传/删除操作返回每个文件的操作结果,即使部分失败也返回成功的部分

**理由:**
- 提高用户体验,避免"全有或全无"
- 便于客户端重试失败项
- 符合 AWS SDK 的批量操作语义

### Decision 7: 支持大文件分片上传

**选择:** 实现 S3 multipart upload 功能,支持大文件分片上传

**理由:**
- 提高大文件上传的可靠性(支持断点续传)
- 突破单次上传的大小限制
- 并行上传多个分片,提升上传速度
- 网络中断时可以只重传失败的分片

**实现策略:**
- 文件大小超过阈值(如 100MB)时自动使用分片上传
- 分片大小可配置(默认 5MB,最小 5MB)
- 支持上传进度追踪
- 支持取消上传和清理未完成的分片

### Decision 8: 环境配置驱动的部署模式

**选择:** 通过配置文件和环境变量支持 LocalStack 和 AWS S3 的无缝切换

**理由:**
- 本地开发使用 LocalStack,无需真实 AWS 凭证
- 生产环境使用真实 S3,配置统一管理
- 使用 boto3 标准 API,避免特定实现依赖
- 便于 CI/CD 和多环境部署

**配置项:**
- `S3_ENDPOINT_URL`: LocalStack 时设置,生产环境留空
- `S3_BUCKET_NAME`: 存储桶名称
- `S3_REGION`: AWS 区域
- 凭证通过环境变量或 IAM role 提供

### Decision 9: 可配置的文件大小限制

**选择:** 通过配置文件设置文件大小限制

**理由:**
- 防止滥用和资源耗尽
- 不同环境可设置不同限制
- 超过限制时提示使用预签名 URL 或分片上传

**配置项:**
- `S3_MAX_FILE_SIZE`: 单文件上传最大大小(字节),默认 100MB
- `S3_MULTIPART_THRESHOLD`: 启用分片上传的阈值,默认 100MB
- `S3_MULTIPART_CHUNKSIZE`: 分片大小,默认 5MB

## Risks / Trade-offs

### Risk 1: aioboto3 学习曲线和调试复杂度

**缓解措施:**
- aioboto3 API 与 boto3 基本一致,只需添加 `async/await`
- 参考官方文档和社区最佳实践
- 在 LocalStack 环境中充分测试异步行为
- 使用合适的日志记录追踪异步调用

### Risk 2: 分片上传的状态管理

**缓解措施:**
- 本版本实现完整的分片上传功能
- 记录上传 ID 和已完成分片,支持断点续传
- 提供清理未完成上传的 API 或定时任务
- 设置分片过期时间,避免存储碎片堆积

### Risk 3: LocalStack 与 AWS S3 行为差异

**缓解措施:**
- 在 LocalStack 和真实 S3 环境中都进行测试
- 使用 aioboto3/boto3 的标准 API,避免依赖特定实现细节
- 通过配置文件控制环境切换,确保一致的代码路径
- 文档中明确标注已知差异(如 LocalStack 的分片上传行为)

### Trade-off: 不实现文件内容类型检测

**决策:** 依赖客户端提供正确的 `content_type`,服务端不进行内容检测

**理由:**
- 内容检测需要读取文件内容,增加延迟
- 客户端通常知道文件类型
- 简化实现,减少依赖(避免引入 magic 等库)
- 本版本不支持此功能

## Migration Plan

**不适用** - 这是全新模块,不涉及数据迁移

**部署步骤:**
1. 确保环境变量配置正确(S3 endpoint、bucket、凭证)
2. 部署代码
3. 验证 LocalStack 或 S3 连接
4. 运行健康检查测试

**回滚方案:**
- 如果模块有问题,可以直接禁用路由注册
- 由于是独立模块,不会影响现有功能

## Resolved Questions

以下问题已在设计阶段确认:

1. **文件大小限制** ✅
   - **决策:** 通过 config 支持配置最大文件大小限制
   - `S3_MAX_FILE_SIZE`: 默认 100MB
   - 超过限制时返回 413 错误,建议使用预签名 URL 或分片上传

2. **存储路径结构** ✅
   - **决策:** 采用标准化路径 `/{raw/processed}/{project_id}/{filename}`
   - `raw/`: 存储原始多模态数据
   - `processed/`: 存储 ETL 转换后的 JSON 数据
   - `project_id`: 项目隔离
   - `filename`: 原始文件名或 `table_id.json`

3. **文件权限管理** ✅
   - **决策:** 本版本不考虑权限问题
   - 所有文件私有,仅通过 API 或预签名 URL 访问
   - 未来可与 `auth` 模块集成,实现用户级权限

4. **日志和监控策略** ✅
   - **决策:** 只需要本地日志记录
   - 记录所有 S3 操作(key、操作类型、时间戳、结果)
   - 使用项目标准的 logger
   - 暂不集成 CloudWatch 或外部监控系统

## Open Questions

暂无未决问题。

